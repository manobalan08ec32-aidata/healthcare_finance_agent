# Approach 3: Properly escape newlines, quotes, and control characters for JSON
try:
    # First escape backslashes, then quotes, then newlines/tabs/returns
    intermediate_clean = intermediate.replace('\\', '\\\\')  # Escape backslashes first
    intermediate_clean = intermediate_clean.replace('"', '\\"')  # Escape double quotes
    intermediate_clean = intermediate_clean.replace('\n', '\\n').replace('\r', '\\r').replace('\t', '\\t')
    # Also handle any other control characters
    intermediate_clean = re.sub(r'[\x00-\x08\x0b-\x1f]', lambda m: f'\\u{ord(m.group()):04x}', intermediate_clean)
    cleaned_json = json.loads(f'"{intermediate_clean}"')  # Wrap in quotes to parse as JSON string first
    
    # Now parse the result as JSON object
    if isinstance(cleaned_json, str):
        cleaned_json = json.loads(cleaned_json)
    print("    ‚úÖ Second parse succeeded after full escape")
except json.JSONDecodeError as e3:
    print(f"    ‚ùå All parsing attempts failed: {e3}")
    error_pos = getattr(e3, 'pos', 0)
    print(f"    üìù Problematic area around char {error_pos}: '{intermediate[max(0, error_pos-30):error_pos+30]}'")
    # Create error result with partial data
    cleaned_json = {
        "error": f"JSON parse error: {str(e3)}",
        "title": user_question,
        "narrative": "Error parsing stored data - please contact support",
        "sql_query": intermediate[:500] if len(intermediate) > 500 else intermediate
    }
except Exception as e3:
    print(f"    ‚ùå Unexpected error in Approach 3: {e3}")
    cleaned_json = {
        "error": f"Parse error: {str(e3)}",
        "title": user_question,
        "narrative": "Error parsing stored data - please contact support"
    }
