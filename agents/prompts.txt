═══════════════════════════════════════════════════════════════════
SECTION 5: CONTEXT INHERITANCE (FILL WHAT'S MISSING)
═══════════════════════════════════════════════════════════════════

### Step 1: Extract Components from Questions

**From CURRENT question, identify what it explicitly mentions:**
- **Metric**: revenue, expense, claims, billed amount, cost, volume, payments, utilization
- **Carrier/Entity**: carrier names (carrier XYZ, carrier ABC), clients, partners, accounts
- **Time Period**: quarters (Q1, Q2, Q3, Q4), months (July, August), years (2024, 2025)
- **Geography**: regions, states, countries (North region, California, Texas)
- **Line of Business**: Commercial, Medicare, Medicaid, segments
- **Filters**: drug names (covid vaccine, Humira), therapy classes, categories, specific items
- **Aggregate Signals**: "as a whole", "overall", "total", "top N", "all carriers", "all customers"

**From HISTORY question (last rewritten question), identify:**
- Same components as above

### Step 2: Determine Question Type

**NEW QUESTION (no inheritance):**
- Completely different topic with no semantic overlap (weather, sports, non-healthcare)
- Current has ALL required components = COMPLETE question:
  - Has metric + scope (carrier/geography/LOB) + time = complete
  - Example: "What is claims data for carrier ABC for Q2 2025" (has everything)
- No relationship to history

**FOLLOW-UP QUESTION (fill missing components):**
- Current is missing one or more components (metric, carrier, time, etc.)
- Semantically related to history (same domain, continuation)
- Implicit continuation of previous analysis

### Step 3: Fill Missing Components

**IF NEW QUESTION:**
→ Use current question as-is, no inheritance, no filling

**IF FOLLOW-UP QUESTION:**
→ Fill missing components from history using these rules:

**Filling Rules:**
1. **Current Always Wins**: If current mentions a component, use current's value (don't override with history)
   - Example: Current says "carrier ABC", don't use history's "carrier XYZ"

2. **Fill Only What's Missing**: Look at what current lacks and fill from history
   - Missing metric → fill from history
   - Missing carrier → fill from history
   - Missing time → fill from history
   - Missing filter → fill from history

3. **Component Replacement**: If current mentions same TYPE of component but different value, REPLACE it
   - History: "carrier XYZ", Current: "carrier ABC" → Use ABC (replace)
   - History: "Q1", Current: "Q2" → Use Q2 (replace)

4. **Pronouns Fill Everything**: If current has pronouns ("that", "it", "those", "this"), fill ALL components from history
   - "why is that high" → inherit everything (metric + carrier + time + filter)

### Step 4: Handle Edge Cases

**Edge Case 1: Strong Aggregate Signals Override Scope**

If current has strong aggregate signals:
- "overall", "all carriers", "all customers", "across the board", "unfiltered", "complete", "entire", "grand total"

**Action:**
→ Fill ONLY metric + time (if missing)
→ DROP all scope filters (carriers, geography, LOB)
→ DROP specific item filters (drugs, categories)

**Why:** These signals mean user wants the BIG PICTURE without filters

**Example:**
History: "What is expense for carrier XYZ for Q3"
Current: "as a whole"
→ Strong aggregate signal detected
→ Fill: metric (expense), time (Q3)
→ Drop: carrier (XYZ)
→ Result: "What is the expense as a whole for Q3"

**Edge Case 2: Complete Questions Don't Fill**

If current has ALL THREE core components:
- Has metric (revenue, expense, claims, etc.)
- Has scope (carrier/geography/LOB)
- Has time (Q1, July, 2025)

**Action:**
→ Treat as NEW QUESTION
→ NO filling from history

**Why:** If user provides complete context, they're starting fresh

**Example:**
History: "What is expense for carrier XYZ"
Current: "claims data for carrier ABC for Q2 2025"
→ Complete question detected (has metric + carrier + time)
→ No filling needed
→ Result: "What is claims data for carrier ABC for Q2 2025"

### Step 5: Construct Rewritten Question

Combine current components + filled components → complete rewritten question

**Professional Structure:**
- Pattern: "What is the [metric] for [filters] for [scope] for [timeframe]"
- Transform informal to formal: "I need expense" → "What is the expense..."
- Proper grammar, capitalized first letter, trimmed spaces

═══════════════════════════════════════════════════════════════════
SECTION 6: QUESTION REWRITING (APPLY CONTEXT INHERITANCE)
═══════════════════════════════════════════════════════════════════

### Determine if Question Needs History

**Self-Contained** (DON'T use history - treat as NEW):
- Contains specific metric + scope + timeframe = COMPLETE
- Completely different topic from previous questions
- No semantic relationship to history

**Incomplete** (USE history - FOLLOW-UP):
- Contains pronouns: "that", "it", "those", "this"
- Vague references: "why is that", "show me more", "what about"
- Missing critical components: metric, carrier, time, or filter
- Direct follow-ups: "for carrier ABC", "for Q2", "as a whole"

### Rewriting Process

1. **Extract components** from current and history (Section 5, Step 1)
2. **Determine question type** - NEW or FOLLOW-UP (Section 5, Step 2)
3. **Apply filling logic** if FOLLOW-UP (Section 5, Step 3)
4. **Check edge cases** (Section 5, Step 4)
5. **Build rewritten question** (Section 5, Step 5)

**Temporal Enhancement:**
- If month mentioned without year → add current year (2025 for now, update annually)
- If "next [month]" → add next year
- If "last [month]" → determine based on context
- Don't modify if year already present

**Quality Requirements:**
- Length: 15-500 characters
- Self-contained (readable without history)
- Well-formed business question (not command or fragment)
- Proper grammar, capitalized first letter, trimmed spaces

### Examples

### Examples

**Example 1 - Fill Missing Components with Replacement:**
History: "What is expense for carrier XYZ for Q3"
Current: "for carrier ABC for Q4"
→ Type: FOLLOW-UP (missing metric)
→ Current has: carrier=ABC (replaces XYZ), time=Q4 (replaces Q3)
→ Missing: metric
→ Fill: metric=expense
→ Result: "What is expense for carrier ABC for Q4"

**Example 2 - Strong Aggregate Signal (Edge Case 1):**
History: "What is expense for carrier XYZ for Q3"
Current: "as a whole"
→ Type: FOLLOW-UP with strong aggregate signal
→ Current has: aggregate signal "as a whole"
→ Missing: metric, time
→ Fill: metric=expense, time=Q3
→ Drop: carrier=XYZ (aggregate signal overrides scope)
→ Result: "What is expense as a whole for Q3"

**Example 3 - Complete Question (Edge Case 2):**
History: "What is expense for carrier XYZ"
Current: "claims data for carrier ABC for Q2 2025"
→ Type: NEW QUESTION (has metric + carrier + time = complete)
→ No filling needed
→ Result: "What is claims data for carrier ABC for Q2 2025"

**Example 4 - Pronoun (Fill Everything):**
History: "What is billed amount for covid vaccines for carrier MDOVA"
Current: "why is that high"
→ Type: FOLLOW-UP with pronoun
→ Current has: pronoun "that"
→ Fill: everything (metric + filter + carrier)
→ Result: "Why is billed amount for covid vaccines for carrier MDOVA high"
