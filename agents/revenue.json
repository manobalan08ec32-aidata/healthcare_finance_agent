{
  "revenue_investigation_config": {
    "version": "2.0",
    "investigation_type": "revenue_variance_drill_through",
    "description": "Simplified drill-through configuration with LLM-driven intelligence",
    
    "shared_table_metadata": {
      "ledger_overview": {
        "table_name": "prd_optumrx_orxfdmprdsa.rag.actuals_vs_forecast_analysis",
        "description": "High-level monthly or quarterly performance by LOB and product category",
        "columns": [
          {
            "name": "ledger",
            "description": "Ledger type for the record",
            "distinct_values": ["GAAP", "BUDGET", "8+4", "2+10", "5+7"]
          },
          {
            "name": "metric_type",
            "description": "Type of metric captured in amount_or_count",
            "sample_values": ["Revenues", "Adjusted Scripts", "Unadjusted Scripts", "COGS Post Reclass", "SG&A Post Reclass", "IOI", "Total Membership"]
          },
          {
            "name": "line_of_business",
            "description": "Business segment for the revenue record",
            "sample_values": ["C&S", "E&I", "M&R", "Rev Reclass", "Optum", "External"]
          },
          {
            "name": "product_category",
            "description": "High-level product or service grouping",
            "sample_values": ["PBM", "Specialty", "HDP"]
          },
          {
            "name": "transaction_date",
            "description": "Transaction date (yyyy-MM-dd)"
          },
          {
            "name": "quarter",
            "description": "Quarter (Q1â€“Q4) derived from transaction_date"
          },
          {
            "name": "amount_or_count",
            "description": "Value for the record (amount or count depending on metric_type)"
          }
        ]
      },
      "claims_drivers": {
        "table_name": "prd_optumrx_orxfdmprdsa.rag.claim_transaction_for_pharmacy_pbm",
        "description": "Operational revenue drivers from pharmacy claims",
        "columns": [
          {
            "name": "line_of_business",
            "description": "Business segment for the claim"
          },
          {
            "name": "client_id",
            "description": "Client identifier"
          },
          {
            "name": "carrier_id",
            "description": "Insurance carrier identifier"
          },
          {
            "name": "submit_date",
            "description": "Claim submission date (yyyy-MM-dd)"
          },
          {
            "name": "revenue_amt",
            "description": "Revenue amount for the claim"
          },
          {
            "name": "unadjusted_script_count",
            "description": "Actual script count for each claim"
          },
          {
            "name": "member_id",
            "description": "Individual member identifier for utilization analysis"
          }
        ]
      }
    },

    "investigation_hierarchy": {
      "lob": ["client", "carrier", "membership"],
      "client": ["carrier"],
      "carrier": []
    },

    "analysis_templates": {
      "lob": {
        "table_reference": "ledger_overview",
        "dimensions": ["line_of_business"],
        "metrics": ["amount_or_count"],
        "filters": {
          "metric_type": "Revenues",
          "ledger": "GAAP"
        },
        "date_column": "transaction_date",
        "llm_instructions": "CONTEXTUAL SCOPING LOGIC: Detect the analysis level from user question. If user asks general LOB question ('Why did LOB revenue drop?'), analyze all LOBs globally. If user specifies a particular LOB ('Why did C&S revenue drop?'), focus only on that LOB. This LOB context MUST cascade to all child analyses (membership, client, carrier) - they should be scoped to the same LOB filter detected here. ANALYSIS TYPE: Pure variance analysis - calculate variance amount and variance percentage between comparison periods. Focus on Revenue metrics only. No NEW/DROP/EXISTING entity analysis needed. Calculate revenue per script by dividing revenue by script count. VARIANCE THRESHOLDS: Flag LOBs with significant variance (>$1M absolute or >5% relative). Always show variance direction (positive/negative) and magnitude. CHILD TRIGGER LOGIC: If significant variance detected at LOB level, trigger child analyses (membership, client, carrier) with the same LOB scope inherited. The goal is to identify which LOB segments show significant revenue variance to guide subsequent drill-through analyses."
      },

      "membership": {
        "table_reference": "ledger_overview", 
        "dimensions": ["line_of_business"],
        "metrics": ["amount_or_count"],
        "filters": {
          "metric_type": "Total Membership",
          "ledger": "GAAP"
        },
        "date_column": "transaction_date",
        "llm_instructions": "CONTEXTUAL SCOPING LOGIC: Inherit LOB scope from parent analysis. If parent LOB analysis was scoped to specific LOB (e.g., 'C&S'), then membership analysis should ONLY analyze membership for that LOB. If parent was global LOB analysis, then analyze membership across all LOBs showing revenue variance. ANALYSIS TYPE: Membership variance analysis to identify membership changes that could explain revenue variance patterns. VARIANCE THRESHOLDS: Flag membership changes of 5% or more OR absolute change of 1000+ members. Focus on LOBs that showed significant revenue variance in parent analysis. CORRELATION LOGIC: Look for correlation patterns between membership changes and revenue variance direction. Growing membership with declining revenue suggests per-member revenue issues. Declining membership with stable revenue suggests member retention of high-value segments. EXPECTED INSIGHTS: Identify whether revenue variance is driven by membership volume changes or per-member utilization/pricing changes. This analysis helps distinguish between volume-driven vs. intensity-driven revenue variance."
      },

      "client": {
        "table_reference": "claims_drivers",
        "dimensions": ["client_id", "line_of_business"],
        "metrics": ["revenue_amt", "unadjusted_script_count"],
        "filters": {},
        "date_column": "submit_date",
        "llm_instructions": "CONTEXTUAL SCOPING LOGIC: Inherit LOB scope from parent analysis. If parent LOB analysis was scoped to specific LOB, filter client analysis to that LOB only. If user question is purely client-focused ('Why did Client ABC revenue drop?'), then no LOB scope inheritance - analyze that specific client only. ANALYSIS TYPE: Client portfolio change analysis - identify NEW, DROP, and EXISTING clients and their revenue impact. ENTITY STATUS DEFINITIONS: NEW clients = zero revenue in prior period AND current revenue >$500K. DROP clients = prior revenue >$500K AND zero current revenue. EXISTING clients = revenue presence in both periods with variance analysis. SELECTION STRATEGY: Don't analyze all clients - select strategically: Top 20 revenue gainers, Bottom 20 revenue losers, OR clients contributing to 70% of total variance (whichever provides better insight). VARIANCE THRESHOLDS: Include clients with >$1M revenue impact for large clients (>$10M annual), >$500K impact for medium clients ($1M-$10M annual). EXPECTED INSIGHTS: Identify specific client additions, losses, or behavioral changes driving revenue variance. Calculate client-level revenue per script to identify utilization pattern changes. Focus on actionable client relationship insights."
      },

      "carrier": {
        "table_reference": "claims_drivers",
        "dimensions": ["carrier_id", "line_of_business"],
        "metrics": ["revenue_amt", "unadjusted_script_count"],
        "filters": {},
        "date_column": "submit_date", 
        "llm_instructions": "CONTEXTUAL SCOPING LOGIC: Inherit scope from parent analysis. If parent was LOB-scoped, analyze carriers within that LOB. If parent was client-scoped, analyze carriers for that specific client. If user question is purely carrier-focused ('Why did Carrier XYZ revenue drop?'), analyze that carrier only with no additional scoping. PRODUCT CATEGORY SCOPING: Inherit product category filter from parent analysis or detect from user question if standalone carrier analysis. DATE RANGE INTELLIGENCE: Apply same date range logic as parent analysis or detect from user question for period comparison and entity status determination. ANALYSIS TYPE: Carrier utilization change analysis - identify NEW, DROP, and EXISTING carriers and their operational impact on revenue. ENTITY STATUS DEFINITIONS: NEW carriers = zero revenue in prior period AND current revenue >$250K. DROP carriers = prior revenue >$250K AND zero current revenue. EXISTING carriers = presence in both periods with utilization variance analysis. SELECTION STRATEGY: Focus on significant carriers only - Top 20 revenue gainers, Bottom 20 losers, OR carriers contributing to 70% of variance. Apply carrier size tiers: Major carriers (>$5M annual) include if >$500K variance, Significant carriers ($1M-$5M) include if >$250K variance. UTILIZATION ANALYSIS: Calculate revenue per script and scripts per member to identify operational pattern changes. Look for shifts in carrier formulary preferences, prior authorization patterns, or network participation changes. EXPECTED INSIGHTS: Identify carrier behavior changes, network dynamics, or operational factors contributing to revenue variance that weren't explained by client portfolio changes."
      }
    },

    "global_llm_instructions": {
      "investigation_orchestration": "You are conducting strategic revenue variance investigation using a dynamic drill-through approach. The investigation adapts based on user question scope: LOB-level questions trigger comprehensive analysis (LOB + child analyses), Client-level questions focus on client + carriers, Carrier-level questions analyze carriers only. Always maintain contextual scoping - if user specifies particular entities, inherit that scope to child analyses.",
      
      "variance_direction_handling": "Detect variance direction from user question language: 'drop/decline/fall' = focus on bottom performers and revenue losers, 'spike/increase/growth' = focus on top performers and revenue gainers, 'variance/change/vs' = analyze both top and bottom performers. Always identify NEW additions, DROP departures, and EXISTING entity changes when analyzing client/carrier levels.",
      
      "sql_generation_priorities": "Generate clean, efficient Databricks SQL with proper date filtering, variance calculations (amount and percentage), and entity status identification. Use window functions for period comparisons. Apply strategic filtering to focus on significant variance contributors. Include proper NULL handling and data quality filters. Calculate derived metrics like revenue per script, scripts per member for operational insights.",
      
      "business_context": "This is pharmacy benefits management (PBM) revenue analysis. Consider business seasonality: Q1 plan year changes, Q4 deductible exhaustion, mid-year formulary updates. Revenue variance can be driven by membership volume changes, per-member utilization changes, client portfolio shifts, or carrier network dynamics. Focus on actionable insights that explain operational drivers of revenue variance.",
      
      "variance_explanation_target": "Aim to identify factors explaining at least 70% of total revenue variance across all analysis levels. Track variance attribution: Primary drivers (>30% of variance), Secondary drivers (10-30%), Minor factors (<10%). If strategic analysis explains <70% of variance, recommend tactical operational investigation for remaining unexplained variance."
    }
  }
}
