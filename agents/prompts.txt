<queries>
<query>
    <query_id>pbm_revenue_overview_july_2025</query_id>
    <table>ledger</table>
    <purpose>Overall PBM revenue performance for July 2025</purpose>
    <sql>
    SELECT
        line_of_business,
        product_category,
        DATE_TRUNC('month', transaction_date) AS month,
        SUM(amount_or_count) AS total_revenue,
        ROUND(SUM(amount_or_count) / (SELECT SUM(amount_or_count)
                                      FROM prd_optumrx_orxfdmprdsa.rag.actuals_vs_forecast_analysis
                                      WHERE ledger = 'GAAP'
                                        AND metric_type = 'Revenues'
                                        AND product_category = 'PBM'
                                        AND DATE_TRUNC('month', transaction_date) = '2025-07-01') * 100, 2) AS revenue_share_pct
    FROM prd_optumrx_orxfdmprdsa.rag.actuals_vs_forecast_analysis
    WHERE ledger = 'GAAP'
      AND metric_type = 'Revenues'
      AND product_category = 'PBM'
      AND DATE_TRUNC('month', transaction_date) = '2025-07-01'
    GROUP BY line_of_business, product_category, DATE_TRUNC('month', transaction_date)
    ORDER BY total_revenue DESC
    </sql>
    <narrative>Provides overall PBM revenue breakdown by line of business for July 2025, showing each segment's contribution to total PBM revenue.</narrative>
</query>

<query>
    <query_id>top_pbm_product_subcategories_july_2025</query_id>
    <table>ledger</table>
    <purpose>Top 10 PBM product subcategories driving revenue</purpose>
    <sql>
    SELECT
        product_sub_category_lvl_1,
        product_sub_category_lvl_2,
        SUM(amount_or_count) AS total_revenue,
        ROUND(SUM(amount_or_count) / (SELECT SUM(amount_or_count)
                                      FROM prd_optumrx_orxfdmprdsa.rag.actuals_vs_forecast_analysis
                                      WHERE ledger = 'GAAP'
                                        AND metric_type = 'Revenues'
                                        AND product_category = 'PBM'
                                        AND DATE_TRUNC('month', transaction_date) = '2025-07-01') * 100, 2) AS revenue_contribution_pct
    FROM prd_optumrx_orxfdmprdsa.rag.actuals_vs_forecast_analysis
    WHERE ledger = 'GAAP'
      AND metric_type = 'Revenues'
      AND product_category = 'PBM'
      AND DATE_TRUNC('month', transaction_date) = '2025-07-01'
      AND product_sub_category_lvl_1 IS NOT NULL
    GROUP BY product_sub_category_lvl_1, product_sub_category_lvl_2
    ORDER BY total_revenue DESC
    LIMIT 10
    </sql>
    <narrative>Identifies the top 10 product subcategories within PBM that generated the highest revenue in July 2025, with their percentage contribution to total PBM revenue.</narrative>
</query>

<query>
    <query_id>top_therapy_classes_driving_pbm_revenue_july_2025</query_id>
    <table>claims</table>
    <purpose>Top 10 therapy classes and drugs driving PBM revenue</purpose>
    <sql>
    SELECT
        therapy_class_name,
        drug_name,
        SUM(revenue_amt) AS total_revenue,
        SUM(unadjusted_script_count) AS total_scripts,
        ROUND(SUM(revenue_amt) / NULLIF(SUM(unadjusted_script_count), 0), 2) AS revenue_per_script,
        ROUND(SUM(revenue_amt) / (SELECT SUM(revenue_amt)
                                  FROM prd_optumrx_orxfdmprdsa.rag.claim_transaction_for_pharmacy_pbm
                                  WHERE product_category = 'PBM'
                                    AND DATE_TRUNC('month', submit_date) = '2025-07-01') * 100, 2) AS revenue_share_pct
    FROM prd_optumrx_orxfdmprdsa.rag.claim_transaction_for_pharmacy_pbm
    WHERE product_category = 'PBM'
      AND DATE_TRUNC('month', submit_date) = '2025-07-01'
      AND claim_status_code = 'PAID'
    GROUP BY therapy_class_name, drug_name
    ORDER BY total_revenue DESC
    LIMIT 10
    </sql>
    <narrative>Shows the top 10 therapy class and drug combinations that drove the most PBM revenue in July 2025, including revenue per script metrics to understand pricing dynamics.</narrative>       
</query>

<query>
    <query_id>brand_vs_generic_revenue_mix_july_2025</query_id>
    <table>claims</table>
    <purpose>Brand vs Generic revenue contribution analysis</purpose>
    <sql>
    SELECT
        brand_vs_generic_ind,
        drug_name,
        SUM(revenue_amt) AS total_revenue,
        SUM(unadjusted_script_count) AS total_scripts,
        ROUND(SUM(revenue_amt) / NULLIF(SUM(unadjusted_script_count), 0), 2) AS revenue_per_script,
        ROUND(SUM(revenue_amt) / (SELECT SUM(revenue_amt)
                                  FROM prd_optumrx_orxfdmprdsa.rag.claim_transaction_for_pharmacy_pbm
                                  WHERE product_category = 'PBM'
                                    AND DATE_TRUNC('month', submit_date) = '2025-07-01') * 100, 2) AS revenue_contribution_pct
    FROM prd_optumrx_orxfdmprdsa.rag.claim_transaction_for_pharmacy_pbm
    WHERE product_category = 'PBM'
      AND DATE_TRUNC('month', submit_date) = '2025-07-01'
      AND claim_status_code = 'PAID'
    GROUP BY brand_vs_generic_ind, drug_name
    ORDER BY total_revenue DESC
    LIMIT 10
    </sql>
    <narrative>Analyzes the revenue mix between brand and generic drugs for PBM in July 2025, showing how pricing strategies (revenue per script) differ between brand and generic medications.</narrative>
</query>

<query>
    <query_id>top_clients_driving_pbm_revenue_july_2025</query_id>
    <table>claims</table>
    <purpose>Top 10 clients contributing to PBM revenue</purpose>
    <sql>
    SELECT
        client_id,
        client_name,
        SUM(revenue_amt) AS total_revenue,
        SUM(unadjusted_script_count) AS total_scripts,
        COUNT(DISTINCT account_id) AS unique_accounts,
        ROUND(SUM(revenue_amt) / NULLIF(SUM(unadjusted_script_count), 0), 2) AS revenue_per_script,
        ROUND(SUM(revenue_amt) / (SELECT SUM(revenue_amt)
                                  FROM prd_optumrx_orxfdmprdsa.rag.claim_transaction_for_pharmacy_pbm
                                  WHERE product_category = 'PBM'
                                    AND DATE_TRUNC('month', submit_date) = '2025-07-01') * 100, 2) AS revenue_share_pct
    FROM prd_optumrx_orxfdmprdsa.rag.claim_transaction_for_pharmacy_pbm
    WHERE product_category = 'PBM'
      AND DATE_TRUNC('month', submit_date) = '2025-07-01'
      AND claim_status_code = 'PAID'
    GROUP BY client_id, client_name
    ORDER BY total_revenue DESC
    LIMIT 10
    </sql>
    <narrative>Identifies the top 10 clients that generated the most PBM revenue in July 2025, including metrics on account diversity and revenue efficiency per script.</narrative>
</query>

<query>
    <query_id>top_pharmacies_dispensing_pbm_july_2025</query_id>
    <table>claims</table>
    <purpose>Top 10 pharmacies by PBM revenue volume</purpose>
    <sql>
    SELECT
        pharmacy_name,
        state_cd,
        SUM(revenue_amt) AS total_revenue,
        SUM(unadjusted_script_count) AS total_scripts,
        COUNT(DISTINCT drug_name) AS unique_drugs_dispensed,
        ROUND(SUM(revenue_amt) / NULLIF(SUM(unadjusted_script_count), 0), 2) AS revenue_per_script,
        ROUND(SUM(revenue_amt) / (SELECT SUM(revenue_amt)
                                  FROM prd_optumrx_orxfdmprdsa.rag.claim_transaction_for_pharmacy_pbm
                                  WHERE product_category = 'PBM'
                                    AND DATE_TRUNC('month', submit_date) = '2025-07-01') * 100, 2) AS revenue_share_pct
    FROM prd_optumrx_orxfdmprdsa.rag.claim_transaction_for_pharmacy_pbm
    WHERE product_category = 'PBM'
      AND DATE_TRUNC('month', submit_date) = '2025-07-01'
      AND claim_status_code = 'PAID'
    GROUP BY pharmacy_name, state_cd
    ORDER BY total_revenue DESC
    LIMIT 10
    </sql>
    <narrative>Shows the top 10 pharmacies that processed the highest PBM revenue in July 2025, including geographic distribution and drug diversity metrics.</narrative>
</query>

<query>
    <query_id>top_drug_manufacturers_pbm_july_2025</query_id>
    <table>claims</table>
    <purpose>Top 10 drug manufacturers by PBM revenue</purpose>
    <sql>
    SELECT
        DRUG_MANUFCTR_NM,
        SUM(revenue_amt) AS total_revenue,
        SUM(unadjusted_script_count) AS total_scripts,
        COUNT(DISTINCT drug_name) AS unique_drugs,
        COUNT(DISTINCT therapy_class_name) AS unique_therapy_classes,
        ROUND(SUM(revenue_amt) / NULLIF(SUM(unadjusted_script_count), 0), 2) AS revenue_per_script,
        ROUND(SUM(revenue_amt) / (SELECT SUM(revenue_amt)
                                  FROM prd_optumrx_orxfdmprdsa.rag.claim_transaction_for_pharmacy_pbm
                                  WHERE product_category = 'PBM'
                                    AND DATE_TRUNC('month', submit_date) = '2025-07-01') * 100, 2) AS revenue_share_pct
    FROM prd_optumrx_orxfdmprdsa.rag.claim_transaction_for_pharmacy_pbm
    WHERE product_category = 'PBM'
      AND DATE_TRUNC('month', submit_date) = '2025-07-01'
      AND claim_status_code = 'PAID'
      AND DRUG_MANUFCTR_NM IS NOT NULL
    GROUP BY DRUG_MANUFCTR_NM
    ORDER BY total_revenue DESC
    LIMIT 10
    </sql>
    <narrative>Identifies the top 10 drug manufacturers contributing to PBM revenue in July 2025, showing their portfolio diversity and pricing power through revenue per script metrics.</narrative>    
</query>

<query>
    <query_id>geographic_revenue_distribution_pbm_july_2025</query_id>
    <table>claims</table>
    <purpose>Top 10 states by PBM revenue and drug mix</purpose>
    <sql>
    SELECT
        state_cd,
        drug_name,
        SUM(revenue_amt) AS total_revenue,
        SUM(unadjusted_script_count) AS total_scripts,
        ROUND(SUM(revenue_amt) / NULLIF(SUM(unadjusted_script_count), 0), 2) AS revenue_per_script,
        ROUND(SUM(revenue_amt) / (SELECT SUM(revenue_amt)
                                  FROM prd_optumrx_orxfdmprdsa.rag.claim_transaction_for_pharmacy_pbm
                                  WHERE product_category = 'PBM'
                                    AND DATE_TRUNC('month', submit_date) = '2025-07-01') * 100, 2) AS revenue_share_pct
    FROM prd_optumrx_orxfdmprdsa.rag.claim_transaction_for_pharmacy_pbm
    WHERE product_category = 'PBM'
      AND DATE_TRUNC('month', submit_date) = '2025-07-01'
      AND claim_status_code = 'PAID'
      AND state_cd IS NOT NULL
    GROUP BY state_cd, drug_name
    ORDER BY total_revenue DESC
    LIMIT 10
    </sql>
    <narrative>Analyzes geographic revenue distribution for PBM in July 2025, showing which state and drug combinations generated the highest revenue, revealing regional prescription patterns.</narrative>
</query>
</queries>
root cause sql response None
❌ SQL generation failed for KG 1: object of type 'NoneType' has no len()
