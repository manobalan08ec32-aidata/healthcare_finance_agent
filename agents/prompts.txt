===============================================================================
ğŸ¬ WORKFLOW STARTING - Event stream beginning
================================================================================

ğŸ”§ Using fallback astream approach for reliable events
Routing entry to: navigation_controller
ğŸ“¦ Astream step: ['entry_router']
âœ… Node completed: entry_router - state keys: ['current_question', 'session_id', 'user_id', 'domain_selection', 'conversation_memory', 'errors', 'user_questions_history', 'session_context', 'nav_error_msg', 'router_error_msg', 'follow_up_error_msg', 'sql_gen_error_msg', 'strategy_planner_err_msg', 'user_friendly_message', 'next_agent', 'next_agent_disp']
ğŸ“¦ Event: type=node_end, name=entry_router
âœ… Node completed: entry_router
ğŸ¨ STATUS UPDATE: Showing status for navigation_controller
Navigation Controller starting: 2025-11-13T01:52:33.597849
Navigation Input - Current: 'new question - compare PBM Revenue between Q3 2025 vs Q3 2024'
Navigation Input - Existing Domain: PBM Network
Starting single-step processing...
conversation_memory {'dimensions': {}, 'analysis_context': {'current_analysis_type': None, 'analysis_history': []}}
ğŸ“Š Current forecast cycle: 8+4
Current Timestamp before question validator call: 2025-11-13 01:52:33
ğŸ”„ Prompt caching ENABLED - system prompt will be cached
âš ï¸ NO CACHE METRICS - Gateway may not support caching or caching not enabled
Current Timestamp after Question validator call: 2025-11-13 01:52:53
â±ï¸  Call Duration: 19.66 seconds

============================================================
ğŸ“Š PROMPT CACHING PERFORMANCE METRICS
============================================================
Input tokens:        5,739
Output tokens:       250
Cache write tokens:  0
Cache read tokens:   0
Total tokens:        5,989

âš ï¸  STATUS: No cache metrics detected
   â†’ Gateway may not support caching OR this is the first attempt
   â†’ If this persists on 2nd+ calls, caching is not enabled by gateway
============================================================

LLM Response: {
    "analysis": {
        "detected_prefix": "new question",
        "input_type": "business_question",
        "is_valid_business_question": true,
        "response_message": "",
        "context_decision": "NEW",
        "reasoning": "Detected prefix 'new question -' which is the PRIMARY signal for decision. Clean question 'compare PBM Revenue between Q3 2025 vs Q3 2024' contains metric (Revenue), filters (PBM), and complete time periods (Q3 2025 vs Q3 2024). Question is self-contained with all necessary components. No inheritance needed since this is explicitly marked as a new question and contains all required elements."
    },
    "rewrite": {
        "rewritten_question": "What is PBM Revenue for Q3 2025 vs Q3 2024",
        "question_type": "what",
        "user_message": ""
    },
    "filters": {
        "filter_values": ["PBM"]
    }
}
Added business question to history: 'What is PBM Revenue for Q3 2025 vs Q3 2024'
Navigation Controller ending: 2025-11-13T01:52:53.270446
ğŸ“¦ Astream step: ['navigation_controller']
âœ… Node completed: navigation_controller - state keys: ['current_question', 'session_id', 'user_id', 'next_agent', 'next_agent_disp', 'domain_selection', 'conversation_memory', 'nav_error_msg', 'errors', 'user_friendly_message', 'user_questions_history', 'session_context', 'router_error_msg', 'follow_up_error_msg', 'sql_gen_error_msg', 'strategy_planner_err_msg', 'question_type', 'filter_values', 'current_agent', 'topic_drift', 'missing_dataset_items', 'sql_followup_topic_drift', 'sql_followup_but_new_question', 'matched_sql', 'matched_table_name', 'history_question_match', 'history_sql_used', 'llm_retry_count', 'pending_business_question', 'rewritten_question', 'greeting_response', 'user_question_history']
ğŸ“¦ Event: type=node_end, name=navigation_controller
âœ… Node completed: navigation_controller
ğŸ¨ STATUS UPDATE: Showing status for router_agent
âš ï¸ No final state captured from workflow
Current authenticated user: Unknown User
Current authenticated user name: Unknown User
ğŸ”„ Resetting question_type to 'Follow-up' for next turn.
ğŸ—‚ï¸ Displaying 7 cached sessions
INIT: Subsequent question, setting radio to 'Follow-up'
RENDERED: Radio shows 'Follow-up' | first_question_asked=True
âœ… Radio button rendered (not in clarification mode)
CALLBACK: Radio changed to: New Question
Current authenticated user: Unknown User
Current authenticated user name: Unknown User
ğŸ—‚ï¸ Displaying 7 cached sessions
RENDERED: Radio shows 'New Question' | first_question_asked=True
âœ… Radio button rendered (not in clarification mode)
Current authenticated user: Unknown User
Current authenticated user name: Unknown User
ğŸ”„ Resetting question_type to 'Follow-up' for next turn.
ğŸ—‚ï¸ Displaying 7 cached sessions
RENDERED: Radio shows 'New Question' | first_question_asked=True
âœ… Radio button rendered (not in clarification mode)
ğŸ¯ Starting processing for: compare PBM Revenue between Q3 2025 vs Q3 2024
ğŸš€ Question type: 'New Question' | Workflow query: 'new question - compare PBM Revenue between Q3 2025 vs Q3 2024' | First Q asked: True
ğŸ“ STORED: Saving 'New Question' as last_radio_selection for next question
Current authenticated user: Unknown User
Current authenticated user name: Unknown User
ğŸ—‚ï¸ Displaying 7 cached sessions
âš ï¸ domain_selection came as list ['PBM Network']; normalizing to first item
ğŸ” Using domain selection (string) in chat workflow: PBM Network (type=str)
ğŸ¨ STATUS UPDATE: Showing status for entry_router

================================================================================
ğŸ¬ WORKFLOW STARTING - Event stream beginning
================================================================================

ğŸ”§ Using fallback astream approach for reliable events
Routing entry to: navigation_controller
ğŸ“¦ Astream step: ['entry_router']
âœ… Node completed: entry_router - state keys: ['current_question', 'session_id', 'user_id', 'rewritten_question', 'question_type', 'next_agent', 'next_agent_disp', 'current_agent', 'domain_selection', 'pending_business_question', 'user_question_history', 'conversation_memory', 'greeting_response', 'nav_error_msg', 'errors', 'llm_retry_count', 'filter_values', 'user_friendly_message', 'matched_sql', 'history_question_match', 'matched_table_name', 'history_sql_used', 'user_questions_history', 'session_context', 'topic_drift', 'missing_dataset_items', 'router_error_msg', 'follow_up_error_msg', 'sql_gen_error_msg', 'sql_followup_topic_drift', 'sql_followup_but_new_question', 'strategy_planner_err_msg']     
ğŸ“¦ Event: type=node_end, name=entry_router
âœ… Node completed: entry_router
ğŸ¨ STATUS UPDATE: Showing status for navigation_controller
Navigation Controller starting: 2025-11-13T01:54:45.587771
Navigation Input - Current: 'new question - compare PBM Revenue between Q3 2025 vs Q3 2024'
Navigation Input - Existing Domain: PBM Network
Starting single-step processing...
conversation_memory {'dimensions': {}, 'analysis_context': {'current_analysis_type': None, 'analysis_history': []}}
ğŸ“Š Current forecast cycle: 8+4
Current Timestamp before question validator call: 2025-11-13 01:54:45
ğŸ”„ Prompt caching ENABLED - system prompt will be cached
âš ï¸ NO CACHE METRICS - Gateway may not support caching or caching not enabled
Current Timestamp after Question validator call: 2025-11-13 01:55:05
â±ï¸  Call Duration: 19.86 seconds

============================================================
ğŸ“Š PROMPT CACHING PERFORMANCE METRICS
============================================================
Input tokens:        5,777
Output tokens:       258
Cache write tokens:  0
Cache read tokens:   0
Total tokens:        6,035

âš ï¸  STATUS: No cache metrics detected
   â†’ Gateway may not support caching OR this is the first attempt
   â†’ If this persists on 2nd+ calls, caching is not enabled by gateway
============================================================

LLM Response: {
    "analysis": {
        "detected_prefix": "new question",
        "input_type": "business_question",
        "is_valid_business_question": true,
        "response_message": "",
        "context_decision": "NEW",
        "reasoning": "Detected prefix 'new question -' which is the PRIMARY signal for decision making. Clean question after stripping prefix: 'compare PBM Revenue between Q3 2025 vs Q3 2024'. Current question has all required components: metric (Revenue), filters (PBM), and time (Q3 2025 vs Q3 2024). Since prefix 'new question' was detected, this overrides any other signals and makes this a NEW question regardless of previous context."
    },
    "rewrite": {
        "rewritten_question": "Compare PBM Revenue between Q3 2025 vs Q3 2024",
        "question_type": "what",
        "user_message": ""
    },
    "filters": {
        "filter_values": ["PBM"]
    }
}
Added business question to history: 'Compare PBM Revenue between Q3 2025 vs Q3 2024'
