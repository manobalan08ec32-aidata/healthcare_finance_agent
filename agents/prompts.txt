{
    "revenue_investigation_config": {
        "version": "1.0",
        "investigation_type": "revenue_variance_analysis",
        "description": "Complete revenue investigation pattern with embedded metadata and framework",
        
        "question_classification": {
            "trigger_keywords": [
                ["revenue", "drop|decrease|decline|fall"],
                ["revenue", "increase|growth|rise|up"],
                ["revenue", "vs|versus|compared", "previous|last|prior"],
                ["why", "revenue"]
            ],
            "time_pattern_keywords": [
                "month over month|mom|m-o-m",
                "quarter over quarter|qoq|q-o-q", 
                "year over year|yoy|y-o-y",
                "vs previous|vs last|compared to"
            ]
        },

        "investigation_framework": {
            "query_sequence": ["revenue_variance_detection", "client_membership_analysis", "carrier_analysis"],
            "max_queries": 3,
            "synthesis_approach": "markdown_intelligence_report",
            "expected_investigation_depth": "high"
        },

        "strategic_queries": {
            "query_1_revenue_variance": {
                "purpose": "Identify primary revenue variance areas by LOB and product",
                "sequence_order": 1,
                "table_name": "prd_optumrx_orxfdmprdsa.rag.actuals_vs_forecast_analysis",
                "table_metadata": {
                    "description": "High-level monthly or quarterly revenue performance by LOB and product category",
                    "columns": [
                        {
                            "name": "ledger",
                            "description": "Ledger type for the record",
                            "distinct_values": ["GAAP", "BUDGET", "8+4", "2+10", "5+7"]
                        },
                        {
                            "name": "metric_type",
                            "description": "Type of metric captured in amount_or_count",
                            "sample_values": ["Revenues", "Adjusted Scripts", "Unadjusted Scripts", "COGS Post Reclass", "SG&A Post Reclass", "IOI", "Total Membership"]
                        },
                        {
                            "name": "line_of_business",
                            "description": "Business segment for the revenue record",
                            "sample_values": ["C&S", "E&I", "M&R", "Rev Reclass", "Optum", "External"]
                        },
                        {
                            "name": "product_category",
                            "description": "High-level product or service grouping",
                            "sample_values": ["PBM", "Specialty", "HDP"]
                        },
                        {
                            "name": "transaction_date",
                            "description": "Transaction date (yyyy-MM-dd)"
                        },
                        {
                            "name": "quarter",
                            "description": "Quarter (Q1â€“Q4) derived from transaction_date"
                        },
                        {
                            "name": "amount_or_count",
                            "description": "Value for the record (amount or count depending on metric_type)"
                        }
                    ]
                },
                "analysis_requirements": {
                    "required_filters": ["metric_type = 'Revenues'", "ledger = 'GAAP'"],
                    "key_dimensions": ["line_of_business", "product_category"],
                    "focus_metrics": ["amount_or_count"],
                    "analysis_type": "period_comparison_with_variance",
                    "variance_threshold": "$250K absolute OR 10% percentage"
                },
                "output_requirements": {
                    "include_variance_calculation": true,
                    "include_percentage_change": true,
                    "order_by": "absolute_variance_impact_desc",
                    "filter_significant_only": true
                }
            },

            "query_2_client_membership": {
                "purpose": "Analyze client portfolio and membership changes driving revenue variance",
                "sequence_order": 2,
                "table_name": "prd_optumrx_orxfdmprdsa.rag.claim_transaction_for_pharmacy_pbm",
                "table_metadata": {
                    "description": "Operational revenue drivers from pharmacy claims",
                    "columns": [
                        {
                            "name": "line_of_business",
                            "description": "Business segment for the claim"
                        },
                        {
                            "name": "client_name",
                            "description": "Client name"
                        },
                        {
                            "name": "client_id",
                            "description": "Client identifier"
                        },
                        {
                            "name": "submit_date",
                            "description": "Claim submission date (yyyy-MM-dd)"
                        },
                        {
                            "name": "revenue_amt",
                            "description": "Revenue amount for the claim"
                        },
                        {
                            "name": "unadjusted_script_count",
                            "description": "Actual script count for each claim"
                        }
                    ]
                },
                "analysis_requirements": {
                    "key_dimensions": ["line_of_business", "client_name"],
                    "focus_metrics": ["revenue_amt", "unadjusted_script_count"],
                    "analysis_type": "client_churn_and_acquisition_detection",
                    "client_change_threshold": "$100K revenue impact",
                    "depends_on_query": "query_1_revenue_variance"
                },
                "output_requirements": {
                    "identify_client_status": ["Lost", "New", "Existing"],
                    "calculate_client_variance": true,
                    "focus_on_significant_lobs": "from_query_1_results",
                    "order_by": "absolute_client_impact_desc"
                }
            },

            "query_3_carrier_analysis": {
                "purpose": "Identify carrier utilization changes affecting revenue",
                "sequence_order": 3,
                "table_name": "prd_optumrx_orxfdmprdsa.rag.claim_transaction_for_pharmacy_pbm",
                "table_metadata": {
                    "description": "Operational revenue drivers from pharmacy claims",
                    "columns": [
                        {
                            "name": "carrier_id",
                            "description": "Insurance carrier identifier"
                        },
                        {
                            "name": "line_of_business",
                            "description": "Business segment for the claim"
                        },
                        {
                            "name": "submit_date",
                            "description": "Claim submission date (yyyy-MM-dd)"
                        },
                        {
                            "name": "revenue_amt",
                            "description": "Revenue amount for the claim"
                        },
                        {
                            "name": "unadjusted_script_count",
                            "description": "Actual script count for each claim"
                        }
                    ]
                },
                "analysis_requirements": {
                    "key_dimensions": ["carrier_id", "line_of_business"],
                    "focus_metrics": ["revenue_amt", "unadjusted_script_count"],
                    "analysis_type": "carrier_utilization_variance",
                    "depends_on_query": "query_1_revenue_variance",
                    "conditional_execution": "if_client_changes_insufficient_to_explain_variance"
                },
                "output_requirements": {
                    "calculate_utilization_changes": true,
                    "identify_significant_carrier_changes": true,
                    "focus_on_significant_lobs": "from_query_1_results",
                    "order_by": "carrier_impact_significance"
                }
            }
        },

        "intelligence_synthesis": {
            "variance_thresholds": {
                "significant_lob_variance": "$500K",
                "significant_client_change": "$100K", 
                "significant_membership_change": "5%",
                "significant_carrier_change": "20% utilization change"
            },
            
            "correlation_analysis": [
                "revenue_vs_membership",
                "revenue_vs_client_churn",
                "revenue_vs_carrier_changes"
            ],
            
            "tactical_direction_rules": {
                "client_driven_variance": "if_client_churn_explains_>60%_of_variance",
                "membership_driven_variance": "if_membership_changes_correlate_with_revenue", 
                "operational_variance": "if_none_of_above_explain_variance_sufficiently"
            }
        }
    }
}




preparation_prompt = f"""
You are a Strategic SQL Query Architect. Using the drill-through configuration metadata, generate strategic SQL queries for financial variance investigation.

USER QUESTION: {current_question}
QUESTION TYPE: {classification.get('question_type', 'financial_analysis')}

DRILL-THROUGH METADATA:
{json.dumps(strategic_queries_config, indent=2)}

STRATEGIC QUERY GENERATION INSTRUCTIONS:

You are provided with a comprehensive drill-through configuration that contains metadata for strategic investigation. Your task is to analyze this metadata and generate SQL queries based on the configuration structure.

CONFIGURATION ANALYSIS:
1. Extract the investigation type from the metadata
2. Identify the query sequence and purposes from strategic_queries section
3. Use the table_metadata to understand available columns and data structure
4. Apply analysis_requirements and output_requirements for each query
5. Generate queries that follow the investigation framework

METADATA-DRIVEN QUERY GENERATION:
- For each query in the strategic_queries section:
  * Use the specified table_name
  * Apply required_filters from analysis_requirements
  * Focus on key_dimensions and focus_metrics
  * Implement the analysis_type specified
  * Follow output_requirements for formatting and ordering
  * Consider variance_threshold values for filtering significant results

REASONING FOR QUERY SEQUENCE:
The metadata defines an investigation framework designed to systematically identify root causes of variance. Each query builds upon the previous one, starting with high-level variance detection, then drilling into specific drivers based on the investigation type. The queries are designed to provide complementary views that together form a comprehensive understanding of the variance drivers.

SQL GENERATION RULES:
1. Use exact table names and column names from table_metadata
2. Apply all required_filters specified in analysis_requirements
3. Include variance calculations based on analysis_type (period comparisons)
4. Focus on significant changes based on variance_threshold values
5. Use proper time period comparisons based on user question context
6. Include meaningful column aliases that match the business context
7. Follow ordering requirements from output_requirements
8. Implement conditional logic where depends_on_query is specified

RESPONSE FORMAT:
<multiple_sql>
<query1_title>
[Extract title from first query purpose - max 8 words]
</query1_title>
<query1>
[First SQL query based on metadata]
</query1>
<query2_title>
[Extract title from second query purpose - max 8 words]
</query2_title>
<query2>
[Second SQL query based on metadata]
</query2>
<query3_title>
[Extract title from third query purpose - max 8 words]
</query3_title>
<query3>
[Third SQL query based on metadata]
</query3>
</multiple_sql>

Generate the strategic SQL queries based solely on the provided metadata configuration.
"""
