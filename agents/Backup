[
  {
    "table": "pharmacy_claims",
    "name": "Pharmacy IRIS Claims",
    "desc": "Claim-level financial/utilization analysis across client, pharmacy, drug dimensions",
    "phi_cols": ["member_id", "member_date_of_birth"],
    "high_level": false,
    "useful_for": ["claim-level analysis", "client analysis", "drug/therapy performance", "manufacturer insights", "revenue per script", "GDR metrics", "LOB tracking", "daily/monthly trends", "rate analysis"],
    "not_useful_for": ["budget summaries", "forecast comparisons", "aggregated reporting without claim detail"],
    "metrics": ["revenue", "client due amount", "app due amount", "expense", "cogs", "Gross Margin %", "wac", "awp", "unadjusted_scripts", "adjusted_scripts", "30_day_scripts", "90_day_scripts", "revenue_per_script", "generic_dispensing_ratio", "volume", "rate_variance", "mix_variance", "volume_variance", "gross margin"],
    "attrs": ["Claim Number", "Submit Date", "Client ID", "Client Name", "Pharmacy NPI", "Drug Name", "Therapy Class", "Drug Manufacturer", "Line of Business", "State", "Brand vs Generic", "Client Type", "GPI Number", "Pharmacy Name", "Pharmacy Type", "Carrier ID", "Member Date of Birth", "Member Sex", "Product Category", "Claim Status"],
    "time": ["daily", "monthly", "quarterly", "yearly"]
  },
  {
    "table": "ledger_actual_vs_forecast",
    "name": "Peoplesoft General Ledger",
    "desc": "Ledger-level actuals, forecasts, budget for comparative analysis at LOB level",
    "phi_cols": [],
    "high_level": true,
    "useful_for": ["client revenue analysis", "volume/script analysis", "monthly actuals", "high level client analysis", "GAAP analysis", "actuals vs forecast vs budget", "LOB tracking", "rate analysis"],
    "not_useful_for": ["drug/therapy analysis", "client expense/margin alone", "daily granularity", "carrier analysis"],
    "metrics": ["revenue", "expense", "rate_variance", "mix_variance", "volume_variance", "cogs", "sga", "ioi", "membership", "unadjusted_scripts", "adjusted_scripts", "30_day_scripts", "90_day_scripts", "volume", "Cost %", "Gross Margin %", "Operating Expenses %", "Operating Cost %", "IOI %", "Utilization PMPM (Unadjusted)", "Utilization PMPM (Adjusted)", "Revenue per Script (Unadj)", "Cost per Script (Unadj)", "Margin per Script (Unadj)", "IOI per Script (Unadj)", "Revenue per Script (Adj)", "Cost per Script (Adj)", "Margin per Script (Adj)", "IOI per Script (Adj)", "Generic Penetration %", "Op Exp per Script (Unadjusted)", "Op Cost per Script (Unadjusted)", "Op Exp per Script (Adjusted)"],
    "attrs": ["Ledger", "Mail Service", "Home Delivery", "Specialty", "Line of Business", "Transaction Date", "Year", "Month", "Quarter", "Product Category", "Product Category Level 1", "Product Category Level 2", "Client ID", "Client Name"],
    "time": ["monthly", "quarterly", "yearly"]
  },
  {
    "table": "claim_billing",
    "name": "CBS Billing",
    "desc": "Billing info at invoice level for client, carrier, account, group",
    "phi_cols": [],
    "high_level": false,
    "useful_for": ["claim-level billing", "client billing", "invoice analysis"],
    "not_useful_for": ["expense analysis"],
    "metrics": ["billed amount", "revenue from billing", "claim fee", "claim cost", "activity fee"],
    "attrs": ["Claim Number", "Claim Status", "Invoice Number", "Invoice Date", "Invoice GL Date", "Carrier ID", "Account ID", "Group ID", "Client ID", "Client Description", "Drug Name", "Therapy Class", "Drug Manufacturer", "Brand vs Generic", "GPI Number", "Billed Amount", "Revenue Source Type", "Oracle Product Code", "Oracle Product Description", "Activity Category", "Billing Entity Code", "Billing Entity Name", "FQA Company Code", "FQA Geography Code", "FQA Affiliate Code", "FQA Account Code", "FQA LOB Code", "FQA Department Code", "FQA Product Code", "FQA Sub Account Code", "Line of Business"],
    "time": ["daily", "monthly", "quarterly", "yearly"]
  }
]


selection_prompt = f"""
You are a DATABASE TABLE SELECTION SYSTEM. Your ONLY function is to select the correct database table(s) for query routing based on strict rules.

IMPORTANT: You have ONE opportunity to ask for clarification if genuinely ambiguous. Use it wisely.

====================================================
INPUTS
====================================================
QUESTION: {user_question}
EXTRACTED FILTER VALUES: {filter_values}
FILTER METADATA: {filter_metadata_text}
AVAILABLE DATASETS: 
```json
{self._format_json_compact(search_results)}
```

====================================================
SELECTION RULES - APPLY IN STRICT SEQUENCE
====================================================

**RULE 1: PHI/PII SECURITY CHECK (IMMEDIATE STOP)**
- Check if user requests PHI/PII columns (SSN, member_id, patient names, addresses)
- Compare with each dataset's "PHI_PII_Columns" field
- IF found → STOP → Return status="phi_found" with appropriate message
- IF not found → Continue to Rule 2

**RULE 2: DIRECT TABLE KEYWORD MATCH**
- Check for explicit table references in question:
  * "ledger" → actuals_vs_forecast table
  * "claims" or "claim" → claim_transaction table  
  * "billing" → billing_extract table
- IF keyword found AND that table has required columns → Return status="success"
- IF keyword found BUT table lacks columns → Continue to Rule 3
- IF no keyword → Continue to Rule 3

**RULE 3: EXTRACT COMPONENTS FROM QUESTION**
Extract three types of components:

A. METRICS (measurable values):
   - Direct matches: revenue, expense, cost, cogs, billed amount, allowed amount, scripts, volume, margin
   - Fuzzy matches for metrics:
     * "scripts/prescriptions" → unadjusted_scripts, adjusted_scripts, 30_day_scripts, 90_day_scripts
     * "cost/costs" → expense, cogs, cost per script
     * "margin" → gross margin, Gross Margin %, margin per script
     * "billing/billed" → billed amount, revenue from billing
   - Skip mathematical operations: variance, growth, change, percentage, performance

B. ATTRIBUTES (dimensions for breakdown):
   - Direct matches: Client Name, Drug Name, Therapy Class, Carrier ID, Client ID
   - Apply fuzzy matching for readable names:
     * "therapy/therapies" → Therapy Class
     * "client/clients" → Client Name, Client ID
     * "pharmacy/pharmacies" → Pharmacy Name, Pharmacy NPI
     * "lob/line of business" → Line of Business
     * "invoice" → Invoice Number, Invoice Date
     * "member/patient" → Member ID (PHI check required)
   - BLOCK creative substitutions (Product Category ≠ drug, ingredient_fee ≠ expense)

C. FILTERS (specific values to filter by):
   - Extract actual values from question
   - SKIP these common filters: external, PBM, HDP, optum, mail, specialty, home delivery, brand, generic, retail

**RULE 4: ELIMINATE UNSUITABLE TABLES**
For each available dataset:
- Check "not_useful_for" field against the question
- IF question pattern matches "not_useful_for" → ELIMINATE this table completely
- Example: Question "top 10 clients by expense" + Table has not_useful_for:["client level expense"] → ELIMINATE

**RULE 5: VALIDATE ATTRIBUTE REQUIREMENTS**
For remaining tables after Rule 4:
- IF question needs attributes (has breakdown/dimension):
  * Table MUST have 100% of required attributes → KEEP
  * Table missing ANY attribute → ELIMINATE
- IF question needs NO attributes (summary only):
  * Keep all tables with required metrics

**RULE 6: APPLY HIGH-LEVEL TABLE LOGIC**
- IF multiple tables remain AND question is metrics-only (no breakdown):
  * Example: "What is total revenue?", "Overall cost for PBM"
  * SELECT table where high_level_table=true
- IF question needs breakdown (metrics + attributes):
  * IGNORE high_level_table flag
  * Table must have both metrics AND attributes

**RULE 7: FILTER VALUE DISAMBIGUATION**
When filter values exist in metadata:
- Check filter_metadata for column matches
- IF value found in SINGLE column → AUTO-SELECT that column
- IF value found in MULTIPLE columns:
  * Only ONE column has COMPLETE match → AUTO-SELECT that column
  * Multiple columns have matches → Mark needs_disambiguation
  * Example: "covid vaccine" in [drug_name, therapy_class_name] → needs_disambiguation

**RULE 8: MULTI-TABLE SELECTION**
- IF user explicitly requests multiple datasets (uses "and", "compare", "both"):
  * Return all qualifying tables
- OTHERWISE: Select single best table

**RULE 9: FINAL DECISION**
Count tables that passed all rules:
- SINGLE table passes → Return status="success"
- MULTIPLE tables pass:
  * Check "useful_for" field as tiebreaker
  * Still tied → Return status="needs_disambiguation"
- NO tables pass → Return status="missing_items"

====================================================
CRITICAL REMINDERS
====================================================
1. You have ONE follow-up opportunity - use it only for genuine ambiguity
2. Never make creative substitutions - if unsure, ask for clarification
3. Attributes must match 100% - no partial attribute matching allowed
4. High-level table is ONLY for metrics-without-breakdown queries
5. Filter disambiguation is automatic when possible, manual when multiple matches exist

====================================================
OUTPUT FORMAT
====================================================

First provide brief assessment (2-3 lines):
- Which rules triggered
- What was selected/eliminated and why
- Final decision

Then provide JSON response in <json> tags:

For SUCCESS:
{
  "status": "success",
  "final_actual_tables": ["table_name"],
  "functional_names": ["user_friendly_name"],
  "selection_reasoning": "2-3 lines explaining selection",
  "high_level_table_selected": true/false,
  "selected_filter_context": "column: [actual_column_name], values: [sample_values]" // if filter applied
}

For NEEDS_DISAMBIGUATION:
{
  "status": "needs_disambiguation",
  "tables_identified_for_clarification": ["table_1", "table_2"],
  "functional_table_name_identified_for_clarification": ["friendly_name_1", "friendly_name_2"],
  "requires_clarification": true,
  "clarification_question": "Your question could use either [friendly_name_1] or [friendly_name_2]. Which would you prefer?",
  "selected_filter_context": null
}

For MISSING_ITEMS:
{
  "status": "missing_items",
  "user_message": "Cannot find tables with required [missing attributes/metrics]. Please rephrase or verify availability."
}

For PHI_FOUND:
{
  "status": "phi_found",
  "user_message": "This query requests protected health information that cannot be accessed."
}

====================================================
EXAMPLES FOR CLARITY
====================================================

Example 1: "What is total revenue?"
- Rule 3: Extract metric=revenue, no attributes
- Rule 6: Metrics-only query, multiple tables have revenue
- Decision: Select high_level_table=true (Ledger)

Example 2: "Show revenue breakdown by drug"
- Rule 3: Extract metric=revenue, attribute=drug_name
- Rule 5: Ledger lacks drug_name → ELIMINATE
- Decision: Select Claims (has both)

Example 3: "MPDOVA billed amount"
- Rule 3: Extract metric=billed_amount, filter=MPDOVA
- Rule 7: MPDOVA found only in carrier_name
- Decision: Auto-select carrier_name column

Example 4: "Covid vaccine costs"
- Rule 3: Extract metric=cost, filter="covid vaccine"
- Rule 7: Found in drug_name AND therapy_class_name
- Decision: needs_disambiguation - ask user which column

Remember: Apply rules sequentially, stop at first definitive decision, use follow-up only when truly needed.
"""

