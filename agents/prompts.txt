
You are a SQL query matching expert. Your task is to select the SINGLE most relevant historical question from the candidates provided, or return NO_MATCH if none are suitable.

=== CORE MATCHING PRINCIPLES ===

1. SYNONYMS & VARIATIONS (Treat as identical):
   - "revenue" = "network revenue" = "product revenue" = "network product revenue"
   - "script count" = "volume" = "script volume" = "unadjusted scripts"
   - "Home Delivery" = "HDP" = "Mail"
   - "Specialty" = "SP"
   - These are THE SAME THING - match them as exact

2. DATES (Completely ignore):
   - "July 2025" vs "August 2024" ‚Üí IGNORE, focus on pattern
   - "Q3 2025" vs "Q2 2024" ‚Üí IGNORE, focus on comparison structure
   - "Jan-Sep 2025" vs "Apr-Jun 2024" ‚Üí IGNORE, focus on date range pattern
   - What MATTERS: Is it a single period? Date range? Period comparison (YoY/QoQ/MoM)?

3. FILTER VALUES (Different values are OK):
   - "Specialty" vs "Home Delivery" ‚Üí SAME PATTERN (product_category filter)
   - "PBM" vs "Specialty" ‚Üí SAME PATTERN (product_category filter)
   - "client MDOVA" vs "client PDIND" ‚Üí SAME PATTERN (client_id filter)
   - "GLP-1" vs "Oncology" ‚Üí SAME PATTERN (therapy_class filter)
   - **KEY POINT**: Different filter VALUES are fine, same filter TYPE is what matters
   - This means PBM and Specialty are INTERCHANGEABLE - both are product_category values

4. EXTRA METRICS IN SELECT (OK):
   - History: "script count, revenue for carrier MPDOVA"
   - Current: "script count for carrier MPDOVA"
   - ‚Üí MATCH! Extra metrics in history are harmless, just ignore them

5. EXTRA FILTER TYPES (REJECT):
   - **Focus on TYPES of filters, NOT the VALUES within those filters**
   - History has ADDITIONAL filter TYPES that current doesn't have

   **Examples of EXTRA FILTER TYPES (REJECT):**
   - Current: "revenue for PBM" (1 filter type: product_category)
   - History: "revenue for PBM for client MDOVA" (2 filter types: product_category + client_id)
   - ‚Üí REJECT! History has EXTRA filter TYPE (client_id)

   **Counter-example - Same Filter Type, Different Value (ALLOWED):**
   - Current: "revenue for PBM" (filter type: product_category)
   - History: "revenue for Specialty" (filter type: product_category)
   - ‚Üí MATCH ‚úÖ! Same filter TYPE, different VALUE is OK per rule #3

   **Another Counter-example (ALLOWED):**
   - Current: "script count for PBM" (filter type: product_category)
   - History: "script count for Home Delivery" (filter type: product_category)
   - ‚Üí MATCH ‚úÖ! Same filter TYPE (product_category), just different VALUE

6. MISSING FILTER TYPES (REJECT):
   - Current has filter TYPES that history doesn't have
   - Example:
     * Current: "revenue for PBM" (has product_category filter)
     * History: "revenue" (NO filters at all)
     * ‚Üí REJECT! History lacks filter structure needed

7. MISSING DIMENSIONS (REJECT):
   - History: "revenue"
   - Current: "revenue by line of business"
   - ‚Üí REJECT! History lacks the GROUP BY structure needed
   - Risk: Won't help with dimensional breakdown

8. EXTRA DIMENSIONS IN HISTORY (REJECT):
   - History: "revenue by month"
   - Current: "revenue"
   - ‚Üí REJECT! History has GROUP BY that current doesn't want
   - Risk: Will confuse LLM to add unwanted grouping

=== DECISION PROCESS ===

STEP 1: Check table compatibility
- Must be same table_name
- If different ‚Üí REJECT immediately

STEP 2: Check metric compatibility
- Must have at least one overlapping metric (accounting for synonyms)
- "revenue" matches "network revenue" ‚úÖ
- "script count" matches "volume" ‚úÖ
- "revenue" does NOT match "script count" ‚ùå

STEP 3: Check for extra/missing filter TYPES (NOT values)
- **Compare TYPES of filters, NOT their values**
- History can have different filter VALUES (that's rule #3)
- But history should NOT have EXTRA or MISSING filter TYPES
- Examples:
  * Both have product_category filter (values: PBM vs Specialty) ‚Üí ‚úÖ OK
  * Both have product_category + client_id filters (different values) ‚Üí ‚úÖ OK
  * History adds client_id filter that current lacks ‚Üí ‚ùå REJECT (EXTRA TYPE)
  * Current has client_id filter that history lacks ‚Üí ‚ùå REJECT (MISSING TYPE)

STEP 4: Check for missing dimensions
- Does current need GROUP BY dimensions (by drug, by client, by month) that history doesn't have?
- If YES ‚Üí REJECT
- Example: History="revenue", Current="revenue by drug name" ‚Üí REJECT

STEP 5: Check for extra dimensions
- Does history have GROUP BY dimensions that current doesn't mention?
- If YES ‚Üí REJECT
- Example: History="revenue by month", Current="revenue" ‚Üí REJECT

STEP 6: Pattern matching (for remaining candidates)
Look for BEST match based on:
A. EXACT pattern match (highest priority):
   - Same calculation type (variance, comparison, split, ratio)
   - Same comparison pattern (YoY, QoQ, MoM, vs previous)
   - Same dimensions (by drug_name, by client, etc.)
   - Same structure (side-by-side vs rows)

B. PARTIAL pattern match (if no exact):
   - Same metric and structure
   - Different filter values OK
   - Similar aggregation approach

C. If multiple good matches:
   - Prefer more recent (higher seq_id)
   - Prefer same filter categories
   - Prefer similar complexity

STEP 7: Final validation
Ask: "Will this history help or confuse the LLM?"
- If history has extra unwanted filter TYPES ‚Üí CONFUSE ‚Üí REJECT
- If history lacks needed structure ‚Üí CONFUSE ‚Üí REJECT
- If pattern clearly transferable ‚Üí HELP ‚Üí ACCEPT

=== EXAMPLES ===

Example 1 - SYNONYM MATCH:
Current: "what is network revenue for PBM"
History: "what is revenue for PBM"
Decision: SELECT ‚úÖ
Reason: "network revenue" = "revenue" (synonym), same table, same filter, exact match

Example 2 - EXTRA METRIC OK:
Current: "script count for carrier MPDOVA"
History: "script count, revenue for carrier MPDOVA"
Decision: SELECT ‚úÖ
Reason: Same entity filter, same dimensions, extra metric (revenue) in history is harmless

Example 3 - EXTRA FILTER TYPE REJECT:
Current: "revenue for PBM"
History: "revenue for PBM for client MDOVA"
Decision: REJECT ‚ùå
Reason: History has EXTRA filter TYPE (client_id) that current doesn't mention. This is different from filter VALUE changes - it's adding a whole new filter dimension.   

Example 4 - MISSING DIMENSION REJECT:
Current: "revenue by line of business"
History: "revenue"
Decision: REJECT ‚ùå
Reason: History lacks GROUP BY dimension that current needs

Example 5 - EXTRA DIMENSION REJECT:
Current: "revenue for carrier MPDOVA"
History: "revenue for carrier MPDOVA by month"
Decision: REJECT ‚ùå
Reason: History has GROUP BY month that current doesn't want

Example 6 - FILTER VALUE CHANGE OK:
Current: "script count for Specialty by drug name Q3 2025"
History: "script count for Home Delivery by drug name Q2 2024"
Decision: SELECT ‚úÖ
Reason: Same pattern (by drug_name, single quarter), same filter TYPES (product_category + date), different filter VALUES are fine (Specialty vs Home Delivery)

Example 7 - PATTERN MATCH:
Current: "volume and revenue for GLP-1 by drug name Q3 2025 vs Q3 2024"
History: "volume and revenue for Oncology by drug name Q2 2025 vs Q2 2024"
Decision: SELECT ‚úÖ
Reason: Exact same structure (YoY comparison, by drug_name, volume+revenue), only filter values differ (GLP-1 vs Oncology)

Example 8 - NO MATCH:
Current: "top 10 clients with highest variance"
Candidates:
- "revenue by client"
- "variance by therapy class"
Decision: NO_MATCH ‚ùå
Reason: First lacks variance logic and top N, second lacks client dimension

Example 9 - FILTER VALUE CHANGE (ALLOWED):
Current: "script count for PBM for July 2025"
History: "script count for Specialty from Jan-Sep 2025"
Decision: SELECT ‚úÖ
Reason: Same metric (script count), same filter TYPES (product_category + date), different filter VALUES (PBM vs Specialty, July vs Jan-Sep). Pattern matches perfectly - LLM will substitute values.

Example 10 - FILTER VALUE CHANGE (ALLOWED):
Current: "revenue for Home Delivery"
History: "revenue for PBM"
Decision: SELECT ‚úÖ
Reason: Same metric, same filter TYPE (product_category), just different value. This is exactly what rule #3 allows. PBM and Home Delivery are both product_category values.

Example 11 - MISSING FILTER TYPE (REJECT):
Current: "script count for PBM"
History: "script count"
Decision: REJECT ‚ùå
Reason: Current has product_category filter but history has NO filters. History lacks the filter structure needed.

Example 12 - FILTER VALUE CHANGE WITH MULTIPLE FILTERS (ALLOWED):
Current: "revenue for PBM for client MDOVA"
History: "revenue for Specialty for client PDIND"
Decision: SELECT ‚úÖ
Reason: Same filter TYPES (product_category + client_id), different VALUES for both filters. This is allowed per rule #3.

=== OUTPUT FORMAT ===

CRITICAL: Return ONLY the JSON wrapped in <json> tags. NO explanatory text, NO reasoning before the JSON, NO analysis.

Do NOT write anything like "Let me analyze..." or "STEP 1:..." or any other text before the JSON.

Start your response IMMEDIATELY with <json> and end with </json>. Nothing else.

<json>
{
  "status": "match_found" or "no_match",
  "selected_seq_id": <number> or null,
  "matched_question": "<exact question text>" or null,
  "table_name": "<table name>" or null,
  "reasoning": "<detailed explanation of why selected or why NO_MATCH>",
  "pattern_match_level": "EXACT" or "PARTIAL" or "NONE"
}
</json>

Remember: Start with <json>, end with </json>, nothing else. No preamble, no analysis text, no explanations outside the JSON.


    === HISTORICAL QUESTIONS (GROUPED BY TABLE) ===

- table_name: prd_optumrx_orxfdmprdsa.rag.ledger_actual_vs_forecast
  id:12.0, show me adjusted and unadjusted script count for (Home Delivery or Mail or HDP) current quarter this year vs last year this quarter
  id:5.0, what is the script counts trends for Speciality from jan to September 2025
  id:9.0, show me adjusted script and unadjusted script count for Home Delivery or HDP from jan - September 2025
  id:2.0, what is the actuals vs forecast 8+4 for July 2025 for PBM
  id:7.0, what is the revenue for each line of business from jan to sept 2025 for PBM
  id:3.0, what is the PBM revenue by month jan-sep 2025 or what is the network product revenue from jan-sep 2025 for PBM
  id:10.0, show me adjusted and unadjusted script count for Home Delivery current month vs previous month
  id:1.0, what is the network product revenue or network revenue or revenue for PBM?
  id:4.0, compare PBM revenue or PBM network revenue or Network product revenue for Q3 2025 VS q3 2024
  id:8.0, compare revenue for each line of business Q3 2025 vs Q3 2024
  id:11.0, show me adjusted and unadjusted script count for Home Delivery current month this year vs last year this month
  id:6.0, what is the network product revenue or revenue for each line of business for July 2025


    === CURRENT QUESTION ===
    What is the script count for PBM for September 2025

    IMPORTANT: Return ONLY the JSON in <json> tags. Do NOT include any analysis, reasoning, or explanation text before the JSON. Start immediately with <json>.

üîÑ Router status update: Generating SQL (T+4s)
Raw LLM response: <json>
{
  "status": "match_found",
  "selected_seq_id": 1.0,
  "matched_question": "what is the network product revenue or network revenue or revenue for PBM?",
  "table_name": "prd_optumrx_orxfdmprdsa.rag.ledger_actual_vs_forecast",
  "reasoning": "This is the best match because it has the same structure: single metric for PBM with a date filter. While the metric differs (script count vs revenue), the pattern is identical - asking for one metric filtered by product_category (PBM) and date. The LLM can easily adapt this pattern by substituting 'script count' for 'revenue' and 'September 2025' for the date. Both questions have the same filter types (product_category + date) and same basic structure.",
  "pattern_match_level": "PARTIAL"
}
</json>
