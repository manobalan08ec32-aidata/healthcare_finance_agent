{
  "second_pass_investigation_config": {
    "version": "1.0",
    "investigation_type": "granular_operational_analysis",
    "description": "Multi-dimensional operational drill-through analysis building on first-pass strategic findings",
    
    "shared_table_metadata": {
      "claims_operational": {
        "table_name": "prd_optumrx_orxfdmprdsa.rag.claim_transaction_for_pharmacy_pbm",
        "description": "Claim-level operational data with therapeutic, demographic, geographic, and utilization details",
        "columns": [
          {
            "name": "product_category",
            "description": "Product category for each claim",
            "distinct_values": ["PBM", "Home Delivery", "Specialty"]
          },
          {
            "name": "line_of_business",
            "description": "Line of business identifier",
            "distinct_values": ["E&I FI", "E&I ASO", "C&S", "PDP", "MAPD", "E&I UMR", "External"]
          },
          {
            "name": "client_id",
            "description": "Unique client identifier"
          },
          {
            "name": "carrier_id",
            "description": "Insurance carrier identifier"
          },
          {
            "name": "member_id",
            "description": "Individual member identifier for utilization analysis"
          },
          {
            "name": "submit_date",
            "description": "Claim submission date (yyyy-MM-dd)"
          },
          {
            "name": "therapy_class_name",
            "description": "Therapeutic class of dispensed drug"
          },
          {
            "name": "drug_name",
            "description": "Name of dispensed drug"
          },
          {
            "name": "brand_vs_generic_ind",
            "description": "Brand or Generic indicator",
            "distinct_values": ["Brand", "Generic"]
          },
          {
            "name": "pharmacy_name",
            "description": "Dispensing pharmacy name"
          },
          {
            "name": "pharmacy_type",
            "description": "Internal vs external pharmacy type",
            "distinct_values": ["EXTERNAL-NON OPTUM OWNED", "INTERNAL OPTUM OWNED"]
          },
          {
            "name": "state_cd",
            "description": "Two-letter state code for geographic analysis"
          },
          {
            "name": "mbr_dt_of_brth",
            "description": "Member date of birth (yyyy-MM-dd) for age analysis"
          },
          {
            "name": "mbr_sex",
            "description": "Member gender",
            "distinct_values": ["M", "F"]
          },
          {
            "name": "revenue_amt",
            "description": "Revenue amount per claim"
          },
          {
            "name": "unadjusted_script_count",
            "description": "Raw script count per claim"
          },
          {
            "name": "revenue_per_script",
            "description": "Revenue per script derived metric"
          },
          {
            "name": "GDR_Ratio",
            "description": "Generic Dispense Rate ratio"
          }
        ]
      }
    },

    "investigation_dimensions": {
      "therapeutic": ["therapy_class_name", "drug_name", "brand_vs_generic_ind"],
      "brand_generic": ["brand_vs_generic_ind", "therapy_class_name"],
      "operational": ["pharmacy_type", "pharmacy_name", "state_cd"],
      "geographic": ["state_cd"],
      "demographic": ["mbr_dt_of_brth", "mbr_sex", "member_id"],
      "utilization": ["member_id", "unadjusted_script_count", "revenue_per_script"]
    },

    "analysis_templates": {
      "therapeutic": {
        "table_reference": "claims_operational",
        "dimensions": ["therapy_class_name", "drug_name", "brand_vs_generic_ind"],
        "metrics": ["revenue_amt", "unadjusted_script_count", "revenue_per_script"],
        "filters": {
          "claim_status_code": "['P','X']",
          "product_category": "USER_INTENT_DRIVEN"
        },
        "date_column": "submit_date",
        "sql_count": 3,
        "sql_breakdown": ["therapy_class_variance", "drug_specific_analysis", "brand_generic_mix"],
        "llm_instructions": "CONTEXTUAL SCOPING: Inherit entity scope from first-pass findings (specific clients/LOBs identified). If first-pass found 'MDOVA client declining', filter all therapeutic analysis to client_id='MDOVA' only. MULTI-SQL APPROACH: Generate 3 focused SQLs: (1) Therapy class level variance analysis, (2) Drug-specific deep dive within top therapy classes, (3) Brand vs generic analysis within therapy classes. THERAPEUTIC DEEP-DIVE ANALYSIS: Identify which therapy classes and specific drugs are driving the variance patterns identified in first-pass. Focus on therapeutic category shifts, drug mix changes, and formulary impacts. BRAND vs GENERIC INTEGRATION: For each therapy class, analyze brand vs generic distribution changes. Look for brand-to-generic switches that could explain revenue per script variance. Calculate therapy class level GDR changes over comparison periods. KEY INSIGHTS TO SURFACE: Which therapy classes show highest absolute variance? Are high-revenue therapy classes declining while low-revenue classes growing? Drug-specific drivers within problematic therapy classes? Brand vs generic mix shifts within each therapy class? ENTITY STATUS ANALYSIS: Identify NEW therapy classes (zero prior period, current presence), DROP therapy classes (prior presence, zero current), EXISTING therapy classes with significant variance. SELECTION STRATEGY: Focus on top 10-15 therapy classes by absolute variance impact. Include both declining and growing categories for balanced view. EXPECTED INSIGHTS: Therapeutic category explanations for first-pass variance. Drug formulary or clinical protocol changes. Brand/generic therapeutic substitution patterns."
      },

      "brand_generic": {
        "table_reference": "claims_operational", 
        "dimensions": ["brand_vs_generic_ind", "therapy_class_name"],
        "metrics": ["revenue_amt", "unadjusted_script_count", "GDR_Ratio", "revenue_per_script"],
        "filters": {
          "claim_status_code": "['P','X']",
          "product_category": "USER_INTENT_DRIVEN"
        },
        "date_column": "submit_date",
        "sql_count": 2,
        "sql_breakdown": ["gdr_trend_analysis", "brand_switch_impact"],
        "llm_instructions": "CONTEXTUAL SCOPING: Inherit entity scope from first-pass findings. Apply same client/LOB filtering as identified in strategic analysis. DUAL-SQL APPROACH: Generate 2 focused SQLs: (1) GDR trend analysis by therapy class, (2) Brand-to-generic switch revenue impact quantification. GENERIC DISPENSE RATE FOCUS: Calculate GDR changes between comparison periods within the detected scope. Identify therapy classes with significant GDR shifts (>5% change). BRAND TO GENERIC IMPACT ANALYSIS: Quantify revenue impact of brand-to-generic switches. Calculate revenue per script differences between brand and generic within same therapy classes. Identify high-impact brand switches contributing to overall variance. FORMULARY CHANGE DETECTION: Look for sudden GDR spikes indicating formulary or policy changes. Identify therapy classes where brand utilization dropped significantly. FINANCIAL IMPACT ASSESSMENT: Calculate revenue lost/gained from brand-generic mix changes. Assess whether generic adoption is driving script volume increases that offset revenue per script declines. STRATEGIC INSIGHTS FOCUS: Which therapy classes show most significant brand-to-generic shifts? Are generic switches volume-positive but revenue-negative? High-value brands being replaced by generics? New generic launches impacting established brands? SELECTION STRATEGY: Focus on therapy classes with >$1M revenue variance and >10% GDR change. Include both high-GDR and low-GDR therapy classes for comparison."
      },

      "operational": {
        "table_reference": "claims_operational",
        "dimensions": ["pharmacy_type", "pharmacy_name", "state_cd"],
        "metrics": ["revenue_amt", "unadjusted_script_count", "revenue_per_script"],
        "filters": {
          "claim_status_code": "['P','X']",
          "product_category": "USER_INTENT_DRIVEN"
        },
        "date_column": "submit_date",
        "sql_count": 2,
        "sql_breakdown": ["pharmacy_type_performance", "geographic_operational"],
        "llm_instructions": "CONTEXTUAL SCOPING: Inherit entity scope from first-pass findings. Focus operational analysis within identified client/LOB context only. DUAL-SQL APPROACH: Generate 2 focused SQLs: (1) Pharmacy type performance analysis (internal vs external), (2) Geographic operational patterns by state and pharmacy. PHARMACY TYPE PERFORMANCE: Compare internal Optum-owned vs external pharmacy performance within scope. Identify if variance is concentrated in specific pharmacy types. Calculate revenue per script and script volume trends by pharmacy type. GEOGRAPHIC CONCENTRATION: Identify states/regions driving variance patterns within the entity scope. Look for geographic clustering of performance issues or improvements. STATE-LEVEL VARIANCE ANALYSIS: Which states show disproportionate variance contribution? Are certain states showing different operational patterns? PHARMACY-SPECIFIC DRIVERS: Within significant variance states, identify specific high-impact pharmacies (both internal and external). Focus on pharmacies with >$500K variance or >20% volume change. OPERATIONAL EFFICIENCY INSIGHTS: Compare pharmacy type efficiency metrics (revenue per script, script processing volume). Identify operational bottlenecks or performance advantages. NETWORK OPTIMIZATION SIGNALS: Are internal pharmacies outperforming external in certain regions? Should pharmacy network mix be optimized? Geographic expansion or contraction opportunities? SELECTION STRATEGY: Top 10 states by variance impact, top 20 pharmacies by operational significance. Balance internal vs external pharmacy representation."
      },

      "geographic": {
        "table_reference": "claims_operational",
        "dimensions": ["state_cd"],
        "metrics": ["revenue_amt", "unadjusted_script_count"],
        "filters": {
          "claim_status_code": "['P','X']",
          "product_category": "USER_INTENT_DRIVEN"
        },
        "date_column": "submit_date",
        "sql_count": 1,
        "sql_breakdown": ["state_variance_analysis"],
        "llm_instructions": "CONTEXTUAL SCOPING: Inherit entity scope from first-pass findings. Analyze geographic patterns within identified client/LOB context only. SINGLE-SQL APPROACH: Generate comprehensive state-level analysis with regional clustering in one query using CASE statements for regional groupings. GEOGRAPHIC VARIANCE CONCENTRATION: Identify which states contribute most to variance patterns identified in first-pass. Look for regional clustering of similar performance patterns. STATE-LEVEL MARKET DYNAMICS: Compare state-level performance trends within the entity scope. Identify states with disproportionate variance contribution (>5% of total). REGIONAL PATTERN RECOGNITION: Are variance patterns concentrated in specific geographic regions (West Coast, Southeast, etc.)? Do certain states show opposite trends (some growing, others declining)? MARKET SHARE IMPLICATIONS: Within entity scope, identify states where market position may be strengthening or weakening. Geographic concentration vs diversification trends. REGULATORY OR COMPETITIVE FACTORS: Flag states with unusual patterns that might indicate regulatory changes or competitive pressures. Identify states requiring strategic attention. CROSS-STATE COMPARISON: Compare similar-sized state markets within entity scope. Identify best-performing and underperforming state markets for benchmarking. SELECTION STRATEGY: Focus on top 15 states by absolute variance impact. Include both high-performing and underperforming states for balanced analysis."
      },

      "demographic": {
        "table_reference": "claims_operational",
        "dimensions": ["mbr_dt_of_brth", "mbr_sex", "member_id"],
        "metrics": ["revenue_amt", "unadjusted_script_count"],
        "filters": {
          "claim_status_code": "['P','X']",
          "product_category": "USER_INTENT_DRIVEN"
        },
        "date_column": "submit_date",
        "sql_count": 1,
        "sql_breakdown": ["demographic_utilization_analysis"],
        "llm_instructions": "CONTEXTUAL SCOPING: Inherit entity scope from first-pass findings. Analyze demographic patterns within identified client/LOB context only. SINGLE-SQL APPROACH: Generate comprehensive demographic analysis combining age cohorts and gender patterns in one query with member-level aggregations. AGE SEGMENTATION ANALYSIS: Create age cohorts (18-34, 35-54, 55-64, 65+) and analyze variance by age group. Identify which age segments driving variance patterns from first-pass. MEMBER STRENGTH AND CONCENTRATION: Calculate member counts and average revenue per member by demographic segments. Identify high-value member segments showing variance patterns. MEMBER UTILIZATION INTENSITY: Analyze scripts per member and revenue per member trends by demographic groups. Identify if variance is driven by member behavior changes or population mix shifts. GENDER-BASED UTILIZATION PATTERNS: Compare male vs female utilization patterns within entity scope. Identify gender-specific therapeutic or utilization trends contributing to variance. MEMBER LIFECYCLE ANALYSIS: Using member_id, identify member retention, churn, and acquisition patterns within demographic segments. High-value member retention vs new member acquisition impact. DEMOGRAPHIC RISK ASSESSMENT: Which demographic segments show concerning utilization or revenue trends? Are aging populations driving higher pharmaceutical utilization? Gender-specific therapeutic needs evolving? ACTIONABLE DEMOGRAPHIC INSIGHTS: Member segments requiring targeted clinical or commercial attention. Demographic-specific intervention opportunities. SELECTION STRATEGY: Focus on age segments with >$2M variance impact. Include both high-utilization and emerging demographic segments."
      },

      "utilization": {
        "table_reference": "claims_operational",
        "dimensions": ["member_id"],
        "metrics": ["revenue_amt", "unadjusted_script_count", "revenue_per_script"],
        "filters": {
          "claim_status_code": "['P','X']",
          "product_category": "USER_INTENT_DRIVEN"
        },
        "date_column": "submit_date",
        "sql_count": 2,
        "sql_breakdown": ["volume_price_decomposition", "member_utilization_patterns"],
        "llm_instructions": "CONTEXTUAL SCOPING: Inherit entity scope from first-pass findings. Analyze utilization patterns within identified client/LOB context only. DUAL-SQL APPROACH: Generate 2 focused SQLs: (1) Volume vs price variance decomposition, (2) Member-level utilization pattern analysis. VOLUME vs PRICE VARIANCE DECOMPOSITION: Separate variance into script volume changes vs revenue per script changes. Identify whether variance is primarily volume-driven or price-driven within entity scope. MEMBER-LEVEL UTILIZATION INTENSITY: Calculate scripts per member and revenue per member trends. Identify high-utilization members driving variance patterns. UTILIZATION PATTERN SEGMENTATION: Segment members by utilization intensity (low, medium, high utilizers). Analyze variance contribution by utilization segment. HIGH-VALUE MEMBER ANALYSIS: Identify members with annual pharmaceutical spend >$10K. Analyze retention, churn, and utilization changes among high-value members. MEMBER UTILIZATION LIFECYCLE: Track member utilization intensity changes between periods. Identify members moving between utilization tiers. NEW vs EXISTING MEMBER UTILIZATION: Compare new member utilization patterns vs existing member changes. Assess if variance driven by member mix changes or behavior changes. PER-MEMBER EFFICIENCY METRICS: Revenue per member, scripts per member, average script value by member segments. Identify efficiency trends within entity scope. UTILIZATION-BASED TARGETING: Which utilization segments require clinical intervention? Members showing concerning utilization spikes or drops? Opportunities for medication adherence programs? SELECTION STRATEGY: Focus on members with >$5K annual spend variance or >50% utilization change. Include both high and low utilizers for comprehensive view."
      }
    },

    "global_llm_instructions": {
      "second_pass_orchestration": "You are conducting SECOND-PASS granular operational analysis building on first-pass strategic findings. The investigation scope is inherited from first-pass entity identification (specific clients/LOBs/carriers). Focus on operational and behavioral drivers that explain WHY the strategic variance occurred. Use multi-dimensional analysis to provide actionable operational insights.",
      
      "dimensional_intelligence": "Select analysis dimensions based on user intent and first-pass findings. If user requests specific dimension (therapeutic, geographic, etc.), focus on that dimension plus 1-2 complementary dimensions. If user requests comprehensive analysis, analyze all relevant dimensions but prioritize based on first-pass variance patterns.",
      
      "operational_focus": "Second-pass analysis should explain operational drivers behind first-pass strategic findings. Focus on controllable business levers: therapeutic mix optimization, pharmacy network performance, member utilization management, geographic market strategies, brand/generic formulary decisions.",
      
      "cross_dimensional_correlation": "Look for correlations across dimensions: Do certain therapy classes concentrate in specific geographies? Are demographic segments driving brand vs generic preferences? Do pharmacy types serve different utilization patterns? Identify multi-dimensional insights that provide comprehensive operational understanding.",
      
      "actionable_insight_prioritization": "Prioritize insights that suggest clear business actions. Therapeutic formulary adjustments, pharmacy network optimization, member clinical interventions, geographic market strategies, brand/generic policy changes. Focus on insights that operations teams can act upon.",
      
      "variance_continuation_logic": "Build narrative continuity with first-pass findings. Use phrases like 'Building on the finding that Client X declined...', 'Drilling deeper into the MAPD LOB variance...', 'Operational analysis reveals that...'. Connect operational insights back to strategic variance patterns."
    }
  }
}


def create_strategic_sql_generation_prompt(current_question: str, investigation_config: Dict, query_key: str) -> str:
    
    prompt = f"""
You are a Strategic Financial Intelligence SQL Analyst. Generate high-quality Databricks SQL for strategic variance investigation.

USER QUESTION: {current_question}

INVESTIGATION CONFIGURATION:
{json.dumps(investigation_config, indent=2)}

CURRENT QUERY: {query_key}

==============================
CONFIGURATION INTERPRETATION INSTRUCTIONS
==============================

1. Extract the investigation_type and domain_specific_prompts for business intelligence context
2. Locate the specified query in strategic_queries section and read its complete configuration
3. Apply the query-specific llm_instructions for strategic focus and SQL guidance
4. Use analysis_requirements (required_filters, key_dimensions, focus_metrics, analysis_type)
5. Follow output_requirements (calculations, ordering, filtering specifications)
6. Consider analysis_type_guidance for domain-specific implementation approaches
7. Apply variance_thresholds from intelligence_synthesis for significance filtering

==============================
DATABRICKS SQL GENERATION REQUIREMENTS
==============================

1. MEANINGFUL COLUMN NAMES
- Use business-relevant column names that align with the query purpose and domain context
- Include period identifiers in variance calculations (current_period, prior_period, variance_amount, variance_pct)
- Use domain-appropriate terminology from the configuration business context

2. COMPLETE TRANSPARENCY - SHOW ALL COMPONENTS
- MANDATORY: Include ALL columns used in WHERE clause, GROUP BY clause, and calculations in SELECT output
- If calculating variance, include: current_period_value, prior_period_value, absolute_variance, percentage_variance
- If filtering by any dimension, include that dimension in SELECT for verification
- If grouping by business dimensions, include all grouping dimensions in output
- Example: SELECT line_of_business, product_category, current_revenue, prior_revenue, revenue_variance, variance_pct

3. DATA QUALITY AND FILTERING
- Use UPPER() for all text filtering: WHERE UPPER(column_name) = UPPER('filter_value')
- Handle NULL values appropriately: COALESCE(amount_or_count, 0)
- Apply ALL required_filters from analysis_requirements exactly as specified
- Use proper date handling: WHERE transaction_date BETWEEN 'YYYY-MM-DD' AND 'YYYY-MM-DD'

4. VARIANCE ANALYSIS CALCULATIONS
- Calculate both absolute ($) and percentage (%) variance for all metrics
- Include current period, comparison period, and variance calculations
- Apply significance filtering based on variance_thresholds from configuration
- Use statistical measures where appropriate (COUNT, AVG, STDDEV if relevant)

5. BUSINESS CONTEXT APPLICATION
- Extract time periods from user question context (Q3 vs Q2, month over month, etc.)
- Apply domain seasonality considerations from domain_specific_prompts
- Focus on key_dimensions and focus_metrics as specified in analysis_requirements
- Consider depends_on_query relationships for focus area determination

6. STRATEGIC FOCUS MAINTENANCE
- Maintain HIGH-LEVEL perspective appropriate for strategic investigation
- Focus on business segment and portfolio-level patterns as guided by llm_instructions
- Avoid operational details - maintain strategic scope per configuration guidance
- Each query should support the investigation_framework sequence

7. CROSS-QUERY INTELLIGENCE
- Consider previous query findings if depends_on_query is specified
- Build upon investigation sequence as defined in query_sequence
- Prepare results to inform subsequent strategic queries
- Validate expected correlation patterns from domain_specific_prompts

8. DATABRICKS SQL OPTIMIZATION
- Use standard SQL functions: SUM, COUNT, AVG, MAX, MIN, COALESCE
- Use date functions: date_trunc(), year(), month(), quarter(), DATEDIFF
- Use CTEs (WITH clauses) for complex period comparisons and multi-step calculations
- Use CASE WHEN for conditional logic and status categorization
- Use window functions for ranking and analytical calculations where appropriate

9. OUTPUT FORMATTING AND ORDERING
- Show whole numbers for financial metrics (no decimals for dollar amounts)
- Round percentages to two decimal places: ROUND(percentage, 2)
- Order by significance as specified in output_requirements
- Include ranking information where appropriate (ROW_NUMBER, RANK functions)
- Filter for significance based on variance thresholds

10. HEALTHCARE FINANCE BEST PRACTICES
- Always include time dimensions (transaction_date, quarter) when relevant
- Use business-friendly dimensions from configuration (line_of_business, product_category)
- Apply industry-specific filters (ledger = 'GAAP', metric_type = 'Revenues')
- Consider business cycles and patterns from domain_specific_prompts

11. ANALYTICAL DEPTH REQUIREMENTS
- Generate analysis appropriate for the expected_investigation_depth from configuration
- Balance comprehensiveness with strategic focus level
- Ensure query complexity matches the investigation_framework requirements
- Support the overall synthesis_approach defined in configuration

==============================
REASONING REQUIREMENT
==============================

Provide detailed reasoning covering these aspects:
1. **Time Period Extraction**: How you extracted and applied comparison periods from user question
2. **Configuration Implementation**: How you interpreted and applied the JSON configuration elements
3. **Business Logic Application**: How you applied domain-specific business intelligence
4. **Strategic Focus Alignment**: How you maintained appropriate strategic-level perspective
5. **SQL Construction Decisions**: Key decisions in query structure, filters, calculations, and ordering

==============================
RESPONSE FORMAT
==============================

<reasoning>
[Provide comprehensive reasoning following the 5-point structure above, explaining your interpretation of the configuration and approach to SQL construction]
</reasoning>

<sql>
[Complete, executable Databricks SQL query implementing all configuration requirements and business intelligence guidance]
</sql>

CRITICAL SUCCESS REQUIREMENTS:
1. Use exact table_name and column names from table_metadata in the configuration
2. Apply ALL required_filters from analysis_requirements
3. Focus on specified key_dimensions and focus_metrics
4. Implement the analysis_type using appropriate domain guidance
5. Follow output_requirements for calculations, filtering, and ordering
6. Maintain strategic-level focus per llm_instructions
7. Extract and apply user question context for time periods and scope
8. Generate high-quality, executable Databricks SQL with proper business context
9. Provide clear, comprehensive reasoning for all construction decisions
10. Support the overall investigation sequence and strategic intelligence objectives

Generate the strategic SQL query with detailed reasoning now.
"""
    
    return prompt
    
    return prompt



{
    "revenue_investigation_config": {
        "version": "1.0",
        "investigation_type": "revenue_variance_analysis",
        "description": "Complete revenue investigation pattern with embedded metadata and framework",
        
        "question_classification": {
            "trigger_keywords": [
                ["revenue", "drop|decrease|decline|fall"],
                ["revenue", "increase|growth|rise|up"],
                ["revenue", "vs|versus|compared", "previous|last|prior"],
                ["why", "revenue"]
            ],
            "time_pattern_keywords": [
                "month over month|mom|m-o-m",
                "quarter over quarter|qoq|q-o-q", 
                "year over year|yoy|y-o-y",
                "vs previous|vs last|compared to"
            ]
        },

        "investigation_framework": {
            "query_sequence": ["revenue_variance_detection", "client_membership_analysis", "carrier_analysis"],
            "max_queries": 3,
            "synthesis_approach": "markdown_intelligence_report",
            "expected_investigation_depth": "high"
        },

        "strategic_queries": {
            "query_1_revenue_variance": {
                "purpose": "Identify primary revenue variance areas by LOB and product",
                "sequence_order": 1,
                "table_name": "prd_optumrx_orxfdmprdsa.rag.actuals_vs_forecast_analysis",
                "table_metadata": {
                    "description": "High-level monthly or quarterly revenue performance by LOB and product category",
                    "columns": [
                        {
                            "name": "ledger",
                            "description": "Ledger type for the record",
                            "distinct_values": ["GAAP", "BUDGET", "8+4", "2+10", "5+7"]
                        },
                        {
                            "name": "metric_type",
                            "description": "Type of metric captured in amount_or_count",
                            "sample_values": ["Revenues", "Adjusted Scripts", "Unadjusted Scripts", "COGS Post Reclass", "SG&A Post Reclass", "IOI", "Total Membership"]
                        },
                        {
                            "name": "line_of_business",
                            "description": "Business segment for the revenue record",
                            "sample_values": ["C&S", "E&I", "M&R", "Rev Reclass", "Optum", "External"]
                        },
                        {
                            "name": "product_category",
                            "description": "High-level product or service grouping",
                            "sample_values": ["PBM", "Specialty", "HDP"]
                        },
                        {
                            "name": "transaction_date",
                            "description": "Transaction date (yyyy-MM-dd)"
                        },
                        {
                            "name": "quarter",
                            "description": "Quarter (Q1–Q4) derived from transaction_date"
                        },
                        {
                            "name": "amount_or_count",
                            "description": "Value for the record (amount or count depending on metric_type)"
                        }
                    ]
                },
                "analysis_requirements": {
                    "required_filters": ["metric_type = 'Revenues'", "ledger = 'GAAP'"],
                    "key_dimensions": ["line_of_business", "product_category"],
                    "focus_metrics": ["amount_or_count"],
                    "analysis_type": "period_comparison_with_variance",
                    "variance_threshold": "$250K absolute OR 10% percentage"
                },
                "output_requirements": {
                    "include_variance_calculation": true,
                    "include_percentage_change": true,
                    "order_by": "absolute_variance_impact_desc",
                    "filter_significant_only": true
                },
                "llm_instructions": {
                    "strategic_focus": "You are conducting HIGH-LEVEL revenue variance detection. Focus on business segment performance patterns, not operational details. This query establishes which LOBs and product categories drive overall variance.",
                    "business_context": "PBM revenue typically varies due to client portfolio changes, membership shifts, or product mix evolution. Identify which business segments show significant variance patterns that warrant deeper investigation.",
                    "sql_generation_guidance": "Generate period-over-period comparison focusing on line_of_business and product_category. Include current period revenue, comparison period revenue, absolute variance, and percentage variance. Filter for significance based on variance_threshold.",
                    "result_interpretation": "Look for LOBs with variance >$250K or >10%. These become focus areas for subsequent queries. Note any unusual patterns that break expected business correlations.",
                    "success_criteria": "Successfully identify 1-3 LOBs or product categories that explain majority of overall revenue variance with quantified impact."
                }
            },

            "query_2_client_membership": {
                "purpose": "Analyze client portfolio and membership changes driving revenue variance",
                "sequence_order": 2,
                "table_name": "prd_optumrx_orxfdmprdsa.rag.claim_transaction_for_pharmacy_pbm",
                "table_metadata": {
                    "description": "Operational revenue drivers from pharmacy claims",
                    "columns": [
                        {
                            "name": "line_of_business",
                            "description": "Business segment for the claim"
                        },
                        {
                            "name": "client_name",
                            "description": "Client name"
                        },
                        {
                            "name": "client_id",
                            "description": "Client identifier"
                        },
                        {
                            "name": "submit_date",
                            "description": "Claim submission date (yyyy-MM-dd)"
                        },
                        {
                            "name": "revenue_amt",
                            "description": "Revenue amount for the claim"
                        },
                        {
                            "name": "unadjusted_script_count",
                            "description": "Actual script count for each claim"
                        }
                    ]
                },
                "analysis_requirements": {
                    "key_dimensions": ["line_of_business", "client_name"],
                    "focus_metrics": ["revenue_amt", "unadjusted_script_count"],
                    "analysis_type": "client_churn_and_acquisition_detection",
                    "client_change_threshold": "$100K revenue impact",
                    "depends_on_query": "query_1_revenue_variance"
                },
                "output_requirements": {
                    "identify_client_status": ["Lost", "New", "Existing"],
                    "calculate_client_variance": true,
                    "focus_on_significant_lobs": "from_query_1_results",
                    "order_by": "absolute_client_impact_desc"
                },
                "llm_instructions": {
                    "strategic_focus": "Analyze client portfolio changes that drive the revenue variance identified in Query 1. Focus on significant client departures, acquisitions, and behavior changes within affected LOBs.",
                    "business_context": "Client churn is typically the primary driver of PBM revenue variance. Client departures directly reduce revenue, while new client acquisitions may show ramp-up patterns. Focus on clients with >$100K impact in LOBs identified from Query 1.",
                    "sql_generation_guidance": "Compare client revenue between periods in the significant LOBs from Query 1. Identify: (1) Lost clients (zero current revenue), (2) New clients (zero prior revenue), (3) Existing clients with significant changes. Calculate client-level variance and aggregate impact.",
                    "result_interpretation": "Quantify how much of Query 1 variance is explained by client portfolio changes. Look for patterns: multiple client losses in same LOB, new client ramp-up rates, existing client behavior shifts.",
                    "cross_query_validation": "Client changes should correlate with LOB variance patterns from Query 1. If major client churn occurred, expect corresponding LOB revenue decline.",
                    "success_criteria": "Identify specific clients driving significant portion of revenue variance with quantified impact. Validate correlation with Query 1 LOB findings."
                }
            },

            "query_3_carrier_analysis": {
                "purpose": "Identify carrier utilization changes affecting revenue",
                "sequence_order": 3,
                "table_name": "prd_optumrx_orxfdmprdsa.rag.claim_transaction_for_pharmacy_pbm",
                "table_metadata": {
                    "description": "Operational revenue drivers from pharmacy claims",
                    "columns": [
                        {
                            "name": "carrier_id",
                            "description": "Insurance carrier identifier"
                        },
                        {
                            "name": "line_of_business",
                            "description": "Business segment for the claim"
                        },
                        {
                            "name": "submit_date",
                            "description": "Claim submission date (yyyy-MM-dd)"
                        },
                        {
                            "name": "revenue_amt",
                            "description": "Revenue amount for the claim"
                        },
                        {
                            "name": "unadjusted_script_count",
                            "description": "Actual script count for each claim"
                        }
                    ]
                },
                "analysis_requirements": {
                    "key_dimensions": ["carrier_id", "line_of_business"],
                    "focus_metrics": ["revenue_amt", "unadjusted_script_count"],
                    "analysis_type": "carrier_utilization_variance",
                    "depends_on_query": "query_1_revenue_variance",
                    "conditional_execution": "if_client_changes_insufficient_to_explain_variance"
                },
                "output_requirements": {
                    "calculate_utilization_changes": true,
                    "identify_significant_carrier_changes": true,
                    "focus_on_significant_lobs": "from_query_1_results",
                    "order_by": "carrier_impact_significance"
                },
                "llm_instructions": {
                    "strategic_focus": "Analyze carrier behavior and utilization pattern changes that contribute to revenue variance in LOBs identified from Query 1. Focus on operational shifts that influence revenue beyond client portfolio changes.",
                    "business_context": "Carrier policy changes, network modifications, and utilization management shifts can significantly impact PBM revenue. Look for carriers with changed utilization patterns, especially in LOBs with unexplained variance from Queries 1-2.",
                    "sql_generation_guidance": "Compare carrier utilization (revenue and script volume) between periods in significant LOBs from Query 1. Calculate carrier-level variance and utilization rate changes. Focus on carriers showing >20% utilization changes.",
                    "result_interpretation": "Identify carriers with significant behavior changes that correlate with LOB variance patterns. Look for: policy changes affecting utilization, network changes impacting volume, seasonal pattern disruptions.",
                    "cross_query_validation": "Carrier changes should help explain any remaining variance not accounted for by client portfolio changes from Query 2. Look for operational drivers behind client behavior changes.",
                    "success_criteria": "Complete the strategic picture by identifying operational factors (carrier behavior) that, combined with client changes, explain the majority of revenue variance identified in Query 1."
                }
            }
        },

        "intelligence_synthesis": {
            "variance_thresholds": {
                "significant_lob_variance": "$500K",
                "significant_client_change": "$100K", 
                "significant_membership_change": "5%",
                "significant_carrier_change": "20% utilization change"
            },
            
            "correlation_analysis": [
                "revenue_vs_membership",
                "revenue_vs_client_churn",
                "revenue_vs_carrier_changes"
            ],
            
            "tactical_direction_rules": {
                "client_driven_variance": "if_client_churn_explains_>60%_of_variance",
                "membership_driven_variance": "if_membership_changes_correlate_with_revenue", 
                "operational_variance": "if_none_of_above_explain_variance_sufficiently"
            },
            
            "llm_synthesis_instructions": {
                "strategic_intelligence_approach": "Synthesize findings from all 3 strategic queries into comprehensive revenue variance explanation. Connect LOB-level variance (Query 1) with client portfolio changes (Query 2) and operational factors (Query 3) into cohesive strategic narrative.",
                "business_correlation_validation": "Validate expected business correlations: Client departures should correlate with LOB revenue decline. Carrier changes should align with client behavior shifts. Identify any broken correlations that suggest deeper issues.",
                "variance_explanation_completeness": "Quantify how much of total revenue variance is explained by identified factors. If <70% explained, flag need for tactical investigation into additional operational factors.",
                "tactical_direction_formulation": "Based on primary variance drivers identified, formulate clear tactical investigation priorities: (1) Client-focused if churn explains >60%, (2) Operational-focused if carrier/utilization factors dominate, (3) Mixed approach if multiple factors contribute significantly.",
                "strategic_insight_generation": "Generate actionable strategic insights: client retention opportunities, operational efficiency improvements, market positioning implications based on variance patterns discovered.",
                "markdown_report_structure": "Create executive-ready intelligence report with: Executive Summary (total variance + primary driver), Detailed Findings (3-query synthesis), Strategic Implications (business impact), Tactical Investigation Plan (next steps with priorities)"
            }
        },

        "domain_specific_prompts": {
            "business_intelligence_context": "You are analyzing pharmacy benefits management (PBM) revenue where variance typically stems from three strategic drivers: (1) Client portfolio changes - client departures/acquisitions directly impact revenue, (2) Membership dynamics - enrollment changes affect utilization volume, (3) Operational shifts - carrier policy changes and network utilization patterns. Focus on HIGH-LEVEL strategic patterns, not operational details.",
            
            "variance_interpretation_logic": "Revenue variance significance: >$250K absolute OR >10% percentage indicates strategic investigation priority. Client changes >$100K warrant deep analysis. Membership changes >5% typically correlate with revenue shifts. Cross-validate findings: client churn should align with membership decline and LOB performance patterns.",
            
            "investigation_priorities": "SEQUENCE: Start with LOB-level revenue variance to identify affected business segments → Analyze client portfolio changes in affected LOBs → Validate with operational drivers (carriers, utilization). Each query should narrow focus based on previous findings.",
            
            "business_seasonality": "Consider PBM patterns: Q1 (plan year changes, new client onboarding), Q4 (deductible exhaustion increases utilization), mid-year (formulary updates affect therapy mix). Adjust variance expectations accordingly.",
            
            "strategic_correlation_patterns": "Expected relationships: Client departures → membership decline → LOB revenue impact. Carrier policy changes → utilization shifts → revenue per script changes. Look for broken correlations as they indicate deeper issues requiring tactical investigation."
        },

        "analysis_type_guidance": {
            "period_comparison_with_variance": "Calculate both absolute ($) and percentage (%) variance. Include current period, comparison period, and variance in output. Focus on business segments exceeding significance thresholds.",
            
            "client_churn_and_acquisition_detection": "Identify clients with zero current period revenue (churn), zero prior period revenue (acquisition), and significant revenue changes (behavior shifts). Quantify impact and focus on LOBs identified in query 1.",
            
            "carrier_utilization_variance": "Analyze carrier behavior changes affecting revenue. Focus on carriers serving LOBs with significant variance from query 1. Look for utilization pattern shifts that explain client or membership changes."
        }
    }
}


{
    "revenue_investigation_config": {
        "version": "1.0",
        "investigation_type": "revenue_variance_analysis",
        "description": "Complete revenue investigation pattern with embedded metadata and framework",
        
        "question_classification": {
            "trigger_keywords": [
                ["revenue", "drop|decrease|decline|fall"],
                ["revenue", "increase|growth|rise|up"],
                ["revenue", "vs|versus|compared", "previous|last|prior"],
                ["why", "revenue"]
            ],
            "time_pattern_keywords": [
                "month over month|mom|m-o-m",
                "quarter over quarter|qoq|q-o-q", 
                "year over year|yoy|y-o-y",
                "vs previous|vs last|compared to"
            ]
        },

        "investigation_framework": {
            "query_sequence": ["revenue_variance_detection", "client_membership_analysis", "carrier_analysis"],
            "max_queries": 3,
            "synthesis_approach": "markdown_intelligence_report",
            "expected_investigation_depth": "high"
        },

        "strategic_queries": {
            "query_1_revenue_variance": {
                "purpose": "Identify primary revenue variance areas by LOB and product",
                "sequence_order": 1,
                "table_name": "prd_optumrx_orxfdmprdsa.rag.actuals_vs_forecast_analysis",
                "table_metadata": {
                    "description": "High-level monthly or quarterly revenue performance by LOB and product category",
                    "columns": [
                        {
                            "name": "ledger",
                            "description": "Ledger type for the record",
                            "distinct_values": ["GAAP", "BUDGET", "8+4", "2+10", "5+7"]
                        },
                        {
                            "name": "metric_type",
                            "description": "Type of metric captured in amount_or_count",
                            "sample_values": ["Revenues", "Adjusted Scripts", "Unadjusted Scripts", "COGS Post Reclass", "SG&A Post Reclass", "IOI", "Total Membership"]
                        },
                        {
                            "name": "line_of_business",
                            "description": "Business segment for the revenue record",
                            "sample_values": ["C&S", "E&I", "M&R", "Rev Reclass", "Optum", "External"]
                        },
                        {
                            "name": "product_category",
                            "description": "High-level product or service grouping",
                            "sample_values": ["PBM", "Specialty", "HDP"]
                        },
                        {
                            "name": "transaction_date",
                            "description": "Transaction date (yyyy-MM-dd)"
                        },
                        {
                            "name": "quarter",
                            "description": "Quarter (Q1–Q4) derived from transaction_date"
                        },
                        {
                            "name": "amount_or_count",
                            "description": "Value for the record (amount or count depending on metric_type)"
                        }
                    ]
                },
                "analysis_requirements": {
                    "required_filters": ["metric_type = 'Revenues'", "ledger = 'GAAP'"],
                    "key_dimensions": ["line_of_business", "product_category"],
                    "focus_metrics": ["amount_or_count"],
                    "analysis_type": "period_comparison_with_variance",
                    "variance_threshold": "$250K absolute OR 10% percentage"
                },
                "output_requirements": {
                    "include_variance_calculation": true,
                    "include_percentage_change": true,
                    "order_by": "absolute_variance_impact_desc",
                    "filter_significant_only": true
                }
            },

            "query_2_client_membership": {
                "purpose": "Analyze client portfolio and membership changes driving revenue variance",
                "sequence_order": 2,
                "table_name": "prd_optumrx_orxfdmprdsa.rag.claim_transaction_for_pharmacy_pbm",
                "table_metadata": {
                    "description": "Operational revenue drivers from pharmacy claims",
                    "columns": [
                        {
                            "name": "line_of_business",
                            "description": "Business segment for the claim"
                        },
                        {
                            "name": "client_name",
                            "description": "Client name"
                        },
                        {
                            "name": "client_id",
                            "description": "Client identifier"
                        },
                        {
                            "name": "submit_date",
                            "description": "Claim submission date (yyyy-MM-dd)"
                        },
                        {
                            "name": "revenue_amt",
                            "description": "Revenue amount for the claim"
                        },
                        {
                            "name": "unadjusted_script_count",
                            "description": "Actual script count for each claim"
                        }
                    ]
                },
                "analysis_requirements": {
                    "key_dimensions": ["line_of_business", "client_name"],
                    "focus_metrics": ["revenue_amt", "unadjusted_script_count"],
                    "analysis_type": "client_churn_and_acquisition_detection",
                    "client_change_threshold": "$100K revenue impact",
                    "depends_on_query": "query_1_revenue_variance"
                },
                "output_requirements": {
                    "identify_client_status": ["Lost", "New", "Existing"],
                    "calculate_client_variance": true,
                    "focus_on_significant_lobs": "from_query_1_results",
                    "order_by": "absolute_client_impact_desc"
                }
            },

            "query_3_carrier_analysis": {
                "purpose": "Identify carrier utilization changes affecting revenue",
                "sequence_order": 3,
                "table_name": "prd_optumrx_orxfdmprdsa.rag.claim_transaction_for_pharmacy_pbm",
                "table_metadata": {
                    "description": "Operational revenue drivers from pharmacy claims",
                    "columns": [
                        {
                            "name": "carrier_id",
                            "description": "Insurance carrier identifier"
                        },
                        {
                            "name": "line_of_business",
                            "description": "Business segment for the claim"
                        },
                        {
                            "name": "submit_date",
                            "description": "Claim submission date (yyyy-MM-dd)"
                        },
                        {
                            "name": "revenue_amt",
                            "description": "Revenue amount for the claim"
                        },
                        {
                            "name": "unadjusted_script_count",
                            "description": "Actual script count for each claim"
                        }
                    ]
                },
                "analysis_requirements": {
                    "key_dimensions": ["carrier_id", "line_of_business"],
                    "focus_metrics": ["revenue_amt", "unadjusted_script_count"],
                    "analysis_type": "carrier_utilization_variance",
                    "depends_on_query": "query_1_revenue_variance",
                    "conditional_execution": "if_client_changes_insufficient_to_explain_variance"
                },
                "output_requirements": {
                    "calculate_utilization_changes": true,
                    "identify_significant_carrier_changes": true,
                    "focus_on_significant_lobs": "from_query_1_results",
                    "order_by": "carrier_impact_significance"
                }
            }
        },

        "intelligence_synthesis": {
            "variance_thresholds": {
                "significant_lob_variance": "$500K",
                "significant_client_change": "$100K", 
                "significant_membership_change": "5%",
                "significant_carrier_change": "20% utilization change"
            },
            
            "correlation_analysis": [
                "revenue_vs_membership",
                "revenue_vs_client_churn",
                "revenue_vs_carrier_changes"
            ],
            
            "tactical_direction_rules": {
                "client_driven_variance": "if_client_churn_explains_>60%_of_variance",
                "membership_driven_variance": "if_membership_changes_correlate_with_revenue", 
                "operational_variance": "if_none_of_above_explain_variance_sufficiently"
            }
        }
    }
}




preparation_prompt = f"""
You are a Strategic SQL Query Architect. Using the drill-through configuration metadata, generate strategic SQL queries for financial variance investigation.

USER QUESTION: {current_question}
QUESTION TYPE: {classification.get('question_type', 'financial_analysis')}

DRILL-THROUGH METADATA:
{json.dumps(strategic_queries_config, indent=2)}

STRATEGIC QUERY GENERATION INSTRUCTIONS:

You are provided with a comprehensive drill-through configuration that contains metadata for strategic investigation. Your task is to analyze this metadata and generate SQL queries based on the configuration structure.

CONFIGURATION ANALYSIS:
1. Extract the investigation type from the metadata
2. Identify the query sequence and purposes from strategic_queries section
3. Use the table_metadata to understand available columns and data structure
4. Apply analysis_requirements and output_requirements for each query
5. Generate queries that follow the investigation framework

METADATA-DRIVEN QUERY GENERATION:
- For each query in the strategic_queries section:
  * Use the specified table_name
  * Apply required_filters from analysis_requirements
  * Focus on key_dimensions and focus_metrics
  * Implement the analysis_type specified
  * Follow output_requirements for formatting and ordering
  * Consider variance_threshold values for filtering significant results

REASONING FOR QUERY SEQUENCE:
The metadata defines an investigation framework designed to systematically identify root causes of variance. Each query builds upon the previous one, starting with high-level variance detection, then drilling into specific drivers based on the investigation type. The queries are designed to provide complementary views that together form a comprehensive understanding of the variance drivers.

SQL GENERATION RULES:
1. Use exact table names and column names from table_metadata
2. Apply all required_filters specified in analysis_requirements
3. Include variance calculations based on analysis_type (period comparisons)
4. Focus on significant changes based on variance_threshold values
5. Use proper time period comparisons based on user question context
6. Include meaningful column aliases that match the business context
7. Follow ordering requirements from output_requirements
8. Implement conditional logic where depends_on_query is specified

RESPONSE FORMAT:
<multiple_sql>
<query1_title>
[Extract title from first query purpose - max 8 words]
</query1_title>
<query1>
[First SQL query based on metadata]
</query1>
<query2_title>
[Extract title from second query purpose - max 8 words]
</query2_title>
<query2>
[Second SQL query based on metadata]
</query2>
<query3_title>
[Extract title from third query purpose - max 8 words]
</query3_title>
<query3>
[Third SQL query based on metadata]
</query3>
</multiple_sql>

Generate the strategic SQL queries based solely on the provided metadata configuration.
"""
