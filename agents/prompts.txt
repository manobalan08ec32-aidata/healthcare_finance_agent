individual_synthesizer_prompt = f"""
You are a Strategic Operational Intelligence Analyst conducting focused analysis of a single operational dimension. Generate targeted insights from one SQL result that explain specific operational drivers behind strategic variance.

FIRST-PASS STRATEGIC CONTEXT:
{first_pass_strategic_findings}

OPERATIONAL DIMENSION CONTEXT:
- Analysis Dimension: {operational_dimension}  # (therapeutic, geographic, demographic, etc.)
- SQL Focus: {sql_breakdown_focus}  # (therapy_class_variance, geographic_patterns, etc.)
- Strategic Entities: {strategic_entities_from_first_pass}

SQL QUERY EXECUTED:
{sql_query}

OPERATIONAL QUERY RESULTS:
{sql_results}

==============================
FOCUSED OPERATIONAL SYNTHESIS REQUIREMENTS
==============================

OBJECTIVE: Generate 5-6 insightful operational narratives that explain the specific causational drivers of variance within this operational dimension.

CAUSATION-FOCUSED ANALYSIS CONSTRAINTS:
- Generate exactly 5-6 insights focusing on WHY variance is occurring
- Each insight ≤30 words for clarity and impact
- Focus on causational analysis: what's driving the dip/growth patterns
- Use exact values from SQL results with auto-scaling (≥1B→x.xB, ≥1M→x.xM, ≥1K→x.xK)
- Connect findings directly to strategic entities from first-pass
- Let data drive insight structure - if 3-4 drugs cause variance, capture all of them in insights

CAUSATIONAL INSIGHT GUIDELINES:

1. **PRIMARY CAUSATIONAL DRIVERS**:
   - Root cause factors driving the variance within this dimension
   - Quantify the causational impact with specific values
   - Include all major contributing entities (multiple drugs, states, segments, etc.)

2. **BEHAVIORAL/STRUCTURAL SHIFTS**:
   - Key behavioral changes or structural shifts causing variance
   - Pattern changes that explain the underlying movement
   - Operational mechanisms driving the change

3. **CONCENTRATION/DISTRIBUTION PATTERNS**:
   - Where the causational factors are concentrated or distributed
   - Geographic, demographic, or categorical concentration of causes
   - Explains variance distribution patterns with specific entities

4. **COMPARATIVE CAUSATION**:
   - What changed between periods that caused the variance
   - Before vs after comparison showing causational shift
   - Period-over-period causational analysis with specifics

5. **VOLUME/INTENSITY CAUSATION**:
   - Whether variance is driven by volume changes or intensity changes
   - Utilization vs pricing causational factors
   - Quantity vs quality causational drivers

6. **OPERATIONAL MECHANISM INSIGHTS**:
   - Specific operational mechanisms or processes causing variance
   - Business process or policy changes driving results
   - Operational levers or system changes causation

DIMENSIONAL FOCUS REQUIREMENTS:

THERAPEUTIC ANALYSIS:
- Focus on specific therapy classes, drugs, and formulary impacts driving variance
- Brand vs generic substitution patterns with named drugs and impact amounts
- Clinical protocol or utilization changes affecting specific therapeutic areas
- Include all significant contributing drugs/therapy classes, not just top 1

GEOGRAPHIC ANALYSIS:
- State/regional concentration patterns with specific states and variance amounts
- Market-specific performance drivers with named locations
- Geographic clustering of variance with quantified regional impacts
- Include all significant contributing states/regions

DEMOGRAPHIC ANALYSIS:
- Specific age segment utilization patterns with quantified impacts
- Member strength and population shifts by demographic groups
- Demographic-driven behavioral changes with segment-specific causation
- Include all significant age/gender segments contributing to variance

BRAND/GENERIC ANALYSIS:
- Specific Generic Dispense Rate shifts by therapy class
- Named brand-to-generic substitutions with financial impact
- Formulary policy changes affecting specific drug categories
- Include all significant therapy classes showing GDR changes

OPERATIONAL ANALYSIS:
- Specific pharmacy network performance differences with quantified impacts
- Internal vs external operational efficiency by named performance metrics
- Network optimization opportunities with specific operational levers
- Include all significant pharmacy types/regions showing performance variance

UTILIZATION ANALYSIS:
- Volume vs price variance decomposition with specific contributing factors
- Member utilization intensity changes by behavior type
- High-value member behavior patterns with quantified member segments
- Include all significant utilization patterns contributing to variance

CAUSATIONAL LANGUAGE FRAMEWORK:
- Use causational terms: "drives", "causes", "stems from", "results from", "due to"
- Focus on mechanisms: "shift in", "change from", "movement toward"  
- Explain causation: "because", "resulting in", "leading to"
- Avoid correlation language - focus on causation
- Be specific with entity names and quantified impacts

CAUSATIONAL EXAMPLES BY DIMENSION:
✓ Therapeutic: "Oncology revenue decline stems from 3 major drugs: Keytruda ($25M decline), Opdivo ($18M decline), Tecentriq ($12M decline) due to generic competition"
✓ Geographic: "Southern market concentration drives 78% of variance: Texas ($31M decline), Florida ($22M decline), Georgia ($15M decline) due to regional formulary changes"
✓ Demographic: "55-64 age segment causes $28M decline due to benefit design changes: 45% utilization drop in high-cost therapy access affecting 12K members"
✓ Brand/Generic: "Generic substitution accelerates in 4 therapy classes: Oncology (23% GDR increase), Diabetes (18% increase), Cardiovascular (15% increase), causing $41M revenue shift"

RESPONSE FORMAT:
The response MUST be in XML format with only three required variables:

<operational_causation_analysis>

<causational_insights>
- Primary causational driver insight explaining root causes with specific entities and quantification
- Behavioral/structural shift insight showing what changed to cause variance with named factors
- Concentration pattern insight explaining where causational factors concentrate with specific locations/segments
- Comparative causation insight showing period-over-period causational changes with specific comparisons
- Volume/intensity causation insight explaining variance mechanism type with quantified factors
- Operational mechanism insight detailing specific business process causation with named operational changes
</causational_insights>

<key_causational_metrics>
**Primary Cause Impact**: Quantified impact of main causational driver from SQL results
**Causational Magnitude**: Scale of causational factor influence with specific amounts
**Causational Direction**: Whether cause drives growth or decline with percentage/dollar impact
</key_causational_metrics>

<causational_confidence>High/Medium/Low based on clarity of causational relationships in data and strength of evidence for identified drivers</causational_confidence>

</operational_causation_analysis>

Generate focused causational insights that explain WHY this operational dimension is driving strategic variance patterns. Include all significant contributing entities and quantify their specific impacts rather than limiting to single examples.
"""


--------------------------

SECOND-PASS OPERATIONAL BUSINESS CONTEXT:
- Focus on operational levers: therapeutic mix, pharmacy network, member behavior, geographic strategies
- Identify actionable insights for formulary management, network optimization, clinical interventions
- Cross-dimensional correlation: therapeutic + demographic, geographic + operational patterns
- Member-level insights using member_id for utilization intensity and lifecycle analysis

OPERATIONAL FILTERING REQUIREMENTS:
1. **Apply claim_status_code**: Always include ['P','X'] for paid and reversed claims
2. **Inherit product_category**: Use same category from first-pass strategic analysis
3. **Entity Scope Filtering**: Apply first-pass strategic entity filters consistently
4. **Intent-Based Selection**: Use variance direction for appropriate ordering and row limits

DERIVED METRICS CALCULATION:
- Primary metric per unit calculations, entity-level ratios within strategic entity scope
- Segmentation analysis using demographic dimensions with operational focus
- Category mix analysis using indicator dimensions for decision insights
- Performance type distinctions within strategic context

NOTE: Specific metrics depend on analysis type (revenue, expense, claims, membership, etc.). Use metrics defined in analysis_templates from JSON configuration.

==============================
COMPREHENSIVE REASONING REQUIREMENT
==============================

Provide detailed reasoning covering ALL these validation points:

1. **FIRST-PASS STRATEGIC CONTEXT EXTRACTION**:
   - How you identified strategic entities (clients, LOBs, carriers, membership) showing variance from first-pass findings
   - What entity-specific filters you extracted for operational drill-through (client_id, line_of_business, etc.)
   - How you determined variance magnitude and significance thresholds from strategic analysis
   - What strategic variance patterns you detected (declining, growing, mixed patterns)

2. **OPERATIONAL DIMENSIONAL SELECTION**:
   - How you selected operational drill-through dimensions based on user intent and strategic entity findings
   - Why chosen operational dimensions are most relevant for explaining strategic entity variance
   - How selected operational dimensions provide actionable insights for strategic entities

3. **STRATEGIC TO OPERATIONAL SCOPE INHERITANCE**:
   - How you applied first-pass strategic entity filters to all operational drill-through queries
   - What specific client/LOB/carrier filters you implemented for operational analysis
   - How you maintained consistency with first-pass product_category and date filters

4. **JSON CONFIGURATION USAGE**:
   - How you parsed analysis_templates for selected operational dimensions
   - How you interpreted sql_count and sql_breakdown for operational query generation
   - How you applied llm_instructions as operational intelligence for each dimension including intent-based row selection

5. **COMPARATIVE ANALYSIS IMPLEMENTATION**:
   - How you implemented period comparison logic consistent with first-pass analysis
   - What date filtering and period extraction you applied for operational analysis
   - How you structured comparative SQL queries for operational drill-through

6. **OPERATIONAL BUSINESS LOGIC**:
   - How you applied operational filters (claim_status_code, etc.) with strategic context
   - What derived metrics calculations you implemented for operational insights
   - How you focused on actionable operational insights within strategic entity scope

7. **INTENT-BASED ROW SELECTION**:
   - How you detected variance direction from first-pass findings for appropriate ordering
   - What row limits you applied per operational dimension based on llm_instructions
   - How you implemented ORDER BY logic for declining vs growing strategic entity investigation

8. **CROSS-DIMENSIONAL CORRELATION**:
   - How selected operational dimensions provide complementary insights for strategic entities
   - What cross-dimensional patterns you expect to surface within strategic scope
   - How operational dimensions together explain first-pass strategic entity variance comprehensively

9. **SQL GENERATION STRATEGY**:
   - How you structured each operational SQL using template components and operational metadata
   - What operational calculation logic you implemented with strategic entity scoping
   - How you applied selection strategies for operational significance within strategic context

10. **NARRATIVE CONTINUITY**:
    - How you maintained story continuity from strategic first-pass to operational second-pass
    - What language you used to connect operational findings to strategic entity variance
    - How operational second-pass explains the "why" behind strategic first-pass "what"

11. **ACTIONABILITY FOCUS**:
    - How operational findings translate to business recommendations for strategic entity performance
    - What actionable operational insights each dimension will provide for strategic entities
    - How operational analysis guides specific business actions for strategic entity improvement

==============================
RESPONSE FORMAT
==============================

<reasoning>
[Provide comprehensive reasoning following ALL 11 validation points above. Demonstrate thorough understanding of first-pass strategic context, operational dimensional selection logic, scope inheritance from strategic to operational, and operational intelligence application. Show validation of each critical aspect for operational drill-through analysis.]
</reasoning>

<sql>
<query1_title>
[Operational Dimension Name - Specific Analysis Focus]
[2-line explanation: Why this operational query is essential for explaining first-pass strategic findings + What operational insights it will surface]
</query1_title>
<query1>
[Complete, executable Databricks SQL with first-pass strategic entity scoping and comparative period analysis including intent-based row selection]
</query1>

<query2_title>
[Operational Dimension Name - Specific Analysis Focus] 
[2-line explanation: Why this operational query builds on previous analysis + What additional operational drivers it identifies]
</query2_title>
<query2>
[Complete, executable Databricks SQL with first-pass strategic entity scoping and comparative period analysis including intent-based row selection]
</query2>

[Continue for all selected operational dimensional analyses based on sql_count configuration...]
</sql>

Generate targeted second-pass operational SQL queries that explain the operational "why" behind first-pass strategic variance findings through therapeutic, geographic, demographic, utilization, and brand/generic drill-through analysis.
"""

{
    "revenue_investigation_config": {
        "version": "1.0",
        "investigation_type": "revenue_variance_analysis",
        "description": "Complete revenue investigation pattern with embedded metadata and framework",
        
        "question_classification": {
            "trigger_keywords": [
                ["revenue", "drop|decrease|decline|fall"],
                ["revenue", "increase|growth|rise|up"],
                ["revenue", "vs|versus|compared", "previous|last|prior"],
                ["why", "revenue"]
            ],
            "time_pattern_keywords": [
                "month over month|mom|m-o-m",
                "quarter over quarter|qoq|q-o-q", 
                "year over year|yoy|y-o-y",
                "vs previous|vs last|compared to"
            ]
        },

        "investigation_framework": {
            "query_sequence": ["revenue_variance_detection", "client_membership_analysis", "carrier_analysis"],
            "max_queries": 3,
            "synthesis_approach": "markdown_intelligence_report",
            "expected_investigation_depth": "high"
        },

        "strategic_queries": {
            "query_1_revenue_variance": {
                "purpose": "Identify primary revenue variance areas by LOB and product",
                "sequence_order": 1,
                "table_name": "prd_optumrx_orxfdmprdsa.rag.actuals_vs_forecast_analysis",
                "table_metadata": {
                    "description": "High-level monthly or quarterly revenue performance by LOB and product category",
                    "columns": [
                        {
                            "name": "ledger",
                            "description": "Ledger type for the record",
                            "distinct_values": ["GAAP", "BUDGET", "8+4", "2+10", "5+7"]
                        },
                        {
                            "name": "metric_type",
                            "description": "Type of metric captured in amount_or_count",
                            "sample_values": ["Revenues", "Adjusted Scripts", "Unadjusted Scripts", "COGS Post Reclass", "SG&A Post Reclass", "IOI", "Total Membership"]
                        },
                        {
                            "name": "line_of_business",
                            "description": "Business segment for the revenue record",
                            "sample_values": ["C&S", "E&I", "M&R", "Rev Reclass", "Optum", "External"]
                        },
                        {
                            "name": "product_category",
                            "description": "High-level product or service grouping",
                            "sample_values": ["PBM", "Specialty", "HDP"]
                        },
                        {
                            "name": "transaction_date",
                            "description": "Transaction date (yyyy-MM-dd)"
                        },
                        {
                            "name": "quarter",
                            "description": "Quarter (Q1–Q4) derived from transaction_date"
                        },
                        {
                            "name": "amount_or_count",
                            "description": "Value for the record (amount or count depending on metric_type)"
                        }
                    ]
                },
                "analysis_requirements": {
                    "required_filters": ["metric_type = 'Revenues'", "ledger = 'GAAP'"],
                    "key_dimensions": ["line_of_business", "product_category"],
                    "focus_metrics": ["amount_or_count"],
                    "analysis_type": "period_comparison_with_variance",
                    "variance_threshold": "$250K absolute OR 10% percentage"
                },
                "output_requirements": {
                    "include_variance_calculation": true,
                    "include_percentage_change": true,
                    "order_by": "absolute_variance_impact_desc",
                    "filter_significant_only": true
                },
                "llm_instructions": {
                    "strategic_focus": "You are conducting HIGH-LEVEL revenue variance detection. Focus on business segment performance patterns, not operational details. This query establishes which LOBs and product categories drive overall variance.",
                    "business_context": "PBM revenue typically varies due to client portfolio changes, membership shifts, or product mix evolution. Identify which business segments show significant variance patterns that warrant deeper investigation.",
                    "sql_generation_guidance": "Generate period-over-period comparison focusing on line_of_business and product_category. Include current period revenue, comparison period revenue, absolute variance, and percentage variance. Filter for significance based on variance_threshold.",
                    "result_interpretation": "Look for LOBs with variance >$250K or >10%. These become focus areas for subsequent queries. Note any unusual patterns that break expected business correlations.",
                    "success_criteria": "Successfully identify 1-3 LOBs or product categories that explain majority of overall revenue variance with quantified impact."
                }
            },

            "query_2_client_membership": {
                "purpose": "Analyze client portfolio and membership changes driving revenue variance",
                "sequence_order": 2,
                "table_name": "prd_optumrx_orxfdmprdsa.rag.claim_transaction_for_pharmacy_pbm",
                "table_metadata": {
                    "description": "Operational revenue drivers from pharmacy claims",
                    "columns": [
                        {
                            "name": "line_of_business",
                            "description": "Business segment for the claim"
                        },
                        {
                            "name": "client_name",
                            "description": "Client name"
                        },
                        {
                            "name": "client_id",
                            "description": "Client identifier"
                        },
                        {
                            "name": "submit_date",
                            "description": "Claim submission date (yyyy-MM-dd)"
                        },
                        {
                            "name": "revenue_amt",
                            "description": "Revenue amount for the claim"
                        },
                        {
                            "name": "unadjusted_script_count",
                            "description": "Actual script count for each claim"
                        }
                    ]
                },
                "analysis_requirements": {
                    "key_dimensions": ["line_of_business", "client_name"],
                    "focus_metrics": ["revenue_amt", "unadjusted_script_count"],
                    "analysis_type": "client_churn_and_acquisition_detection",
                    "client_change_threshold": "$100K revenue impact",
                    "depends_on_query": "query_1_revenue_variance"
                },
                "output_requirements": {
                    "identify_client_status": ["Lost", "New", "Existing"],
                    "calculate_client_variance": true,
                    "focus_on_significant_lobs": "from_query_1_results",
                    "order_by": "absolute_client_impact_desc"
                },
                "llm_instructions": {
                    "strategic_focus": "Analyze client portfolio changes that drive the revenue variance identified in Query 1. Focus on significant client departures, acquisitions, and behavior changes within affected LOBs.",
                    "business_context": "Client churn is typically the primary driver of PBM revenue variance. Client departures directly reduce revenue, while new client acquisitions may show ramp-up patterns. Focus on clients with >$100K impact in LOBs identified from Query 1.",
                    "sql_generation_guidance": "Compare client revenue between periods in the significant LOBs from Query 1. Identify: (1) Lost clients (zero current revenue), (2) New clients (zero prior revenue), (3) Existing clients with significant changes. Calculate client-level variance and aggregate impact.",
                    "result_interpretation": "Quantify how much of Query 1 variance is explained by client portfolio changes. Look for patterns: multiple client losses in same LOB, new client ramp-up rates, existing client behavior shifts.",
                    "cross_query_validation": "Client changes should correlate with LOB variance patterns from Query 1. If major client churn occurred, expect corresponding LOB revenue decline.",
                    "success_criteria": "Identify specific clients driving significant portion of revenue variance with quantified impact. Validate correlation with Query 1 LOB findings."
                }
            },

            "query_3_carrier_analysis": {
                "purpose": "Identify carrier utilization changes affecting revenue",
                "sequence_order": 3,
                "table_name": "prd_optumrx_orxfdmprdsa.rag.claim_transaction_for_pharmacy_pbm",
                "table_metadata": {
                    "description": "Operational revenue drivers from pharmacy claims",
                    "columns": [
                        {
                            "name": "carrier_id",
                            "description": "Insurance carrier identifier"
                        },
                        {
                            "name": "line_of_business",
                            "description": "Business segment for the claim"
                        },
                        {
                            "name": "submit_date",
                            "description": "Claim submission date (yyyy-MM-dd)"
                        },
                        {
                            "name": "revenue_amt",
                            "description": "Revenue amount for the claim"
                        },
                        {
                            "name": "unadjusted_script_count",
                            "description": "Actual script count for each claim"
                        }
                    ]
                },
                "analysis_requirements": {
                    "key_dimensions": ["carrier_id", "line_of_business"],
                    "focus_metrics": ["revenue_amt", "unadjusted_script_count"],
                    "analysis_type": "carrier_utilization_variance",
                    "depends_on_query": "query_1_revenue_variance",
                    "conditional_execution": "if_client_changes_insufficient_to_explain_variance"
                },
                "output_requirements": {
                    "calculate_utilization_changes": true,
                    "identify_significant_carrier_changes": true,
                    "focus_on_significant_lobs": "from_query_1_results",
                    "order_by": "carrier_impact_significance"
                },
                "llm_instructions": {
                    "strategic_focus": "Analyze carrier behavior and utilization pattern changes that contribute to revenue variance in LOBs identified from Query 1. Focus on operational shifts that influence revenue beyond client portfolio changes.",
                    "business_context": "Carrier policy changes, network modifications, and utilization management shifts can significantly impact PBM revenue. Look for carriers with changed utilization patterns, especially in LOBs with unexplained variance from Queries 1-2.",
                    "sql_generation_guidance": "Compare carrier utilization (revenue and script volume) between periods in significant LOBs from Query 1. Calculate carrier-level variance and utilization rate changes. Focus on carriers showing >20% utilization changes.",
                    "result_interpretation": "Identify carriers with significant behavior changes that correlate with LOB variance patterns. Look for: policy changes affecting utilization, network changes impacting volume, seasonal pattern disruptions.",
                    "cross_query_validation": "Carrier changes should help explain any remaining variance not accounted for by client portfolio changes from Query 2. Look for operational drivers behind client behavior changes.",
                    "success_criteria": "Complete the strategic picture by identifying operational factors (carrier behavior) that, combined with client changes, explain the majority of revenue variance identified in Query 1."
                }
            }
        },

        "intelligence_synthesis": {
            "variance_thresholds": {
                "significant_lob_variance": "$500K",
                "significant_client_change": "$100K", 
                "significant_membership_change": "5%",
                "significant_carrier_change": "20% utilization change"
            },
            
            "correlation_analysis": [
                "revenue_vs_membership",
                "revenue_vs_client_churn",
                "revenue_vs_carrier_changes"
            ],
            
            "tactical_direction_rules": {
                "client_driven_variance": "if_client_churn_explains_>60%_of_variance",
                "membership_driven_variance": "if_membership_changes_correlate_with_revenue", 
                "operational_variance": "if_none_of_above_explain_variance_sufficiently"
            },
            
            "llm_synthesis_instructions": {
                "strategic_intelligence_approach": "Synthesize findings from all 3 strategic queries into comprehensive revenue variance explanation. Connect LOB-level variance (Query 1) with client portfolio changes (Query 2) and operational factors (Query 3) into cohesive strategic narrative.",
                "business_correlation_validation": "Validate expected business correlations: Client departures should correlate with LOB revenue decline. Carrier changes should align with client behavior shifts. Identify any broken correlations that suggest deeper issues.",
                "variance_explanation_completeness": "Quantify how much of total revenue variance is explained by identified factors. If <70% explained, flag need for tactical investigation into additional operational factors.",
                "tactical_direction_formulation": "Based on primary variance drivers identified, formulate clear tactical investigation priorities: (1) Client-focused if churn explains >60%, (2) Operational-focused if carrier/utilization factors dominate, (3) Mixed approach if multiple factors contribute significantly.",
                "strategic_insight_generation": "Generate actionable strategic insights: client retention opportunities, operational efficiency improvements, market positioning implications based on variance patterns discovered.",
                "markdown_report_structure": "Create executive-ready intelligence report with: Executive Summary (total variance + primary driver), Detailed Findings (3-query synthesis), Strategic Implications (business impact), Tactical Investigation Plan (next steps with priorities)"
            }
        },

        "domain_specific_prompts": {
            "business_intelligence_context": "You are analyzing pharmacy benefits management (PBM) revenue where variance typically stems from three strategic drivers: (1) Client portfolio changes - client departures/acquisitions directly impact revenue, (2) Membership dynamics - enrollment changes affect utilization volume, (3) Operational shifts - carrier policy changes and network utilization patterns. Focus on HIGH-LEVEL strategic patterns, not operational details.",
            
            "variance_interpretation_logic": "Revenue variance significance: >$250K absolute OR >10% percentage indicates strategic investigation priority. Client changes >$100K warrant deep analysis. Membership changes >5% typically correlate with revenue shifts. Cross-validate findings: client churn should align with membership decline and LOB performance patterns.",
            
            "investigation_priorities": "SEQUENCE: Start with LOB-level revenue variance to identify affected business segments → Analyze client portfolio changes in affected LOBs → Validate with operational drivers (carriers, utilization). Each query should narrow focus based on previous findings.",
            
            "business_seasonality": "Consider PBM patterns: Q1 (plan year changes, new client onboarding), Q4 (deductible exhaustion increases utilization), mid-year (formulary updates affect therapy mix). Adjust variance expectations accordingly.",
            
            "strategic_correlation_patterns": "Expected relationships: Client departures → membership decline → LOB revenue impact. Carrier policy changes → utilization shifts → revenue per script changes. Look for broken correlations as they indicate deeper issues requiring tactical investigation."
        },

        "analysis_type_guidance": {
            "period_comparison_with_variance": "Calculate both absolute ($) and percentage (%) variance. Include current period, comparison period, and variance in output. Focus on business segments exceeding significance thresholds.",
            
            "client_churn_and_acquisition_detection": "Identify clients with zero current period revenue (churn), zero prior period revenue (acquisition), and significant revenue changes (behavior shifts). Quantify impact and focus on LOBs identified in query 1.",
            
            "carrier_utilization_variance": "Analyze carrier behavior changes affecting revenue. Focus on carriers serving LOBs with significant variance from query 1. Look for utilization pattern shifts that explain client or membership changes."
        }
    }
}


{
    "revenue_investigation_config": {
        "version": "1.0",
        "investigation_type": "revenue_variance_analysis",
        "description": "Complete revenue investigation pattern with embedded metadata and framework",
        
        "question_classification": {
            "trigger_keywords": [
                ["revenue", "drop|decrease|decline|fall"],
                ["revenue", "increase|growth|rise|up"],
                ["revenue", "vs|versus|compared", "previous|last|prior"],
                ["why", "revenue"]
            ],
            "time_pattern_keywords": [
                "month over month|mom|m-o-m",
                "quarter over quarter|qoq|q-o-q", 
                "year over year|yoy|y-o-y",
                "vs previous|vs last|compared to"
            ]
        },

        "investigation_framework": {
            "query_sequence": ["revenue_variance_detection", "client_membership_analysis", "carrier_analysis"],
            "max_queries": 3,
            "synthesis_approach": "markdown_intelligence_report",
            "expected_investigation_depth": "high"
        },

        "strategic_queries": {
            "query_1_revenue_variance": {
                "purpose": "Identify primary revenue variance areas by LOB and product",
                "sequence_order": 1,
                "table_name": "prd_optumrx_orxfdmprdsa.rag.actuals_vs_forecast_analysis",
                "table_metadata": {
                    "description": "High-level monthly or quarterly revenue performance by LOB and product category",
                    "columns": [
                        {
                            "name": "ledger",
                            "description": "Ledger type for the record",
                            "distinct_values": ["GAAP", "BUDGET", "8+4", "2+10", "5+7"]
                        },
                        {
                            "name": "metric_type",
                            "description": "Type of metric captured in amount_or_count",
                            "sample_values": ["Revenues", "Adjusted Scripts", "Unadjusted Scripts", "COGS Post Reclass", "SG&A Post Reclass", "IOI", "Total Membership"]
                        },
                        {
                            "name": "line_of_business",
                            "description": "Business segment for the revenue record",
                            "sample_values": ["C&S", "E&I", "M&R", "Rev Reclass", "Optum", "External"]
                        },
                        {
                            "name": "product_category",
                            "description": "High-level product or service grouping",
                            "sample_values": ["PBM", "Specialty", "HDP"]
                        },
                        {
                            "name": "transaction_date",
                            "description": "Transaction date (yyyy-MM-dd)"
                        },
                        {
                            "name": "quarter",
                            "description": "Quarter (Q1–Q4) derived from transaction_date"
                        },
                        {
                            "name": "amount_or_count",
                            "description": "Value for the record (amount or count depending on metric_type)"
                        }
                    ]
                },
                "analysis_requirements": {
                    "required_filters": ["metric_type = 'Revenues'", "ledger = 'GAAP'"],
                    "key_dimensions": ["line_of_business", "product_category"],
                    "focus_metrics": ["amount_or_count"],
                    "analysis_type": "period_comparison_with_variance",
                    "variance_threshold": "$250K absolute OR 10% percentage"
                },
                "output_requirements": {
                    "include_variance_calculation": true,
                    "include_percentage_change": true,
                    "order_by": "absolute_variance_impact_desc",
                    "filter_significant_only": true
                }
            },

            "query_2_client_membership": {
                "purpose": "Analyze client portfolio and membership changes driving revenue variance",
                "sequence_order": 2,
                "table_name": "prd_optumrx_orxfdmprdsa.rag.claim_transaction_for_pharmacy_pbm",
                "table_metadata": {
                    "description": "Operational revenue drivers from pharmacy claims",
                    "columns": [
                        {
                            "name": "line_of_business",
                            "description": "Business segment for the claim"
                        },
                        {
                            "name": "client_name",
                            "description": "Client name"
                        },
                        {
                            "name": "client_id",
                            "description": "Client identifier"
                        },
                        {
                            "name": "submit_date",
                            "description": "Claim submission date (yyyy-MM-dd)"
                        },
                        {
                            "name": "revenue_amt",
                            "description": "Revenue amount for the claim"
                        },
                        {
                            "name": "unadjusted_script_count",
                            "description": "Actual script count for each claim"
                        }
                    ]
                },
                "analysis_requirements": {
                    "key_dimensions": ["line_of_business", "client_name"],
                    "focus_metrics": ["revenue_amt", "unadjusted_script_count"],
                    "analysis_type": "client_churn_and_acquisition_detection",
                    "client_change_threshold": "$100K revenue impact",
                    "depends_on_query": "query_1_revenue_variance"
                },
                "output_requirements": {
                    "identify_client_status": ["Lost", "New", "Existing"],
                    "calculate_client_variance": true,
                    "focus_on_significant_lobs": "from_query_1_results",
                    "order_by": "absolute_client_impact_desc"
                }
            },

            "query_3_carrier_analysis": {
                "purpose": "Identify carrier utilization changes affecting revenue",
                "sequence_order": 3,
                "table_name": "prd_optumrx_orxfdmprdsa.rag.claim_transaction_for_pharmacy_pbm",
                "table_metadata": {
                    "description": "Operational revenue drivers from pharmacy claims",
                    "columns": [
                        {
                            "name": "carrier_id",
                            "description": "Insurance carrier identifier"
                        },
                        {
                            "name": "line_of_business",
                            "description": "Business segment for the claim"
                        },
                        {
                            "name": "submit_date",
                            "description": "Claim submission date (yyyy-MM-dd)"
                        },
                        {
                            "name": "revenue_amt",
                            "description": "Revenue amount for the claim"
                        },
                        {
                            "name": "unadjusted_script_count",
                            "description": "Actual script count for each claim"
                        }
                    ]
                },
                "analysis_requirements": {
                    "key_dimensions": ["carrier_id", "line_of_business"],
                    "focus_metrics": ["revenue_amt", "unadjusted_script_count"],
                    "analysis_type": "carrier_utilization_variance",
                    "depends_on_query": "query_1_revenue_variance",
                    "conditional_execution": "if_client_changes_insufficient_to_explain_variance"
                },
                "output_requirements": {
                    "calculate_utilization_changes": true,
                    "identify_significant_carrier_changes": true,
                    "focus_on_significant_lobs": "from_query_1_results",
                    "order_by": "carrier_impact_significance"
                }
            }
        },

        "intelligence_synthesis": {
            "variance_thresholds": {
                "significant_lob_variance": "$500K",
                "significant_client_change": "$100K", 
                "significant_membership_change": "5%",
                "significant_carrier_change": "20% utilization change"
            },
            
            "correlation_analysis": [
                "revenue_vs_membership",
                "revenue_vs_client_churn",
                "revenue_vs_carrier_changes"
            ],
            
            "tactical_direction_rules": {
                "client_driven_variance": "if_client_churn_explains_>60%_of_variance",
                "membership_driven_variance": "if_membership_changes_correlate_with_revenue", 
                "operational_variance": "if_none_of_above_explain_variance_sufficiently"
            }
        }
    }
}




preparation_prompt = f"""
You are a Strategic SQL Query Architect. Using the drill-through configuration metadata, generate strategic SQL queries for financial variance investigation.

USER QUESTION: {current_question}
QUESTION TYPE: {classification.get('question_type', 'financial_analysis')}

DRILL-THROUGH METADATA:
{json.dumps(strategic_queries_config, indent=2)}

STRATEGIC QUERY GENERATION INSTRUCTIONS:

You are provided with a comprehensive drill-through configuration that contains metadata for strategic investigation. Your task is to analyze this metadata and generate SQL queries based on the configuration structure.

CONFIGURATION ANALYSIS:
1. Extract the investigation type from the metadata
2. Identify the query sequence and purposes from strategic_queries section
3. Use the table_metadata to understand available columns and data structure
4. Apply analysis_requirements and output_requirements for each query
5. Generate queries that follow the investigation framework

METADATA-DRIVEN QUERY GENERATION:
- For each query in the strategic_queries section:
  * Use the specified table_name
  * Apply required_filters from analysis_requirements
  * Focus on key_dimensions and focus_metrics
  * Implement the analysis_type specified
  * Follow output_requirements for formatting and ordering
  * Consider variance_threshold values for filtering significant results

REASONING FOR QUERY SEQUENCE:
The metadata defines an investigation framework designed to systematically identify root causes of variance. Each query builds upon the previous one, starting with high-level variance detection, then drilling into specific drivers based on the investigation type. The queries are designed to provide complementary views that together form a comprehensive understanding of the variance drivers.

SQL GENERATION RULES:
1. Use exact table names and column names from table_metadata
2. Apply all required_filters specified in analysis_requirements
3. Include variance calculations based on analysis_type (period comparisons)
4. Focus on significant changes based on variance_threshold values
5. Use proper time period comparisons based on user question context
6. Include meaningful column aliases that match the business context
7. Follow ordering requirements from output_requirements
8. Implement conditional logic where depends_on_query is specified

RESPONSE FORMAT:
<multiple_sql>
<query1_title>
[Extract title from first query purpose - max 8 words]
</query1_title>
<query1>
[First SQL query based on metadata]
</query1>
<query2_title>
[Extract title from second query purpose - max 8 words]
</query2_title>
<query2>
[Second SQL query based on metadata]
</query2>
<query3_title>
[Extract title from third query purpose - max 8 words]
</query3_title>
<query3>
[Third SQL query based on metadata]
</query3>
</multiple_sql>

Generate the strategic SQL queries based solely on the provided metadata configuration.
"""
