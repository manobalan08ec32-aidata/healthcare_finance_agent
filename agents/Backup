PHASE 1: PRE-VALIDATION PIPELINE

Execute these checks sequentially. Document each finding.

**CHECK 1: Term Extraction & Mapping**
Extract EVERY business term from the question and map to metadata:

Examples:
- "revenue by carrier for August" → Extract: [revenue, carrier, August]
- "top 5 products with highest margin" → Extract: [products, margin, top 5]
- "MPDOVA claims in Q3" → Extract: [MPDOVA, claims, Q3]

For each term, validate against AVAILABLE METADATA:
- Exact match: "carrier" → carrier_id → ✓Found(carrier_id)
- Fuzzy match: "revenue" → revenue_amount → ✓Found(revenue_amount)  
- No match: "profitability" → (no profit columns) → ✗Not Found
- Ambiguous: "amount" → (revenue_amount, expense_amount) → ⚠Ambiguous(revenue_amount, expense_amount)

Output:
Terms: [revenue, carrier, August]
Mapping: revenue(✓revenue_amount) | carrier(✓carrier_id) | August(✓month)

**CHECK 2: Mandatory Filter Validation** ⚠️ CRITICAL
Mandatory filters MUST be in WHERE clause or query fails.

Check: {mandatory_columns_text}
- If "ledger: MANDATORY" → SQL MUST have "WHERE ledger = ..."
- If "data_source: MANDATORY" → SQL MUST have "WHERE data_source = ..."

Status: ✓Ready (will add to WHERE) | ✗STOP (mandatory column not in metadata)

**CHECK 3: Filter Context Validation**
When user mentions values without attributes (e.g., "MPDOVA", "2024", "Specialty"):

Process:
1. Is value in user's question? → If no, skip this filter
2. Is it in FILTER VALUES EXTRACTED with exact match? → Check
3. Does the mapped column exist in metadata? → Verify

Examples:
- Question has "MPDOVA", Filter shows "carrier_id: MPDOVA", carrier_id in metadata → ✓Use(carrier_id='MPDOVA')

Status: ✓Valid([column=value pairs]) | ✗Invalid | N/A

**CHECK 4: Clarity Assessment**

A. **Temporal Clarity**
- Specific dates (past/present/future): "August 2024", "Q3 2025", "Jan 2026" → ✓Clear
- Relative dates: "last month", "YTD", "next quarter" → ✓Clear
- Vague: "recently", "a while ago", "soon" → ✗Unclear

B. **Metric Clarity**
- Standard aggregations: "total revenue", "average cost" → ✓Clear(SUM/AVG)
- Known calculations: "margin = revenue - cost" → ✓Clear
- Undefined: "efficiency score", "performance index" → ✗Unclear formula

C. **Grouping/Filtering Clarity**
- Explicit: "by product category and month" → ✓Clear
- Vague: "top products" (by what metric?) → ✗Unclear
- Missing: "compare regions" (which regions?) → ✗Unclear

D. **Multiple Value Intent**
When user lists multiple specific values (HDP, SP or drug1, drug2):
- Multiple values mentioned → Need breakdown by each → ✓Show individually
- "total for HDP and SP" → Aggregate together → ✓Clear intent
- "compare HDP vs SP" → Show side-by-side → ✓Clear intent

Examples:
- "revenue for HDP, SP" → SELECT category, SUM(revenue) GROUP BY category
- "total revenue for HDP and SP" → WHERE category IN ('HDP','SP') [no GROUP BY category]
- "HDP vs SP comparison" → Separate columns for each

**CHECK 5: {check_5_text} **

==========================
VALIDATION DECISION GATE
==========================
⚠️ OUTPUT STARTS HERE - DO NOT SHOW PRE-VALIDATION PIPELINE ⚠️

**VALIDATION OUTPUT:**
□ CHECK 1 Mapping: (✓Revenues) | External LOB(✓line_of_business) | HDP(✓product_category)| July 2025(✓month, year)
□ CHECK 2 Mandatory: [✓Ready | ✗STOP]
□ CHECK 3 Filters: [✓Valid | ✗Invalid | N/A]
□ CHECK 4 Clarity: A[✓/✗] B[✓/✗] C[✓/✗]
□ CHECK 5 Rules: [✓history sql used | ✗ history sql not used]

**DECISION LOGIC:**
- ALL checks ✓ or N/A → PROCEED TO SQL GENERATION
- ANY check ✗ or blocking ⚠ → GENERATE FOLLOW-UP
- ONE failure = STOP (Do not attempt SQL with uncertainty)

⚠️ After outputting the decision above, immediately proceed to <sql>, <multiple_sql>, or <followup> tags.
⚠️ Do NOT output any additional explanation or detailed assessment.


