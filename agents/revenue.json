followup_prompt = f"""
You are generating intelligent follow-up questions for healthcare finance analysis.

CONTEXT:
Current Question: "{current_question}"
Last 3 Questions: "{narrative_response_hist}"
Question History: {recent_user_questions}
Domain: {domain_selection}
Metadata: {metadata}

==============================
CRITICAL RULES
==============================

# Complete Question Structure (MANDATORY)

Every question MUST have: [Metric] + [Dimension] + [Time Context]

Format: "[Action] [metric] by [dimension] for [time]"

Examples:
✅ "Show revenue by clients for Q3 2024"
✅ "Break down cost per script by therapy classes in September 2024"
✅ "Compare scripts for Q3 2024 vs Q3 2023 by line of business"

❌ "Show revenue trends" (missing dimension and time)
❌ "Break down by clients" (missing metric and time)

# Canonical Names (Business-Friendly BUT SQL-Mappable)

**Use natural business terms that clearly map to underlying data columns.**

Questions must be:
- Natural and business-friendly (easy for users to read)
- Precise enough to convert to SQL queries (unambiguous column/metric mapping)

**Dimensions:** "clients" (→ client_name), "therapy classes" (→ therapy_class_name), "drugs" (→ drug_name), "line of business" (→ line_of_business), "product category" (→ product_category), "pharmacy type" (→ pharmacy_type), "brand vs generic" (→ brand_vs_generic_ind), "states" (→ state_cd), "carriers" (→ carrier_id)

**Metrics:** "revenue" (→ revenue_amt), "cost" or "expenses" (→ expense_amt), "scripts" or "script volume" (→ unadjusted_script_count), "revenue per script" or "rate" (→ revenue_per_script), "cost per script" (→ expense_amt/unadjusted_script_count), "margin" (→ gross profit)

**Verify all dimensions and metrics exist in metadata before suggesting.**

# Time Period Preservation

- Extract time from current question: "Q3 2024", "September 2024", "last two months"
- Apply SAME time to ALL follow-ups unless suggesting comparisons
- For comparisons: "Compare Q3 2024 vs Q3 2023"
- NEVER omit time context

# Investigation Flow

**Follow Playbook Sequence:**
- Use `recommended_investigation_flow` or `investigation_sequence` from metadata
- Progress through levels systematically (don't skip or jump randomly)
- Apply `pattern_recognition` guidance based on last answer

**Analyze Last Answer:**
- Patterns: concentration vs dispersed, top drivers identified
- Metrics: which moved (rate/volume/cost/margin)
- Stage: early/mid/mature investigation

**Question Distribution:**
- 2 questions: Current depth (explore different dimensions)
- 1 question: Next level (drill deeper or pivot to complementary)

**If high concentration (top 5-10 = >70%):** Drill into specific entities
**If dispersed pattern:** Suggest segment aggregations or pivot
**If investigation mature:** Pivot to complementary table

# Complementary Table

**When metadata has `complementary_table`:**
- Generate from BOTH primary and complementary tables
- Use complementary table's dimensions/metrics

**Question Split by Stage:**
- Early: 3 primary
- Mid: 2 primary + 1 complementary
- Mature: 1 primary + 2 complementary

**Pivot Format:**
"Show [metric] by [complementary dimension] in [complementary table] for [same time]"

Example: "Show revenue by clients in claims for Q3 2024"

# Entity References

**Use specific values ONLY when narrative includes attribute context:**
✅ "Client MDOVA", "Drug MOUNJARO", "Line of Business Commercial"
✅ "Show revenue for Client MDOVA by therapy classes in Q3 2024"

**Use generic dimensions when:**
❌ Narrative has isolated values: "MDOVA" without "Client"
❌ Unclear which column value belongs to
→ Use "by clients" instead

# Domain Product Filtering

- **PBM Network:** Only PBM categories, NEVER Home Delivery/Specialty
- **Optum Pharmacy:** Only Home Delivery/Specialty, NEVER PBM

# NEVER Generate (Critical Avoidance)

❌ Why/because: "Why did revenue decline?", "What caused variance?"
❌ Drill-through: "Show details", "Drill into this"
❌ Vague: "Dig deeper", "Analyze further", "Investigate"
❌ Causal: "What's driving?", "What factors contributed?"
❌ Incomplete: Missing metric, dimension, or time

✅ ONLY Generate: Observable fact questions with complete structure

# Constraints

- Check `questions_history` - avoid duplicates or semantically similar
- Use "top 20" or "bottom 20" (not top 5 or 10)
- Preserve scope: time, filters, dimensional focus
- Verify dimensions/metrics exist in metadata
- Advance investigation, don't restate

==============================
RESPONSE FORMAT
==============================
Exactly 3 questions. Valid JSON only. No markdown or extra text.

{{
    "followup_questions": [
        "Show [metric] by [dimension] for [time]",
        "What is the [metric] by [dimension] for [time]",
        "Break down [metric] by [dimension] for [time]"
    ]
}}

==============================
EXAMPLES
==============================

**Early Stage:**
Current: "What is revenue for Q3 2024?"
{{
    "followup_questions": [
        "Show revenue by product category for Q3 2024",
        "Break down revenue by line of business for Q3 2024",
        "What is the revenue per script by product category for Q3 2024"
    ]
}}

**Mid Stage (Concentration Found):**
Current: "Show revenue by clients for Q3 2024"
Discovered: Top 5 clients = 75% of decline
{{
    "followup_questions": [
        "Show revenue by therapy classes for top 5 clients in Q3 2024",
        "Break down scripts by clients for Q3 2024",
        "What is the revenue by clients in claims for Q3 2024"
    ]
}}

**Mature Stage (Pivot to Complementary):**
Current: "Break down revenue variance by product category for Q3 2024"
Discovered: Specialty has largest variance
{{
    "followup_questions": [
        "Show revenue by clients in claims for Specialty in Q3 2024",
        "Break down revenue by therapy classes in claims for Q3 2024",
        "What is the brand vs generic mix in claims for Q3 2024"
    ]
}}

"""

{
    "prd_optumrx_orxfdmprdsa.rag.ledger_actual_vs_forecast": {
        "table_name": "prd_optumrx_orxfdmprdsa.rag.ledger_actual_vs_forecast",
        "playbook": {
            "core_principles": "Stay in ledger first before pivoting to claims. Break by product_category (PBM/Home Delivery/Specialty) for headline metrics. Preserve scope from user's question (LOB, product, time). Use executable verbs: Show/Break/List/Compare. Focus on observable facts, not why/because questions.",
            
            "revenue_analysis": "When Revenues moves, check volume (Unadjusted Scripts) vs rate (Revenue_per_Script_Unadj) separately. Decompose via rate/volume/mix variance at product or LOB level. Rate drivers: product_category mix shifts (Specialty highest rate), line_of_business differences, product_sub_category changes. Volume drivers: LOB volume trends (E&I vs Medicare vs External), product_category shifts (PBM vs HDP vs Specialty), sub-category changes. Mix drivers: product hierarchy redistribution, LOB mix changes. Always break by product_category first, then drill to product_sub_category_lvl_1 if concentrated. Use top/bottom analysis by LOB or product.",
            
            "cost_analysis": "When COGS Post Reclass moves, check cost rate (Cost_per_Script_Unadj) then script volume impact. Break by product_category as Specialty has highest cost per script, followed by Home Delivery, then PBM. Drill to product_sub_category_lvl_1 to identify channel drivers (Core Specialty vs Infusion vs Core HDP vs Core PBM vs Community Pharmacies). Compare line_of_business cost patterns as different LOBs have different product mixes. Investigate product_sub_category_lvl_2 for detailed channel cost when variance concentrated. If cost per script rising uniformly, pivot to claims for pharmacy_type (internal vs external) and brand/generic mix analysis not available in ledger.",
            
            "margin_analysis": "When Gross Profit Post Reclass, Gross Profit Pre Reclass, or IOI moves, decompose into revenue and cost components separately. Show Revenues and COGS Post Reclass side by side to identify if margin pressure from revenue decline, cost increase, or both. Calculate margin rate metrics (Margin_per_Script_Unadj, IOI_per_Script_Unadj) for per-unit profitability trends. Break by product_category as each has different margin profiles. Compare line_of_business margin trends (E&I FI vs E&I ASO vs PDP vs MAPD vs C&S) to identify segment compression. If Operating Earnings declining, check SG&A Post Reclass to see if operating expenses increasing beyond gross margin issues.",
            
            "script_volume_analysis": "When Unadjusted Scripts, 30 Day Scripts, or 90 Day Scripts moves, compare 30 Day vs 90 Day trends to check supply days mix shifting (retail to mail order or vice versa) - note shift from 30-day to 90-day reduces script count but may be volume-neutral. Break by product_category to identify if volume change concentrated in PBM, Home Delivery, or Specialty. Compare line_of_business script trends (E&I vs Medicare Advantage vs PDP vs C&S vs External). Drill to product_sub_category_lvl_1 if variance concentrated. If Total Membership available, show membership trend alongside scripts to calculate scripts per member proxy and understand if volume decline due to membership loss or utilization decline. Offer YoY same-month comparison for seasonal context.",
            
            "forecast_variance_analysis": "When comparing Actuals (GAAP) vs Budget or forecast cycle (8+4, 5+7, 2+10), ALWAYS include GROUP BY metric_type since amount_or_count represents different metrics based on metric_type dimension. Rank metric_type by absolute variance to identify which metrics missed or beat expectations (Revenues, COGS, Scripts, Margins). Break down largest variance metric by product_category and line_of_business for segment attribution. Show month-by-month actual vs forecast trend to check if variance accelerating or one-time event. Compare Budget vs 8+4 vs 5+7 vs 2+10 Forecast vs Actuals progression to understand expectation evolution (2+10 most recent forecast). For Revenues or Scripts variances, decompose into volume and rate components at product or LOB level. Investigation sequence: (1) metric_type identification and ranking, (2) product_category attribution, (3) line_of_business breakdown, (4) time pattern analysis, (5) volume vs rate decomposition, (6) forecast cycle comparison. CRITICAL: Claims table has NO forecast/budget data - only actuals. Pivot to claims to analyze actuals at granular level (client, therapy, drug, pharmacy, brand/generic) to understand WHAT happened in actuals that differed from forecast assumptions.",
            
            "pattern_recognition": "Rate up + volume down: check Total Membership trend as membership proxy, examine Cost_per_Script to see if cost also increasing (margin may be stable despite volume decline), break by product_category to identify pattern. Both rate and volume declining: show top/bottom line_of_business or product_category contributions for concentrated drivers, show daily or weekly trend for timing patterns, identify specific product_sub_category_lvl_1 driving both declines. Mix variance large: focus on product_category or product_sub_category_lvl_1 redistribution, compare current vs prior period product mix percentages. Margin compressing: decompose into revenue decline vs cost increase, show which product_category has highest margin pressure, check if Operating_Expenses_Percent also increasing.",
            
            "investigation_sequence": "Drill from product_category (PBM/Home Delivery/Specialty) to product_sub_category_lvl_1 (Core PBM, Community Pharmacies, Core HDP, Core Specialty, Other Products, RVOH, Hospice, Workers Comp) to product_sub_category_lvl_2 when concentrated drivers found. For line_of_business, use abbreviated codes (E&I FI, E&I ASO, C&S, PDP, MAPD, E&I UMR, External). Preserve scope already in user's question. Use top/bottom N analysis. Calculate concentration: top 5 entities account for >70% of variance.",
            
            "pivot_to_claims_guidance": "Pivot to claims when variance concentrated in specific product_category (>70%) and need client/pharmacy/therapy granularity not in ledger. When rate variance requires brand/generic mix (GDR), therapy class composition, or pharmacy channel (internal vs external) investigation. When volume variance needs client-level attribution, claim status/quality investigation, or therapy class trends. When cost variance needs drug-level pricing (wac_amount, awp_cost_amount), brand/generic cost differences, or pharmacy type cost analysis. When need to validate if patterns driven by client concentration, therapy mix shifts, or operational factors. Do not imply join - frame as complementary views for same conceptual scope and time period."
        },
        
        "dimensions": [
            {
                "field_name": "ledger",
                "description": "Ledger type: Actuals (GAAP), Budget, or forecast cycle. Default to Actuals (GAAP) if not specified.",
                "distinct_values": ["Actuals (GAAP)", "Budget", "8+4 Forecast", "5+7 Forecast", "2+10 Forecast"]
            },
            {
                "field_name": "metric_type",
                "description": "Financial and operational metrics. ALWAYS use GROUP BY on this column for actuals vs forecast vs budget comparisons.",
                "distinct_values": ["COGS Post Reclass", "SG&A Post Reclass", "IOI", "Revenues", "90 Day Scripts", "Unadjusted Scripts", "Total Membership"]
            },
            {
                "field_name": "line_of_business",
                "description": "Line of business identifier.",
                "distinct_values": ["E&I FI", "E&I ASO", "C&S", "PDP", "MAPD", "E&I UMR", "External"]
            },
            {
                "field_name": "product_category",
                "description": "Category of product or service.",
                "distinct_values": ["PBM", "Home Delivery", "Specialty"]
            },
            {
                "field_name": "product_sub_category_lvl_1",
                "description": "First-level subcategory under product_category.",
                "distinct_values": ["Home Delivery", "Specialty", "Core PBM", "Other Products", "Community Pharmacies", "RVOH", "Hospice", "Workers Comp"]
            },
            {
                "field_name": "product_sub_category_lvl_2",
                "description": "Second-level subcategory for more granularity.",
                "distinct_values": ["divvyDOSE", "Retail Other", "GPO", "Optum Store", "Infusion", "Core HDP", "CP Core", "Core Specialty", "Prior Auth", "Distribution", "Frontier", "PharmScript", "Retail", "Prevention", "CPS Solutions", "Nuvaila", "Admin Fees", "Optum Perks", "Other Products"]
            }
        ],
        
        "metrics": [
            {
                "field_name": "amount_or_count",
                "description": "Contains either amount or count values for each metric type. Must not be aggregated without appropriate filters or grouping by metric_type."
            },
            {
                "field_name": "rate or revenue per script",
                "description": "Contains revenue per script metric."
            },
            {
                "field_name": "rate_variance",
                "description": "Derived metric: (Prior Month Avg Rate - Current Month Avg Rate) × Current Month Volume",
                "is_derived": true
            },
            {
                "field_name": "volume_variance",
                "description": "Derived metric: (Prior Month Volume - Current Month Volume) × Current Rate",
                "is_derived": true
            },
            {
                "field_name": "mix_variance",
                "description": "Derived metric: Prior Month Revenue - Current Month Revenue - Rate Variance - Volume Variance",
                "is_derived": true
            }
        ],
        
        "complementary_table": {
            "table_name": "prd_optumrx_orxfdmprdsa.rag.pharmacy_claims",
            "relationship": "complementary",
            "when_to_pivot": "Variance >70% concentrated in one product_category OR need client/therapy/drug/pharmacy_type granularity OR investigating brand/generic mix (GDR) OR drug-level pricing analysis (wac_amount, awp_cost_amount) OR therapy class drivers OR client attribution not available in ledger.",
            
            "investigation_approach": {
                "sequence": "client_name → therapy_class_name → drug_name → brand_vs_generic_ind → pharmacy_type → state_cd/demographics",
                "level_1": "Show top 10 clients by delta revenue/scripts. Calculate rate/volume/mix variance by client. Check if top 5-10 clients account for >70% of variance.",
                "level_2": "Investigate therapy_class_name drivers. List therapies by revenue contribution, delta revenue, delta rate. Check if specialty categories (Oncology, GLP-1) driving variance.",
                "level_3": "For high-impact therapies, drill into drug_name. Show top drugs by volume and revenue. Examine pricing trends (wac_amount, awp_cost_amount).",
                "level_4": "Check brand_vs_generic_ind mix impact. Calculate GDR_Ratio (Generic Dispense Rate) trend. Show if brand penetration increasing (GDR declining) which drives rate up and cost up.",
                "level_5": "Compare pharmacy_type (Internal Optum Owned vs External) for revenue, scripts, rate, and cost per script. Calculate internal capture rate trend.",
                "flexibility": "If ledger already identified product pattern, start at therapy level. If client scoped in question, start at therapy or brand/generic level."
            },
            
            "key_analyses": {
                "revenue_deep_dive": "Calculate rate/volume/mix variance at client_name level for same time period. Show revenue_per_script trends by top clients. Investigate brand_vs_generic_ind mix shift via GDR_Ratio. List therapy_class_name by revenue change and rate change. Check if GLP-1, Oncology, or specialty therapies growing. Compare pharmacy_type revenue and rate trends.",
                "cost_deep_dive": "Show wac_amount and awp_cost_amount trends to identify drug pricing pressure. Calculate average expense_amt per script trend. Check brand_vs_generic_ind mix via GDR_Ratio - declining GDR increases cost. Show cost per script difference between Brand vs Generic. List therapy_class_name by average expense per script. Compare pharmacy_type costs (Internal vs External typically higher).",
                "volume_deep_dive": "Check claim_status_code distribution (P=Paid, X=Reversed) for net activity. Calculate reversal rate (X/P) trend. Show daily unadjusted_script_count pattern for anomalies. List top clients by script volume decline. Break by line_of_business, therapy_class_name, state_cd for patterns.",
                "concentration_analysis": "Show top 10 clients by revenue contribution and delta. List top 10 therapy_class_name by scripts and delta. Calculate if top 5 account for >70% variance. When high concentration: drill deeper into those entities (therapy mix, GDR, pharmacy type, account_id/group_id). When dispersed: re-anchor to ledger for segment-level patterns."
            },
            
            "context_preservation": "Preserve time period, LOB, and product scope from ledger query. Always use claim_status_code P and X for net analysis. Frame as validation - claims should explain ledger variance. No join implied - complementary views tell consistent story for same conceptual scope.",
            
            "key_dimensions": ["client_name", "client_type", "therapy_class_name", "drug_name", "brand_vs_generic_ind", "pharmacy_type", "state_cd", "carrier_id", "account_id", "group_id", "line_of_business"],
            
            "key_metrics": ["revenue_amt", "expense_amt", "unadjusted_script_count", "revenue_per_script", "wac_amount", "awp_cost_amount", "rate_variance", "volume_variance", "mix_variance", "GDR_Ratio"]
        }
    }
}


"recommended_investigation_flow": {
    "description": "Progressive drill-down: client_name → carrier_id → therapy_class_name → drug detail → brand_vs_generic_ind → claim_status_code → demographics",
    "level_1_client": "Show top 10 clients by revenue and delta. Calculate variance components by client. Check if top 5-10 clients account for >70% of variance.",
    "level_2_carrier": "If client concentration high, examine carrier_id patterns across high-variance clients.",
    "level_3_therapy_class": "Show therapy classes by revenue, delta revenue, delta rate. Identify specialty categories (Oncology, GLP-1) driving variance.",
    "level_4_drug_detail": "For high-impact therapies, drill into specific drugs. Show volume, revenue, and pricing trends (wac_amount, awp_cost_amount).",
    "level_5_brand_generic": "Check brand_vs_generic_ind mix. Calculate GDR trend. Quantify brand vs generic revenue and cost impact.",
    "level_6_claim_status": "Verify claim_status_code patterns. Calculate reversal rate (X/P ratio). Use P and X together for net analysis.",
    "level_7_demographics": "If variance unexplained, examine mbr_sex and age cohorts from mbr_dt_of_brth for demographic patterns.",
    "flexibility_note": "Adapt sequence based on context. If ledger identified product pattern, start at therapy level. If client scoped, start at therapy or brand/generic."
},

"core_principles": "Deepen drivers using available dimensions. Use top/bottom N for concentration. Show trends when clarifying. Preserve scope from prior queries. Focus on observable facts with executable verbs: Show/Break/List/Compare.",

"revenue_analysis": "Check volume (unadjusted_script_count) vs rate (revenue_per_script). Decompose variance by client or therapy. If rate dominates: check brand_vs_generic_ind, therapy rates, pharmacy_type. If volume dominates: break by client, therapy, LOB, state. If mix dominates: check GDR, therapy mix, client mix. Identify top 10 drivers and concentration (top 5 >70%).",

"cost_analysis": "Show wac_amount and awp_cost_amount trends. Check brand_vs_generic_ind mix and GDR. Show therapy_class_name by cost per script. Compare pharmacy_type costs (Internal vs External). Identify high-cost therapy volume growth.",

"script_volume_analysis": "Compare 30_days vs 90_days script mix. Check claim_status_code distribution (P vs X). Calculate reversal rate. Break by LOB, client, therapy, state, and pharmacy_type.",

"variance_decomposition": "Calculate rate, volume, mix variance. Perform at client, therapy, pharmacy_type, or state level. Focus follow-ups based on dominant component (>50%).",

"pattern_recognition": "Rate up + volume down: check GDR shift, membership trend, client concentration. Both declining: focus top clients, brand shift, therapy impact. Volume down + rate stable: check 30/90-day mix, reversal rate, client/therapy trends. Cost up: check pricing (wac/awp), GDR decline, specialty growth, pharmacy_type costs.",

"concentration_tactics": "Show top 10 entities by revenue and delta. Calculate if top 5 account for >70% variance. If concentrated: drill specific entities. If dispersed: re-anchor to ledger for segment patterns."
