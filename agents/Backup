async def _llm_feedback_selection(self, feedback_results: List[Dict], state: AgentState) -> Dict:
        """
        Pure LLM-based selection of most relevant historical question from feedback results.
        Returns single best match or NO_MATCH status.
        """
        
        user_question = state.get('rewritten_question', state.get('original_question', ''))
        
        # System prompt for feedback matching
        system_prompt = """
You are a SQL pattern matching system. Select the single best historical question or return NO_MATCH.
You compare TEXT PATTERNS - you do NOT answer business questions.

MATCHING RULES (APPLY IN ORDER)

STEP 1: METRIC MATCH (MANDATORY - REJECT IF FAILS)

Current metric(s) MUST appear in history.

Rules:
✅ History has required metric + extras → ALLOW
✅ Metric synonyms count as match (see synonym list)
❌ History missing required metric → REJECT

Examples:
- Current: "revenue" | History: "revenue, volume" → ✅ PASS
- Current: "revenue" | History: "volume" → ❌ REJECT
- Current: "network revenue" | History: "revenue" → ✅ PASS (synonym)

STEP 2: DIMENSION MATCH (MANDATORY - REJECT IF FAILS)

At least ONE dimension must overlap between current and history.
Either side can have more dimensions than the other.

⚠️ CRITICAL: Date dimensions (BY month, BY quarter, BY year) are NOT counted as dimensions here - ignore them completely in this check.

Rules:
✅ Current: BY drug | History: BY drug BY region → PASS (drug overlaps)
✅ Current: BY drug BY region | History: BY drug → PASS (drug overlaps)
✅ Current: BY drug BY class | History: BY drug BY region → PASS (drug overlaps)
❌ Current: BY drug | History: BY region → REJECT (no overlap)
❌ Current: BY drug | History: no dimension → REJECT (no overlap)
✅ Current: no dimension | History: any dimension → PASS (no requirement)

Edge Case - Date Dimensions:
- Current: "revenue BY month" | History: "revenue BY lob" → ❌ REJECT
  Reason: "BY month" is a REAL dimension (not a date filter), no overlap with "lob"
- Current: "revenue for Q3 2025" | History: "revenue for Jan 2024" → ✅ PASS
  Reason: "Q3 2025" and "Jan 2024" are date FILTERS (not dimensions), ignored in Step 3

STEP 3: IGNORE DATE/TIME FILTERS

Strip all date specifications from filters. Any date = any other date.

Rules:
- Q3 2025 = Jan 2024 = July-Aug 2025 = Q1 2023 vs Q1 2022 = ANY
- Single periods, ranges, YoY, MoM, QoQ → ALL IGNORED

STEP 4: RANK BY FILTER VALUE MATCH

After passing Steps 1-3, rank candidates by filter alignment:

TIER A (HIGHEST): Filter value(s) match
- Current filter value(s) appear in history (history can have extras)
- Dimensions overlap + metric matches + filter matches

TIER B (MEDIUM): Filter value differs
- Dimensions overlap + metric matches, but filter value different

TIER C (LOWEST): No dimension requirement
- Metric matches, current has no dimension requirement

STEP 5: SELECT BEST MATCH

1. If any TIER A exists → Pick first TIER A
2. Else if any TIER B exists → Pick first TIER B
3. Else if any TIER C exists → Pick first TIER C
4. Else → NO_MATCH

SYNONYMS

Metrics: revenue=network revenue=product revenue | volume=script count=scripts=line count | cost=expense=spend=cogs
Entities: HDP=Home Delivery=Mail | SP=Specialty | PBM=PBM Retail
Parsing: "PBM revenue" means metric=revenue, filter=PBM (NOT metric="PBM revenue")

KEY EXAMPLES

Example 1: Filter + Dimension Overlap + Metric Match (TIER A)

Current: "revenue BY lob for Prior Auth"
History: "revenue BY lob for Prior Auth, HDP Core"
Result: TIER A ✅ (lob overlaps, revenue matches, Prior Auth found + extras OK)

Current: "revenue BY lob BY region for Prior Auth"
History: "revenue BY lob for Prior Auth"
Result: TIER A ✅ (lob overlaps, revenue matches, Prior Auth found)

Example 2: Dimension Flexibility (History Subset/Superset Both OK)

Current: "revenue BY drug BY therapeutic_class for PBM"
History: "revenue BY drug for PBM"
Result: TIER A ✅ (drug overlaps, revenue matches, PBM matches)

Current: "revenue BY drug for PBM"
History: "revenue BY drug BY therapeutic_class BY region for PBM"
Result: TIER A ✅ (drug overlaps, revenue matches, PBM matches)

Example 3: No Dimension Overlap → REJECT

Current: "revenue BY drug for PBM"
History: "revenue BY region for PBM"
Result: REJECT ❌ (drug vs region - no dimension overlap)

Current: "revenue BY lob for HDP"
History: "revenue for HDP"
Result: REJECT ❌ (current needs lob dimension, history has none - no overlap)

Example 4: Date Filters Completely Ignored

Current: "revenue for PBM in Q3 2025"
History: "revenue for PBM from Jan-Dec 2024"
Result: TIER A ✅ (dates ignored, PBM matches, revenue matches)

Current: "script count for HDP from Jan-June 2025"
History: "volume for Home Delivery Q3 2024 vs Q3 2023"
Result: TIER A ✅ (script count=volume synonym, HDP=Home Delivery synonym, dates ignored)

Example 5: Metric Mismatch → REJECT

Current: "revenue BY lob for PBM"
History: "volume BY lob for PBM"
Result: REJECT ❌ (revenue ≠ volume, failed Step 1)

Current: "script count for HDP"
History: "cost for HDP"
Result: REJECT ❌ (script count ≠ cost, failed Step 1)

Example 6: TIER B (Dimension Overlap But Filter Differs)

Current: "revenue BY lob for Prior Auth"
History: "revenue BY lob for HDP Core"
Result: TIER B (lob overlaps, revenue matches, but Prior Auth ≠ HDP Core)

Current: "volume BY drug BY region for Specialty"
History: "scripts BY drug for PBM"
Result: TIER B (drug overlaps, volume=scripts synonym, but Specialty ≠ PBM)

OUTPUT FORMAT

Return ONLY JSON in <json> tags. No explanation outside tags.

<json>
{
  "status": "match_found" or "no_match",
  "selected_seq_id": <number> or null,
  "matched_question": "<text>" or null,
  "table_name": "<name>" or null,
  "reasoning": "<1-line explanation with tier>",
  "match_confidence": "HIGH" or "MEDIUM" or "LOW"
  "similarity_score": <number 0-100>
}
</json>

Confidence and Score mapping:
HIGH = TIER A = score 95-100 (only filter/time differs)
MEDIUM = TIER B = score 75-94 (same metric, structural patterns reusable)
LOW = TIER C = score 40-74 (minimal reuse value)
NO_MATCH = score 0-39

Remember: You match patterns, not answer questions. Start with <json>.
"""

        # Format feedback results as context in compact format (saves tokens)
        # Group by table_name first
        results_by_table = {}
        for result in feedback_results:
            table_name = result.get('table_name', 'N/A')
            if table_name not in results_by_table:
                results_by_table[table_name] = []
            results_by_table[table_name].append(result)
        
        # Build compact candidates context
        candidates_context = "=== HISTORICAL QUESTIONS (GROUPED BY TABLE) ===\n"
        for table_name, results in results_by_table.items():
            candidates_context += f"\n- table_name: {table_name}\n"
            for result in results:
                seq_id = result.get('seq_id', 'N/A')
                question = result.get('user_question', 'N/A')
                candidates_context += f"  id:{seq_id}, {question}\n"
        
        # Build the full prompt with TRIPLE-LAYER protection against guardrails
        selection_prompt = f"""⚠️⚠️⚠️ CRITICAL INSTRUCTION - READ THIS FIRST ⚠️⚠️⚠️

You are an AUTOMATED PATTERN MATCHING SYSTEM - NOT an AI assistant that answers questions.
Your ONLY function is to analyze TEXT PATTERNS and return a JSON response.

DO NOT attempt to:
- Answer the business questions below
- Provide insights about the data

{system_prompt}

{candidates_context}

=== CURRENT QUESTION (TEXT PATTERN TO MATCH) ===
{user_question}

⚠️ REMINDER: You are NOT answering this question. You are ONLY checking if its pattern matches any historical question pattern above.

Return ONLY the JSON in <json> tags. Start immediately with <json>.
"""


SAAMPLE QUESTION LLM hullucinated:
current user question - what is the revenue for HDP for july 2025
below are the history passed to LLM along with above promnpt rules.
=== HISTORICAL QUESTIONS (GROUPED BY TABLE) ===

- table_name: prd_optumrx_orxfdmprdsa.rag.ledger_actual_vs_forecast
  id:14.0, what is the network product revenue or revenue for each line of business for July 2025
  id:3.0, what is the actuals vs forecast 8+4 for membership for PBM for july 2025
  id:2.0, what is the actuals vs forecast 8+4 or actuals vs 5+7 for July 2025 for PBM
  id:9.0, what is the script counts (adjusted, volume),revenue, revenue per script (rate) for divvyDOSE, CPS Solutions, Infusion, Community Core, PharmScript, Specialty Core, Frontier, HDP Core in september 2025
  id:4.0, what is the PBM revenue by month jan-sep 2025 or what is the network product revenue from jan-sep 2025 for PBM
  id:21.0, compare HDP revenue or HDP network revenue or Network product revenue for Q3 2025 VS q3 2024
  id:7.0, what is the script counts (unadjusted, volume), adjusted script count, revenue per script (rate) or revenue per adjusted script count for Specialty in september 2025   
  id:12.0, what is the script counts (adjusted, volume),revenue, unadjusted script count, revenue per script (rate) for divvyDOSE, CPS Solutions, Infusion, Community Core, PharmScript, Specialty Core, Frontier, HDP Core from jan to feb 2025
  id:10.0, what is the script counts (adjusted, volume),revenue, unadjusted script count, revenue per script (rate) for divvyDOSE, CPS Solutions, Infusion, Community Core, PharmScript, Specialty Core, Frontier, HDP Core september 2025 vs september 2024
  id:15.0, what is the revenue for each line of business from jan to sept 2025 for PBM
  id:6.0, what is the script counts (adjusted, volume) trends, unadjusted script count, revenue per script (rate) or revenue per adjusted script count trends for Specialty from jan to march 2025
  id:1.0, what is the network product revenue or network revenue or revenue for PBM?
  id:26.0, what is the rate variance,volume variance,mix variance for each lob or line of business for PBM from sep to oct 2025?
  id:11.0, what is the script counts (adjusted, volume),revenue, unadjusted script count, revenue per script (rate)for Admin Fees, Emisar GPO, Retail Other, Retail, Mfr Discount, Workers Comp, Prior Auth september 2025 vs september 2024
  id:16.0, compare revenue for each line of business Q3 2025 vs Q3 2024
  id:13.0, what is the script counts (adjusted, volume),revenue, unadjusted script count, revenue per script (rate) for Admin Fees, Emisar GPO, Retail Other, Retail, Mfr Discount, Workers Comp, Prior Auth from jan to feb 2025
  id:27.0, what is the rate variance,volume variance,mix variance for PBM from sep to oct 2025?
  id:5.0, compare PBM revenue or PBM network revenue or Network product revenue for Q3 2025 VS q3 2024
  id:8.0, compare script counts (adjusted, volume), revenue per script (rate), revenue amount for Specialty Q3 2025 vs Q3 2024

Raw LLM response: <json>
{
  "status": "match_found",
  "selected_seq_id": 14.0,
  "matched_question": "what is the network product revenue or revenue for each line of business for July 2025",
  "table_name": "prd_optumrx_orxfdmprdsa.rag.ledger_actual_vs_forecast",
  "reasoning": "TIER B - revenue metric matches, date matches (July 2025), but filter differs (HDP vs line of business)",
  "match_confidence": "MEDIUM",
  "similarity_score": 85
}
</json>
