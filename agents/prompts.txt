import json
from typing import Any, Dict

def migrate_session_tracking_data(db_client):
    """
    Migrate data from old fdmbotsession_tracking table to new fdmbotsession_tracking_updt table.
    Process session by session to handle multiple rows per session.
    
    Args:
        db_client: Database client with execute_sql method
    """
    try:
        # Table name mapping for dataset detection
        TABLE_MAPPING = {
            "prd_optumrx_orxfdmprdsa.rag.ledger_actual_vs_forecast": "Peoplesoft GL",
            "prd_optumrx_orxfdmprdsa.rag.pbm_claims": "Rx Claims",
            "prd_optumrx_orxfdmprdsa.rag.claim_billing": "CBS Billing",
            "prd_optumrx_orxfdmprdsa.rag.pharmacy_claims": "Pharmacy IRIS Claims"
        }
        
        # Step 1: Get all unique session_ids from old table
        print("üîç Fetching unique session IDs from old table...")
        session_query = """
        SELECT DISTINCT session_id 
        FROM prd_optumrx_orxfdmprdsa.rag.fdmbotsession_tracking
        ORDER BY session_id
        """
        session_results = db_client.execute_sql(session_query)
        
        if not session_results or not session_results.get('data'):
            print("‚ö†Ô∏è No sessions found in old table")
            return
        
        session_ids = [row['session_id'] for row in session_results['data']]
        total_sessions = len(session_ids)
        print(f"üìä Found {total_sessions} unique sessions to migrate")
        
        # Step 2: Process each session
        success_count = 0
        error_count = 0
        total_rows_migrated = 0
        
        for idx, session_id in enumerate(session_ids, 1):
            print(f"\n{'='*80}")
            print(f"üîÑ Processing session {idx}/{total_sessions}: {session_id}")
            
            try:
                # Fetch all rows for this session from old table
                fetch_query = f"""
                SELECT session_id, user_id, user_question, state_info, insert_ts
                FROM prd_optumrx_orxfdmprdsa.rag.fdmbotsession_tracking
                WHERE session_id = '{session_id}'
                ORDER BY insert_ts ASC
                """
                
                rows_result = db_client.execute_sql(fetch_query)
                
                if not rows_result or not rows_result.get('data'):
                    print(f"‚ö†Ô∏è No rows found for session {session_id}")
                    continue
                
                rows = rows_result['data']
                print(f"   Found {len(rows)} rows for this session")
                
                # Process each row in the session
                for row_idx, row in enumerate(rows, 1):
                    try:
                        session_id_val = row.get('session_id', '')
                        user_id = row.get('user_id', '')
                        user_question = row.get('user_question', '')
                        state_info = row.get('state_info', '')
                        insert_ts = row.get('insert_ts', '')
                        
                        print(f"   Row {row_idx}: {user_question[:50]}...")
                        
                        # Skip if no state_info
                        if not state_info or not state_info.strip():
                            print(f"      ‚ö†Ô∏è No state_info, skipping")
                            continue
                        
                        # Clean the state_info JSON
                        cleaned_json = state_info.strip()
                        
                        # Remove triple quotes if present
                        if cleaned_json.startswith('"""') and cleaned_json.endswith('"""'):
                            cleaned_json = cleaned_json[3:-3]
                        
                        # Remove outer quotes if it's a quoted string
                        if cleaned_json.startswith('"') and cleaned_json.endswith('"'):
                            try:
                                cleaned_json = json.loads(cleaned_json)
                            except:
                                pass
                        
                        # Clean: remove newlines and escape single quotes for SQL insert
                        sql_info_escaped = str(cleaned_json).replace("'", "\\'").replace("\n", " ")
                        
                        # Parse to dict to extract sql_query for dataset detection
                        try:
                            if isinstance(cleaned_json, str):
                                state_dict = json.loads(cleaned_json)
                            else:
                                state_dict = cleaned_json
                        except json.JSONDecodeError as e:
                            print(f"      ‚ö†Ô∏è JSON parse error: {e}, using empty dict")
                            state_dict = {}
                        
                        # Determine selected_dataset by checking sql_query
                        selected_dataset = ""
                        sql_query = state_dict.get('sql_query', '') if isinstance(state_dict, dict) else ''
                        
                        if sql_query:
                            found_datasets = []
                            for table_name, dataset_name in TABLE_MAPPING.items():
                                if table_name in sql_query:
                                    found_datasets.append(dataset_name)
                            
                            selected_dataset = ', '.join(found_datasets) if found_datasets else ''
                        
                        print(f"      üìä Dataset: '{selected_dataset}'")
                        
                        # Escape values for SQL insert
                        user_question_escaped = user_question.replace("'", "\\'")
                        selected_dataset_escaped = selected_dataset.replace("'", "\\'")
                        
                        # Insert into new table
                        insert_sql = f"""
                        INSERT INTO prd_optumrx_orxfdmprdsa.rag.fdmbotsession_tracking_updt
                            (session_id, user_id, user_question, selected_dataset, sql_info, insert_ts)
                        VALUES
                            ('{session_id_val}', '{user_id}', '{user_question_escaped}', 
                             '{selected_dataset_escaped}', '{sql_info_escaped}', '{insert_ts}')
                        """
                        
                        db_client.execute_sql(insert_sql)
                        print(f"      ‚úÖ Row {row_idx} migrated successfully")
                        total_rows_migrated += 1
                        
                    except Exception as row_error:
                        print(f"      ‚ùå Error migrating row {row_idx}: {row_error}")
                        error_count += 1
                        continue
                
                success_count += 1
                print(f"‚úÖ Session {session_id} completed")
                
            except Exception as session_error:
                print(f"‚ùå Error processing session {session_id}: {session_error}")
                error_count += 1
                continue
        
        # Summary
        print(f"\n{'='*80}")
        print(f"üéâ MIGRATION COMPLETE")
        print(f"   Total sessions processed: {total_sessions}")
        print(f"   Successful sessions: {success_count}")
        print(f"   Failed sessions: {error_count}")
        print(f"   Total rows migrated: {total_rows_migrated}")
        print(f"{'='*80}")
        
    except Exception as e:
        print(f"‚ùå Migration failed: {e}")
        import traceback
        traceback.print_exc()


# Usage in Databricks notebook:
# migrate_session_tracking_data(db_client)
