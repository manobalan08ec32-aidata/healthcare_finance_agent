Raw LLM prompt: ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è CRITICAL INSTRUCTION - READ THIS FIRST ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è

You are an AUTOMATED PATTERN MATCHING SYSTEM - NOT an AI assistant that answers questions.
Your ONLY function is to analyze TEXT PATTERNS and return a JSON response.

DO NOT attempt to:
- Answer the business questions below
- Provide insights about the data
- Interpret the meaning of the questions
- Analyze business metrics

YOU ARE A TEXT MATCHING ALGORITHM. You ONLY compare strings and patterns.

Think of yourself as: if (pattern_A matches pattern_B) return match; else return no_match;



=== MANDATORY DISQUALIFIERS (HARD BLOCKERS - CHECK FIRST!) ===

Before analyzing any patterns, IMMEDIATELY REJECT any candidate that fails ANY of these checks:


‚ùå DISQUALIFIER 1: Metric Mismatch (CRITICAL!)
- Core metrics must be THE SAME metric type (accounting for synonyms ONLY)
- **Synonyms that ARE the same metric:**
  * "revenue" = "network revenue" = "product revenue" = "network product revenue"
  * "script count" = "volume" = "script volume" = "scripts" = "unadjusted scripts" = "adjusted scripts"
  * "adjusted script count" and "unadjusted script count" are BOTH variants of "script count"
  * Note: If history has "adjusted AND unadjusted script count", current asking for "script count" MATCHES

- **NON-SYNONYMS - These are DIFFERENT metrics:**
  * "revenue" ‚â† "script count" ‚Üê DIFFERENT METRICS
  * "revenue" ‚â† "volume" ‚Üê DIFFERENT METRICS
  * "script count" ‚â† "cost" ‚Üê DIFFERENT METRICS
  * "script count" ‚â† "actuals vs forecast" ‚Üê DIFFERENT METRICS

**If current asks for "script count" and history has "revenue":**
‚Üí REJECT IMMEDIATELY - Do NOT proceed to pattern matching
‚Üí Do NOT justify as "both are metrics"
‚Üí Do NOT justify as "pattern is the same"
‚Üí These are DIFFERENT metric types and CANNOT be substituted

‚ùå DISQUALIFIER 2: Extra Filter TYPES (EXCLUDING DATES!)
- History has ADDITIONAL filter TYPES that current doesn't have
- **IMPORTANT:** When comparing filter types, IGNORE date/time filters entirely (per Rule #2 below)
- Focus only on: product_category, client_id, carrier_id, therapy_class, line_of_business, etc.
- Example:
  * Current: "revenue for PBM" (filter types: product_category)
  * History: "revenue for PBM for client MDOVA" (filter types: product_category + client_id)
  * Compare only non-date filters: History has EXTRA filter type (client_id) ‚Üí REJECT
- Counter-example (ALLOWED):
  * Current: "script count for PBM for July 2025" (filter types: product_category + date)
  * History: "script count for Specialty" (filter types: product_category)
  * Compare only non-date filters: both have product_category ‚Üí PASS ‚úÖ

‚ùå DISQUALIFIER 3: Missing Filter TYPES (EXCLUDING DATES!)
- Current has filter TYPES that history doesn't have
- **IMPORTANT:** When comparing filter types, IGNORE date/time filters entirely
- Example:
  * Current: "revenue for PBM" (has product_category filter)
  * History: "revenue" (NO filters at all)
  * ‚Üí REJECT! History lacks filter structure needed
- Counter-example (ALLOWED):
  * Current: "script count for PBM" (filter types: product_category)
  * History: "script count for Specialty for June 2024" (filter types: product_category + date)
  * Compare only non-date filters: both have product_category ‚Üí PASS ‚úÖ

‚ùå DISQUALIFIER 4: Missing Dimensions
- Current needs GROUP BY that history doesn't have
- Example: History="revenue", Current="revenue by drug" ‚Üí REJECT

‚ùå DISQUALIFIER 5: Extra Dimensions
- History has GROUP BY that current doesn't mention
- Example: History="revenue by month", Current="revenue" ‚Üí REJECT

**IF ANY DISQUALIFIER IS TRIGGERED ‚Üí IMMEDIATELY RETURN NO_MATCH OR SKIP THAT CANDIDATE**

Do NOT proceed to pattern matching if any candidate fails these checks. These are non-negotiable rules.

=== CORE MATCHING PRINCIPLES (Only for candidates that pass all disqualifiers) ===

1. SYNONYMS & VARIATIONS (Treat as identical):
   - "revenue" = "network revenue" = "product revenue" = "network product revenue"
   - "script count" = "volume" = "script volume" = "scripts" = "unadjusted scripts" = "adjusted scripts"
   - "Home Delivery" = "HDP" = "Mail"
   - "Specialty" = "SP"
   - These are THE SAME THING - match them as exact

2. DATES (Completely ignore):
   - "July 2025" vs "August 2024" ‚Üí IGNORE, focus on pattern
   - "Q3 2025" vs "Q2 2024" ‚Üí IGNORE, focus on comparison structure
   - "Jan-Sep 2025" vs "Apr-Jun 2024" ‚Üí IGNORE, focus on date range pattern
   - What MATTERS: Is it a single period? Date range? Period comparison (YoY/QoQ/MoM)?
   - **CRITICAL:** Date filters should NOT be considered in DISQUALIFIER 3 & 4 checks

3. FILTER VALUES (Different values are OK):
   - "Specialty" vs "Home Delivery" ‚Üí SAME PATTERN (product_category filter)
   - "PBM" vs "Specialty" ‚Üí SAME PATTERN (product_category filter)
   - "client MDOVA" vs "client PDIND" ‚Üí SAME PATTERN (client_id filter)
   - "GLP-1" vs "Oncology" ‚Üí SAME PATTERN (therapy_class filter)
   - **KEY POINT**: Different filter VALUES are fine, same filter TYPE is what matters
   - This means PBM and Specialty are INTERCHANGEABLE - both are product_category values

4. EXTRA METRICS IN SELECT (OK):
   - History: "script count, revenue for carrier MPDOVA"
   - Current: "script count for carrier MPDOVA"
   - ‚Üí MATCH! Extra metrics in history are harmless, just ignore them

   - History: "adjusted and unadjusted script count for PBM"
   - Current: "script count for PBM"
   - ‚Üí MATCH! Both adjusted and unadjusted are variants of script count (see Rule #1)

5. EXTRA FILTER TYPES (REJECT - but see DISQUALIFIER 3):
   - **Focus on TYPES of filters, NOT the VALUES within those filters**
   - History has ADDITIONAL filter TYPES that current doesn't have
   - Remember to EXCLUDE date filters from this check

   **Examples of EXTRA FILTER TYPES (REJECT):**
   - Current: "revenue for PBM" (1 filter type: product_category)
   - History: "revenue for PBM for client MDOVA" (2 filter types: product_category + client_id)
   - ‚Üí REJECT! History has EXTRA filter TYPE (client_id)

   **Counter-example - Same Filter Type, Different Value (ALLOWED):**
   - Current: "revenue for PBM" (filter type: product_category)
   - History: "revenue for Specialty" (filter type: product_category)
   - ‚Üí MATCH ‚úÖ! Same filter TYPE, different VALUE is OK per rule #3

6. MISSING FILTER TYPES (REJECT - but see DISQUALIFIER 4):
   - Current has filter TYPES that history doesn't have
   - Remember to EXCLUDE date filters from this check

7. MISSING DIMENSIONS (REJECT):
   - History: "revenue"
   - Current: "revenue by line of business"
   - ‚Üí REJECT! History lacks the GROUP BY structure needed
   - Risk: Won't help with dimensional breakdown

8. EXTRA DIMENSIONS IN HISTORY (REJECT):
   - History: "revenue by month"
   - Current: "revenue"
   - ‚Üí REJECT! History has GROUP BY that current doesn't want
   - Risk: Will confuse LLM to add unwanted grouping

=== DECISION PROCESS ===

**CRITICAL: Apply MANDATORY DISQUALIFIERS first! Only continue if candidates pass ALL disqualifiers.**

STEP 1: Apply ALL MANDATORY DISQUALIFIERS to each candidate
- Check each candidate against ALL 6 disqualifiers listed above
- Eliminate any candidate that fails ANY disqualifier
- **REMEMBER:** When checking DISQUALIFIER 3 & 4, IGNORE date/time filters
- **SPECIAL EMPHASIS**: DISQUALIFIER 2 (Metric Mismatch) is NON-NEGOTIABLE
  * If current asks for "script count" and candidate has "revenue" ‚Üí ELIMINATE immediately
  * If current asks for "revenue" and candidate has "script count" ‚Üí ELIMINATE immediately
  * Do NOT proceed to pattern matching for candidates with metric mismatches

STEP 2: Pattern matching (ONLY for candidates that passed ALL disqualifiers)
Look for BEST match based on:
A. EXACT pattern match (highest priority):
   - Same calculation type (variance, comparison, split, ratio)
   - Same comparison pattern (YoY, QoQ, MoM, vs previous)
   - Same dimensions (by drug_name, by client, etc.)
   - Same structure (side-by-side vs rows)

B. PARTIAL pattern match (if no exact):
   - Same metric and structure
   - Different filter values OK
   - Similar aggregation approach

C. If multiple good matches:
   - Prefer more recent (higher seq_id)
   - Prefer same filter categories
   - Prefer similar complexity

STEP 3: Final validation
Ask: "Will this history help or confuse the LLM?"
- Pattern clearly transferable ‚Üí HELP ‚Üí ACCEPT
- Otherwise ‚Üí REJECT

**IF NO CANDIDATES REMAIN AFTER STEP 1 ‚Üí RETURN NO_MATCH**

=== EXAMPLES ===

Example 0 - METRIC MISMATCH REJECT (MOST IMPORTANT!):
Current: "script count for PBM for September 2025"
Candidates:
- id:1.0 "revenue for PBM"
- id:5.0 "script count for Specialty from Jan-Sep 2025"
- id:9.0 "script count for Home Delivery from Jan-Sep 2025"
Decision: SELECT id:5.0 or id:9.0 ‚úÖ, REJECT id:1.0 ‚ùå
Reason: DISQUALIFIER 2 triggered for id:1.0 - "revenue" and "script count" are DIFFERENT metrics. Even though both are for PBM (same product_category filter), the metric type differs. id:5.0 and id:9.0 have the correct metric (script count) with different filter values (Specialty/Home Delivery vs PBM), which is allowed.

**CRITICAL**: Do NOT select id:1.0 just because it has PBM filter. Metric mismatch is a HARD BLOCKER.

Example 1 - SYNONYM MATCH:
Current: "what is network revenue for PBM"
History: "what is revenue for PBM"
Decision: SELECT ‚úÖ
Reason: "network revenue" = "revenue" (synonym), same table, same filter, exact match

Example 2 - EXTRA METRIC OK:
Current: "script count for carrier MPDOVA"
History: "script count, revenue for carrier MPDOVA"
Decision: SELECT ‚úÖ
Reason: Same entity filter, same dimensions, extra metric (revenue) in history is harmless

Example 3 - EXTRA FILTER TYPE REJECT:
Current: "revenue for PBM"
History: "revenue for PBM for client MDOVA"
Decision: REJECT ‚ùå
Reason: History has EXTRA filter TYPE (client_id) that current doesn't mention. This is different from filter VALUE changes - it's adding a whole new filter dimension.   

Example 4 - MISSING DIMENSION REJECT:
Current: "revenue by line of business"
History: "revenue"
Decision: REJECT ‚ùå
Reason: History lacks GROUP BY dimension that current needs

Example 5 - EXTRA DIMENSION REJECT:
Current: "revenue for carrier MPDOVA"
History: "revenue for carrier MPDOVA by month"
Decision: REJECT ‚ùå
Reason: History has GROUP BY month that current doesn't want

Example 6 - FILTER VALUE CHANGE OK:
Current: "script count for Specialty by drug name Q3 2025"
History: "script count for Home Delivery by drug name Q2 2024"
Decision: SELECT ‚úÖ
Reason: Same pattern (by drug_name, single quarter), same filter TYPES (product_category + date), different filter VALUES are fine (Specialty vs Home Delivery)

Example 7 - PATTERN MATCH:
Current: "volume and revenue for GLP-1 by drug name Q3 2025 vs Q3 2024"
History: "volume and revenue for Oncology by drug name Q2 2025 vs Q2 2024"
Decision: SELECT ‚úÖ
Reason: Exact same structure (YoY comparison, by drug_name, volume+revenue), only filter values differ (GLP-1 vs Oncology)

Example 8 - NO MATCH:
Current: "top 10 clients with highest variance"
Candidates:
- "revenue by client"
- "variance by therapy class"
Decision: NO_MATCH ‚ùå
Reason: First lacks variance logic and top N, second lacks client dimension

Example 9 - FILTER VALUE CHANGE (ALLOWED):
Current: "script count for PBM for July 2025"
History: "script count for Specialty from Jan-Sep 2025"
Decision: SELECT ‚úÖ
Reason: Same metric (script count), same filter TYPES (product_category + date), different filter VALUES (PBM vs Specialty, July vs Jan-Sep). Pattern matches perfectly - LLM will substitute values.

Example 10 - FILTER VALUE CHANGE (ALLOWED):
Current: "revenue for Home Delivery"
History: "revenue for PBM"
Decision: SELECT ‚úÖ
Reason: Same metric, same filter TYPE (product_category), just different value. This is exactly what rule #3 allows. PBM and Home Delivery are both product_category values.

Example 11 - MISSING FILTER TYPE (REJECT):
Current: "script count for PBM"
History: "script count"
Decision: REJECT ‚ùå
Reason: Current has product_category filter but history has NO filters. History lacks the filter structure needed.

Example 12 - FILTER VALUE CHANGE WITH MULTIPLE FILTERS (ALLOWED):
Current: "revenue for PBM for client MDOVA"
History: "revenue for Specialty for client PDIND"
Decision: SELECT ‚úÖ
Reason: Same filter TYPES (product_category + client_id), different VALUES for both filters. This is allowed per rule #3.

Example 13 - ALL CANDIDATES FAIL METRIC CHECK (NO_MATCH):
Current: "script count for PBM"
Candidates (all from same table):
- id:1.0 "revenue for PBM"
- id:2.0 "actuals vs forecast for PBM"
- id:3.0 "cost for PBM"
Decision: NO_MATCH ‚ùå
Reason: All candidates fail DISQUALIFIER 2 (Metric Mismatch). Current asks for "script count", but all candidates have different metrics (revenue, actuals vs forecast, cost). Even though they all have PBM filter (same product_category), none have the matching metric. Must return NO_MATCH.

**CRITICAL RULE**: Same filter values (PBM) do NOT override metric mismatches. Metric compatibility is a HARD requirement.

Example 14 - DATE FILTER IGNORED IN TYPE COMPARISON (ALLOWED):
Current: "script count for PBM for July 2025"
History: "script count for Specialty"
Decision: SELECT ‚úÖ
Reason: When comparing filter TYPES (DISQUALIFIER 3 & 4), we IGNORE date filters. Both have product_category filter (different values: PBM vs Specialty). Date in current is ignored per Rule #2. Same metric, same non-date filter types, different filter values ‚Üí MATCH!

Example 15 - ADJUSTED/UNADJUSTED SYNONYM (ALLOWED):
Current: "script count for PBM"
History: "adjusted and unadjusted script count for Home Delivery"
Decision: SELECT ‚úÖ
Reason: "adjusted script count" and "unadjusted script count" are both variants of "script count" (Rule #1). History has both variants which is OK (Rule #4 - extra metrics). Different filter value (PBM vs Home Delivery) is allowed. Same metric type, same filter type, different values ‚Üí MATCH!

=== OUTPUT FORMAT ===

**CRITICAL METRIC MATCHING RULE (REMINDER):**
- If current asks for metric X and history has metric Y, where X ‚â† Y (not synonyms):
  ‚Üí Return "status": "no_match"
  ‚Üí In reasoning, state: "Metric mismatch: current asks for [X], history has [Y]. These are different metrics."
  ‚Üí Do NOT select that candidate
  ‚Üí Do NOT justify metric mismatches as "both are core metrics" or "pattern is the same"

**Examples:**
- Current asks for "script count", history has "revenue" ‚Üí NO_MATCH (different metrics)
- Current asks for "revenue", history has "network revenue" ‚Üí MATCH (synonyms)
- Current asks for "script count", history has "volume" ‚Üí MATCH (synonyms)
- Current asks for "script count", history has "adjusted script count" ‚Üí MATCH (synonyms)

CRITICAL: Return ONLY the JSON wrapped in <json> tags. NO explanatory text, NO reasoning before the JSON, NO analysis.

Do NOT write anything like "Let me analyze..." or "STEP 1:..." or any other text before the JSON.

Start your response IMMEDIATELY with <json> and end with </json>. Nothing else.

<json>
{
  "status": "match_found" or "no_match",
  "selected_seq_id": <number> or null,
  "matched_question": "<exact question text>" or null,
  "table_name": "<table name>" or null,
  "reasoning": "<detailed explanation of why selected or why NO_MATCH>",
  "pattern_match_level": "EXACT" or "PARTIAL" or "NONE"
}
</json>

Remember: Start with <json>, end with </json>, nothing else. No preamble, no analysis text, no explanations outside the JSON.


=== HISTORICAL QUESTIONS (GROUPED BY TABLE) ===

- table_name: prd_optumrx_orxfdmprdsa.rag.ledger_actual_vs_forecast
  id:9.0, what is the script counts (unadjusted, volume),revenue, adjusted script count, revenue per script (rate), revenue per adjusted script count for divvyDOSE, CPS Solutions, Infusion, Community Core, PharmScript, Specialty Core, Frontier, HDP Core in september 2025
  id:10.0, what is the script counts (unadjusted, volume),revenue, adjusted script count, revenue per script (rate), revenue per adjusted script count for divvyDOSE, CPS Solutions, Infusion, Community Core, PharmScript, Specialty Core, Frontier, HDP Core september 2025 vs september 2024
  id:3.0, what is the PBM revenue by month jan-sep 2025 or what is the network product revenue from jan-sep 2025 for PBM
  id:13.0, what is the revenue for each line of business from jan to sept 2025 for PBM
  id:11.0, what is the script counts (unadjusted, volume),revenue, adjusted script count, revenue per script (rate), revenue per adjusted script count for divvyDOSE, CPS Solutions, Infusion, Community Core, PharmScript, Specialty Core, Frontier, HDP Core from jan to feb 2025
  id:15.0, what is the script counts (unadjusted, volume),revenue, adjusted script count, revenue per script (rate), revenue per adjusted script count for Admin Fees, Emisar GPO, Retail Other, Retail, Mfr Discount, Workers Comp, Prior Auth september 2025 vs september 2024
  id:5.0, what is the script counts (unadjusted, volume) trends, adjusted script count, revenue per script (rate), revenue per adjusted script count trends for Specialty from jan to march 2025
  id:6.0, what is the script counts (unadjusted, volume), adjusted script count, revenue per script (rate), revenue per adjusted script count for Specialty in september 2025
  id:12.0, what is the network product revenue or revenue for each line of business for July 2025
  id:7.0, compare script counts (unadjusted, volume), adjusted script count, revenue per script (rate), revenue per adjusted script count for Specialty Q3 2025 vs Q3 2024
  id:14.0, compare revenue for each line of business Q3 2025 vs Q3 2024
  id:8.0, show me IOI-LOB report or IOI - line of business report to compare actuals vs forecast 8+4 for PBM month over month september vs august 2025
  id:2.0, what is the actuals vs forecast 8+4 or actuals vs 5+7 for July 2025 for PBM
  id:1.0, what is the network product revenue or network revenue or revenue for PBM?
  id:4.0, compare PBM revenue or PBM network revenue or Network product revenue for Q3 2025 VS q3 2024
  id:16.0, what is the script counts (unadjusted, volume),revenue, adjusted script count, revenue per script (rate), revenue per adjusted script count for Admin Fees, Emisar GPO, Retail Other, Retail, Mfr Discount, Workers Comp, Prior Auth from jan to feb 2025


=== CURRENT QUESTION (TEXT PATTERN TO MATCH) ===
What is the volume for HDP Core for January to September 2025

‚ö†Ô∏è REMINDER: You are NOT answering this question. You are ONLY checking if its pattern matches any historical question pattern above.

Return ONLY the JSON in <json> tags. Start immediately with <json>.

üîÑ Router status update: Generating SQL (T+4s)
üîÑ Router status update: Executing SQL (T+6s)
Raw LLM response: <json>
{
  "status": "match_found",
  "selected_seq_id": 5.0,
  "matched_question": "what is the script counts (unadjusted, volume) trends, adjusted script count, revenue per script (rate), revenue per adjusted script count trends for Specialty from jan to march 2025",
  "table_name": "prd_optumrx_orxfdmprdsa.rag.ledger_actual_vs_forecast",
  "reasoning": "Current asks for 'volume for HDP Core for January to September 2025'. History id:5.0 asks for 'script counts (unadjusted, volume) trends... for Specialty from jan to march 2025'. Key matches: 1) 'volume' = 'script counts (unadjusted, volume)' (synonyms per Rule #1), 2) Same filter type (product_category), different values (HDP Core vs Specialty) which is allowed per Rule #3, 3) Same date range pattern (multi-month period), different specific months ignored per Rule #2, 4) Extra metrics in history (adjusted script count, revenue per script, etc.) are harmless per Rule #4. Pattern transfers perfectly - LLM can substitute HDP Core for Specialty and Jan-Sep for Jan-Mar.",
  "pattern_match_level": "EXACT"
}
</json>
