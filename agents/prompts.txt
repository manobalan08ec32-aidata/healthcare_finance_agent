UPDATE prd_optumrx_orxfdmprdsa.rag.fdmbotsession_tracking_updt
SET selected_dataset = ARRAY_JOIN(
    FILTER(
        ARRAY(
            CASE WHEN sql_info LIKE '%prd_optumrx_orxfdmprdsa.rag.ledger_actual_vs_forecast%' 
                THEN 'Peoplesoft GL' ELSE NULL END,
            CASE WHEN sql_info LIKE '%prd_optumrx_orxfdmprdsa.rag.pbm_claims%' 
                THEN 'Rx Claims' ELSE NULL END,
            CASE WHEN sql_info LIKE '%prd_optumrx_orxfdmprdsa.rag.claim_billing%' 
                THEN 'CBS Billing' ELSE NULL END,
            CASE WHEN sql_info LIKE '%prd_optumrx_orxfdmprdsa.rag.pharmacy_claims%' 
                THEN 'Pharmacy IRIS Claims' ELSE NULL END
        ),
        x -> x IS NOT NULL
    ),
    ', '
)
WHERE selected_dataset IS NULL 
    AND sql_info IS NOT NULL;


UPDATE prd_optumrx_orxfdmprdsa.rag.fdmbotsession_tracking_updt
SET selected_dataset = TRIM(BOTH ', ' FROM 
    CONCAT_WS(', ',
        CASE WHEN sql_info LIKE '%prd_optumrx_orxfdmprdsa.rag.ledger_actual_vs_forecast%' 
            THEN 'Peoplesoft GL' END,
        CASE WHEN sql_info LIKE '%prd_optumrx_orxfdmprdsa.rag.pbm_claims%' 
            THEN 'Rx Claims' END,
        CASE WHEN sql_info LIKE '%prd_optumrx_orxfdmprdsa.rag.claim_billing%' 
            THEN 'CBS Billing' END,
        CASE WHEN sql_info LIKE '%prd_optumrx_orxfdmprdsa.rag.pharmacy_claims%' 
            THEN 'Pharmacy IRIS Claims' END
    )
)
WHERE selected_dataset IS NULL 
    AND sql_info IS NOT NULL;


SELECT 
    session_id,
    user_question,
    selected_dataset as current_value,
    TRIM(BOTH ', ' FROM 
        CONCAT_WS(', ',
            CASE WHEN sql_info LIKE '%prd_optumrx_orxfdmprdsa.rag.ledger_actual_vs_forecast%' 
                THEN 'Peoplesoft GL' END,
            CASE WHEN sql_info LIKE '%prd_optumrx_orxfdmprdsa.rag.pbm_claims%' 
                THEN 'Rx Claims' END,
            CASE WHEN sql_info LIKE '%prd_optumrx_orxfdmprdsa.rag.claim_billing%' 
                THEN 'CBS Billing' END,
            CASE WHEN sql_info LIKE '%prd_optumrx_orxfdmprdsa.rag.pharmacy_claims%' 
                THEN 'Pharmacy IRIS Claims' END
        )
    ) as new_value
FROM prd_optumrx_orxfdmprdsa.rag.fdmbotsession_tracking_updt
WHERE selected_dataset IS NULL 
    AND sql_info IS NOT NULL
LIMIT 20;
