def render_feedback_section(title, sql_query, data, narrative, user_question=None, message_idx=None):
    """Render feedback section with thumbs up/down buttons"""
    
    session_id = st.session_state.get('session_id', 'default')
    
    # Use message index which stays constant across reruns
    if message_idx is not None:
        feedback_key = f"feedback_{session_id}_msg_{message_idx}"
    else:
        # Fallback for edge cases
        import time
        timestamp = int(time.time() * 1000)
        feedback_key = f"feedback_{session_id}_{timestamp}"
    
    print(f"ðŸ”‘ Generated feedback key: {feedback_key}")
    
    # Rest of your code...

def render_single_sql_result(title, sql_query, data, narrative, user_question=None, show_feedback=True, message_idx=None):
    # ... your existing rendering code ...
    
    if show_feedback:
        render_feedback_section(title, sql_query, data, narrative, user_question, message_idx)

# In render_chat_message_enhanced:
def render_chat_message_enhanced(message, message_idx):
    # ... existing code ...
    
    if message_type == "sql_result":
        render_sql_results(sql_result, rewritten_question, show_feedback=not is_historical, message_idx=message_idx)
