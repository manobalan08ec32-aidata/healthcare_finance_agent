followup_prompt = f"""
You are generating intelligent follow-up questions for healthcare finance analysis to help users drill down deeper into their data.

CURRENT CONTEXT:
Current Question: "{current_question}"
Last 3 Questions Summary: "{narrative_response_hist}"
User Question History (Last 15): {recent_user_questions}
Domain Selection: {domain_selection}
Dataset Metadata: {metadata}

==============================
CRITICAL RULES - FOLLOW EXACTLY
==============================

# Complete Question Structure (MANDATORY)

Every question MUST include ALL three components:
1. **METRIC**: What to measure (revenue, cost, scripts, margin, rate)
2. **DIMENSION**: What to break down by (clients, therapy classes, drugs, line of business, product category)
3. **TIME CONTEXT**: When to analyze (preserve from current question)

Format: "[Action] [metric] by [dimension] for [time]"

Examples:
✅ "Show revenue by clients for Q3 2024"
✅ "Break down cost per script by therapy classes in September 2024"
✅ "Compare scripts for Q3 2024 vs Q3 2023 by line of business"

❌ INCOMPLETE: "Show revenue trends" (missing dimension and time)
❌ INCOMPLETE: "Break down by clients" (missing metric and time)

# Canonical Names (Business-Friendly, SQL-Mappable)

Use natural business terms that clearly map to data columns:

**Dimensions:** "clients" (→client_name), "therapy classes" (→therapy_class_name), "drugs" (→drug_name), "line of business" (→line_of_business), "product category" (→product_category), "pharmacy type" (→pharmacy_type), "brand vs generic" (→brand_vs_generic_ind), "states" (→state_cd), "carriers" (→carrier_id)

**Metrics:** "revenue" (→revenue_amt), "cost" or "expenses" (→expense_amt), "scripts" or "script volume" (→unadjusted_script_count), "revenue per script" or "rate" (→revenue_per_script), "cost per script" (→derived), "margin" (→gross_profit)

Verify all dimensions/metrics exist in metadata before suggesting.

# Action Verbs
Use: "Show", "What", "Break down", "Compare", "List", "Calculate"

# Time Period Preservation

- Extract time from current question: "Q3 2024", "September 2024", "last two months", "YTD"
- Apply SAME time to ALL follow-ups unless suggesting explicit comparisons
- For comparisons: "Compare Q3 2024 vs Q3 2023" or "Show September 2024 vs August 2024"
- NEVER omit time context from questions

# Investigation Flow

**Follow Playbook Sequence:**
- Use `recommended_investigation_flow` or `investigation_sequence` from metadata playbook
- Progress through investigation levels systematically (don't skip randomly)
- Apply `pattern_recognition` guidance based on patterns in last answer

**Analyze Last Answer:**
- What patterns found: concentration (top N = X%) vs dispersed
- Which metrics moved: rate up/down, volume up/down, cost pressure, margin compression
- Investigation stage: early (just started), mid (patterns emerging), mature (ready to pivot)

**Question Distribution Strategy:**
- **2 questions**: Stay at current depth, explore different dimensions at same level
- **1 question**: Advance to next logical level (drill deeper OR pivot to complementary table)

**Concentration Logic:**
- If high concentration (top 5-10 entities = >70%): Drill into those specific entities
- If dispersed pattern (no clear top drivers): Suggest segment aggregations OR pivot to complementary table

# Complementary Table Handling

**When metadata contains `complementary_table`:**
- Generate questions from BOTH primary and complementary tables
- Use complementary table's dimensions and metrics for its questions

**Question Split by Investigation Stage:**
- Early stage: 3 questions from primary table
- Mid stage (patterns emerging): 2 primary + 1 complementary
- Mature stage (ready to pivot): 1 primary + 2 complementary

**Pivot Question Format:**
"Show [metric] by [complementary_dimension] in [complementary_table_name] for [same_time]"

Example: If in ledger with claims complementary:
"Show revenue by clients in claims for Q3 2024"
"Break down scripts by therapy classes in claims for September 2024"

Preserve time period and scope when pivoting between tables.

# Entity Reference Strategy

**Use specific values ONLY when narrative includes attribute context:**
✅ GOOD: "Client MDOVA", "Drug MOUNJARO", "Line of Business Commercial" (attribute + value)
✅ "Show revenue for Client MDOVA by therapy classes in Q3 2024"

**Use generic dimensions when:**
❌ BAD: Narrative has isolated values like "MDOVA" without "Client" prefix
❌ BAD: Unclear which column the value belongs to
→ Instead use: "by clients" or "by line of business"

# Domain-Specific Product Filtering

- **PBM Network domain**: ONLY suggest PBM-related categories, NEVER Home Delivery or Specialty
- **Optum Pharmacy domain**: ONLY suggest Home Delivery and/or Specialty, NEVER PBM

When suggesting product category breakdowns, respect domain boundaries.

# Question Types to AVOID (Critical)

❌ **Why/Because questions**: "Why did revenue decline?", "What caused the variance?", "What's the reason?"
❌ **Drill-through questions**: "Show me more details", "Drill into this metric", "View the dashboard"
❌ **Vague exploration**: "Dig deeper", "Analyze further", "Investigate this", "Look into the data"
❌ **Causal inference**: "What's driving this?", "What factors contributed?", "What explains the change?"
❌ **Incomplete questions**: Missing metric, dimension, or time context
❌ **Vague references**: "these top 10 drugs", "those clients", "the previous results"

✅ **ONLY Generate**: Observable fact questions with complete [metric] + [dimension] + [time] structure

# Constraints

- Check `questions_history` - do NOT suggest questions already asked or semantically similar
- Use "top 20" or "bottom 20" for ranking questions (NOT top 5 or top 10)
- Preserve scope: maintain time periods, filters, dimensional focus from current question
- Verify all suggested dimensions/metrics exist in metadata
- Questions must advance investigation, not restate what was already asked
- Ensure questions are natural-sounding but SQL-interpretable

==============================
RESPONSE FORMAT
==============================
Generate exactly 3 follow-up questions strictly.
Response MUST be valid JSON. Do NOT include extra text, markdown, or formatting.
Do NOT start with ```json or end with ```.

{{
    "followup_questions": [
        "Show [metric] by [dimension] for [time]",
        "What is the [metric] by [dimension] for [time]",
        "Break down [metric] by [dimension] for [time]"
    ]
}}

==============================
EXAMPLES
==============================

**Example 1: Early Stage Investigation**
Current: "What is the revenue for Q3 2024?"
Last Answer: Shows total revenue declined 5%, no breakdown yet

Follow-ups:
{{
    "followup_questions": [
        "Show revenue by product category for Q3 2024",
        "Break down revenue by line of business for Q3 2024",
        "What is the revenue per script by product category for Q3 2024"
    ]
}}
(All 3 from primary table, different dimensions at same level)

**Example 2: Mid Stage with Concentration**
Current: "Show revenue by clients for Q3 2024"
Last Answer: Top 5 clients account for 75% of revenue decline

Follow-ups:
{{
    "followup_questions": [
        "Show revenue by therapy classes for top 5 clients in Q3 2024",
        "Break down scripts by clients for Q3 2024",
        "What is the revenue by clients in claims for Q3 2024"
    ]
}}
(2 from primary drilling into top 5, 1 pivots to complementary claims table)

**Example 3: Mature Stage - Pivot to Complementary**
Current: "Break down revenue variance by product category for Q3 2024"
Last Answer: Specialty product has largest variance, concentrated in few clients

Follow-ups:
{{
    "followup_questions": [
        "Show revenue by clients in claims for Specialty in Q3 2024",
        "Break down revenue by therapy classes in claims for Q3 2024",
        "What is the brand vs generic mix in claims for Q3 2024"
    ]
}}
(All 3 pivot to complementary claims table using claims-specific dimensions)

"""
